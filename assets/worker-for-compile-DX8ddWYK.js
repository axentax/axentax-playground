(function(){"use strict";/*!
 * Axentax.js v1.0.0
 * Copyright (c) 2024 Mitsuru Yasuda
 * GPL-3.0 License
 *
 * use:
 * - tonaljs { chord, midi } - https://github.com/tonaljs/tonal
 * - decimal.js - https://github.com/MikeMcl/decimal.js
 */var Bi=Object.defineProperty,Ei=(e,t,i)=>t in e?Bi(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,z=(e,t,i)=>Ei(e,typeof t!="symbol"?t+"":t,i);function H(e){var t,i,n,o=e.length-1,r="",a=e[0];if(o>0){for(r+=a,t=1;o>t;t++)(i=W-(n=e[t]+"").length)&&(r+=ke(i)),r+=n;(i=W-(n=(a=e[t])+"").length)&&(r+=ke(i))}else if(a===0)return"0";for(;a%10==0;)a/=10;return r+a}function ee(e,t,i){if(e!==~~e||t>e||e>i)throw Error(he+e)}function We(e,t,i,n){var o,r,a,s;for(r=e[0];r>=10;r/=10)--t;return 0>--t?(t+=W,o=0):(o=Math.ceil((t+1)/W),t%=W),r=J(10,W-t),s=e[o]%r|0,n==null?3>t?(t==0?s=s/100|0:t==1&&(s=s/10|0),a=4>i&&s==99999||i>3&&s==49999||s==5e4||s==0):a=(4>i&&s+1==r||i>3&&s+1==r/2)&&(e[o+1]/r/100|0)==J(10,t-2)-1||(s==r/2||s==0)&&!(e[o+1]/r/100|0):4>t?(t==0?s=s/1e3|0:t==1?s=s/100|0:t==2&&(s=s/10|0),a=(n||4>i)&&s==9999||!n&&i>3&&s==4999):a=((n||4>i)&&s+1==r||!n&&i>3&&s+1==r/2)&&(e[o+1]/r/1e3|0)==J(10,t-3)-1,a}function it(e,t,i){for(var n,o,r=[0],a=0,s=e.length;s>a;){for(o=r.length;o--;)r[o]*=t;for(r[0]+=ft.indexOf(e.charAt(a++)),n=0;r.length>n;n++)r[n]>i-1&&(r[n+1]===void 0&&(r[n+1]=0),r[n+1]+=r[n]/i|0,r[n]%=i)}return r.reverse()}function D(e,t,i,n){var o,r,a,s,c,u,l,f,d,m=e.constructor;e:if(t!=null){if(!(f=e.d))return e;for(o=1,s=f[0];s>=10;s/=10)o++;if(0>(r=t-o))r+=W,c=(l=f[d=0])/J(10,o-(a=t)-1)%10|0;else if((s=f.length)>(d=Math.ceil((r+1)/W))){for(l=s=f[d],o=1;s>=10;s/=10)o++;c=0>(a=(r%=W)-W+o)?0:l/J(10,o-a-1)%10|0}else{if(!n)break e;for(;s++<=d;)f.push(0);l=c=0,o=1,a=(r%=W)-W+1}if(n=n||0>t||f[d+1]!==void 0||(0>a?l:l%J(10,o-a-1)),u=4>i?(c||n)&&(i==0||i==(0>e.s?3:2)):c>5||c==5&&(i==4||n||i==6&&(r>0?a>0?l/J(10,o-a):0:f[d-1])%10&1||i==(0>e.s?8:7)),1>t||!f[0])return f.length=0,u?(f[0]=J(10,(W-(t-=e.e+1)%W)%W),e.e=-t||0):f[0]=e.e=0,e;if(r==0?(f.length=d,s=1,d--):(f.length=d+1,s=J(10,W-r),f[d]=a>0?(l/J(10,o-a)%J(10,a)|0)*s:0),u)for(;;){if(d==0){for(r=1,a=f[0];a>=10;a/=10)r++;for(a=f[0]+=s,s=1;a>=10;a/=10)s++;r!=s&&(e.e++,f[0]==re&&(f[0]=1));break}if(f[d]+=s,f[d]!=re)break;f[d--]=0,s=1}for(r=f.length;f[--r]===0;)f.pop()}return _&&(e.e>m.maxE?(e.d=null,e.e=NaN):m.minE>e.e&&(e.e=0,e.d=[0])),e}function ce(e,t,i){if(!e.isFinite())return fn(e);var n,o=e.e,r=H(e.d),a=r.length;return t?(i&&(n=i-a)>0?r=r.charAt(0)+"."+r.slice(1)+ke(n):a>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(0>e.e?"e":"e+")+e.e):0>o?(r="0."+ke(-o-1)+r,i&&(n=i-a)>0&&(r+=ke(n))):a>o?((n=o+1)<a&&(r=r.slice(0,n)+"."+r.slice(n)),i&&(n=i-a)>0&&(o+1===a&&(r+="."),r+=ke(n))):(r+=ke(o+1-a),i&&(n=i-o-1)>0&&(r=r+"."+ke(n))),r}function rt(e,t){var i=e[0];for(t*=W;i>=10;i/=10)t++;return t}function ot(e,t,i){if(t>Hn)throw _=1,i&&(e.precision=i),Error(Dt);return D(new e(mt),t,1,1)}function ae(e,t,i){if(t>yt)throw Error(Dt);return D(new e(pt),t,i,1)}function cn(e){var t=e.length-1,i=t*W+1;if(t=e[t]){for(;t%10==0;t/=10)i--;for(t=e[0];t>=10;t/=10)i++}return i}function ke(e){for(var t="";e--;)t+="0";return t}function ln(e,t,i,n){var o,r=new e(1),a=Math.ceil(n/W+4);for(_=0;;){if(i%2&&pn((r=r.times(t)).d,a)&&(o=1),(i=Z(i/2))===0){i=r.d.length-1,o&&r.d[i]===0&&++r.d[i];break}pn((t=t.times(t)).d,a)}return _=1,r}function un(e){return 1&e.d[e.d.length-1]}function dn(e,t,i){for(var n,o=new e(t[0]),r=0;++r<t.length;){if(!(n=new e(t[r])).s){o=n;break}o[i](n)&&(o=n)}return o}function It(e,t){var i,n,o,r,a,s,c,u=0,l=0,f=0,d=e.constructor,m=d.rounding,h=d.precision;if(!e.d||!e.d[0]||e.e>17)return new d(e.d?e.d[0]?0>e.s?0:1/0:1:e.s?0>e.s?0:e:NaN);for(t==null?(_=0,c=h):c=t,s=new d(.03125);e.e>-2;)e=e.times(s),f+=5;for(c+=n=Math.log(J(2,f))/Math.LN10*2+5|0,i=r=a=new d(1),d.precision=c;;){if(r=D(r.times(e),c,1),i=i.times(++l),H((s=a.plus(q(r,i,c,1))).d).slice(0,c)===H(a.d).slice(0,c)){for(o=f;o--;)a=D(a.times(a),c,1);if(t!=null)return d.precision=h,a;if(u>=3||!We(a.d,c-n,m,u))return D(a,d.precision=h,m,_=1);d.precision=c+=10,i=r=s=new d(1),l=0,u++}a=s}}function ve(e,t){var i,n,o,r,a,s,c,u,l,f,d,m=1,h=e,p=h.d,g=h.constructor,y=g.rounding,b=g.precision;if(0>h.s||!p||!p[0]||!h.e&&p[0]==1&&p.length==1)return new g(p&&!p[0]?-1/0:h.s!=1?NaN:p?0:h);if(t==null?(_=0,l=b):l=t,g.precision=l+=10,n=(i=H(p)).charAt(0),Math.abs(r=h.e)>=15e14)return u=ot(g,l+2,b).times(r+""),h=ve(new g(n+"."+i.slice(1)),l-10).plus(u),g.precision=b,t==null?D(h,b,y,_=1):h;for(;7>n&&n!=1||n==1&&i.charAt(1)>3;)n=(i=H((h=h.times(e)).d)).charAt(0),m++;for(r=h.e,n>1?(h=new g("0."+i),r++):h=new g(n+"."+i.slice(1)),f=h,c=a=h=q(h.minus(1),h.plus(1),l,1),d=D(h.times(h),l,1),o=3;;){if(a=D(a.times(d),l,1),H((u=c.plus(q(a,new g(o),l,1))).d).slice(0,l)===H(c.d).slice(0,l)){if(c=c.times(2),r!==0&&(c=c.plus(ot(g,l+2,b).times(r+""))),c=q(c,new g(m),l,1),t!=null)return g.precision=b,c;if(!We(c.d,l-10,y,s))return D(c,g.precision=b,y,_=1);g.precision=l+=10,u=a=h=q(f.minus(1),f.plus(1),l,1),d=D(h.times(h),l,1),o=s=1}c=u,o+=2}}function fn(e){return e.s*e.s/0+""}function Nt(e,t){var i,n,o;for((i=t.indexOf("."))>-1&&(t=t.replace(".","")),(n=t.search(/e/i))>0?(0>i&&(i=n),i+=+t.slice(n+1),t=t.substring(0,n)):0>i&&(i=t.length),n=0;t.charCodeAt(n)===48;n++);for(o=t.length;t.charCodeAt(o-1)===48;--o);if(t=t.slice(n,o)){if(o-=n,e.e=i=i-n-1,e.d=[],n=(i+1)%W,0>i&&(n+=W),o>n){for(n&&e.d.push(+t.slice(0,n)),o-=W;o>n;)e.d.push(+t.slice(n,n+=W));t=t.slice(n),n=W-t.length}else n-=o;for(;n--;)t+="0";e.d.push(+t),_&&(e.e>e.constructor.maxE?(e.d=null,e.e=NaN):e.constructor.minE>e.e&&(e.e=0,e.d=[0]))}else e.e=0,e.d=[0];return e}function Fi(e,t){var i,n,o,r,a,s,c,u,l;if(t.indexOf("_")>-1){if(t=t.replace(/(\d)_(?=\d)/g,"$1"),Wt.test(t))return Nt(e,t)}else if(t==="Infinity"||t==="NaN")return+t||(e.s=NaN),e.e=NaN,e.d=null,e;if(Jn.test(t))i=16,t=t.toLowerCase();else if(Kn.test(t))i=2;else{if(!zn.test(t))throw Error(he+t);i=8}for((r=t.search(/p/i))>0?(c=+t.slice(r+1),t=t.substring(2,r)):t=t.slice(2),r=t.indexOf("."),n=e.constructor,(a=r>=0)&&(r=(s=(t=t.replace(".","")).length)-r,o=ln(n,new n(i),r,2*r)),r=l=(u=it(t,i,re)).length-1;u[r]===0;--r)u.pop();return 0>r?new n(0*e.s):(e.e=rt(u,l),e.d=u,_=0,a&&(e=q(e,o,4*s)),c&&(e=e.times(54>Math.abs(c)?J(2,c):te.pow(2,c))),_=1,e)}function Ce(e,t,i,n,o){var r,a,s,c,u=e.precision,l=Math.ceil(u/W);for(_=0,c=i.times(i),s=new e(n);;){if(a=q(s.times(c),new e(t++*t++),u,1),s=o?n.plus(a):n.minus(a),n=q(a.times(c),new e(t++*t++),u,1),(a=s.plus(n)).d[l]!==void 0){for(r=l;a.d[r]===s.d[r]&&r--;);if(r==-1)break}r=s,s=n,n=a,a=r}return _=1,a.d.length=l+1,a}function st(e,t){for(var i=e;--t;)i*=e;return i}function mn(e,t){var i,n=0>t.s,o=ae(e,e.precision,1),r=o.times(.5);if((t=t.abs()).lte(r))return pe=n?4:1,t;if((i=t.divToInt(o)).isZero())pe=n?3:2;else{if((t=t.minus(i.times(o))).lte(r))return pe=un(i)?n?2:3:n?4:1,t;pe=un(i)?n?1:4:n?3:2}return t.minus(o).abs()}function Ot(e,t,i,n){var o,r,a,s,c,u,l,f,d,m=e.constructor,h=i!==void 0;if(h?(ee(i,1,me),n===void 0?n=m.rounding:ee(n,0,8)):(i=m.precision,n=m.rounding),e.isFinite()){for(h?(o=2,t==16?i=4*i-3:t==8&&(i=3*i-2)):o=t,0>(a=(l=ce(e)).indexOf("."))||(l=l.replace(".",""),(d=new m(1)).e=l.length-a,d.d=it(ce(d),10,o),d.e=d.d.length),r=c=(f=it(l,10,o)).length;f[--c]==0;)f.pop();if(f[0]){if(0>a?r--:((e=new m(e)).d=f,e.e=r,f=(e=q(e,d,i,n,0,o)).d,r=e.e,u=qn),a=f[i],s=o/2,u=u||f[i+1]!==void 0,u=4>n?(a!==void 0||u)&&(n===0||n===(0>e.s?3:2)):a>s||a===s&&(n===4||u||n===6&&1&f[i-1]||n===(0>e.s?8:7)),f.length=i,u)for(;++f[--i]>o-1;)f[i]=0,i||(++r,f.unshift(1));for(c=f.length;!f[c-1];--c);for(a=0,l="";c>a;a++)l+=ft.charAt(f[a]);if(h){if(c>1)if(t==16||t==8){for(a=t==16?4:3,--c;c%a;c++)l+="0";for(c=(f=it(l,o,t)).length;!f[c-1];--c);for(a=1,l="1.";c>a;a++)l+=ft.charAt(f[a])}else l=l.charAt(0)+"."+l.slice(1);l=l+(0>r?"p":"p+")+r}else if(0>r){for(;++r;)l="0"+l;l="0."+l}else if(++r>c)for(r-=c;r--;)l+="0";else c>r&&(l=l.slice(0,r)+"."+l.slice(r))}else l=h?"0p+0":"0";l=(t==16?"0x":t==2?"0b":t==8?"0o":"")+l}else l=fn(e);return 0>e.s?"-"+l:l}function pn(e,t){if(e.length>t)return e.length=t,1}function Ui(e){return new this(e).abs()}function ji(e){return new this(e).acos()}function Di(e){return new this(e).acosh()}function Ri(e,t){return new this(e).plus(t)}function Wi(e){return new this(e).asin()}function _i(e){return new this(e).asinh()}function Gi(e){return new this(e).atan()}function qi(e){return new this(e).atanh()}function Vi(e,t){e=new this(e),t=new this(t);var i,n=this.precision,o=this.rounding,r=n+4;return e.s&&t.s?e.d||t.d?!t.d||e.isZero()?(i=0>t.s?ae(this,n,o):new this(0)).s=e.s:!e.d||t.isZero()?(i=ae(this,r,1).times(.5)).s=e.s:0>t.s?(this.precision=r,this.rounding=1,i=this.atan(q(e,t,r,1)),t=ae(this,r,1),this.precision=n,this.rounding=o,i=0>e.s?i.minus(t):i.plus(t)):i=this.atan(q(e,t,r,1)):(i=ae(this,r,1).times(t.s>0?.25:.75)).s=e.s:i=new this(NaN),i}function Ki(e){return new this(e).cbrt()}function Ji(e){return D(e=new this(e),e.e+1,2)}function zi(e,t,i){return new this(e).clamp(t,i)}function Hi(e){if(!e||typeof e!="object")throw Error(gt+"Object expected");var t,i,n,o=e.defaults==1,r=["precision",1,me,"rounding",0,8,"toExpNeg",-Le,0,"toExpPos",0,Le,"maxE",0,Le,"minE",-Le,0,"modulo",0,9];for(t=0;r.length>t;t+=3)if(i=r[t],o&&(this[i]=ht[i]),(n=e[i])!==void 0){if(Z(n)!==n||r[t+1]>n||n>r[t+2])throw Error(he+i+": "+n);this[i]=n}if(i="crypto",o&&(this[i]=ht[i]),(n=e[i])!==void 0){if(n!=1&&n!=0&&n!==0&&n!==1)throw Error(he+i+": "+n);if(n){if(typeof crypto>"u"||!crypto||!crypto.getRandomValues&&!crypto.randomBytes)throw Error(Rt);this[i]=1}else this[i]=0}return this}function Zi(e){return new this(e).cos()}function Xi(e){return new this(e).cosh()}function Yi(e,t){return new this(e).div(t)}function Qi(e){return new this(e).exp()}function er(e){return D(e=new this(e),e.e+1,3)}function tr(){var e,t,i=new this(0);for(_=0,e=0;arguments.length>e;)if((t=new this(arguments[e++])).d)i.d&&(i=i.plus(t.times(t)));else{if(t.s)return _=1,new this(1/0);i=t}return _=1,i.sqrt()}function hn(e){return e instanceof te||e&&e.toStringTag===Vn||0}function nr(e){return new this(e).ln()}function ir(e,t){return new this(e).log(t)}function rr(e){return new this(e).log(2)}function or(e){return new this(e).log(10)}function sr(){return dn(this,arguments,"lt")}function ar(){return dn(this,arguments,"gt")}function cr(e,t){return new this(e).mod(t)}function lr(e,t){return new this(e).mul(t)}function ur(e,t){return new this(e).pow(t)}function dr(e){var t,i,n,o,r=0,a=new this(1),s=[];if(e===void 0?e=this.precision:ee(e,1,me),n=Math.ceil(e/W),this.crypto)if(crypto.getRandomValues)for(t=crypto.getRandomValues(new Uint32Array(n));n>r;)429e7>(o=t[r])?s[r++]=o%1e7:t[r]=crypto.getRandomValues(new Uint32Array(1))[0];else{if(!crypto.randomBytes)throw Error(Rt);for(t=crypto.randomBytes(n*=4);n>r;)214e7>(o=t[r]+(t[r+1]<<8)+(t[r+2]<<16)+((127&t[r+3])<<24))?(s.push(o%1e7),r+=4):crypto.randomBytes(4).copy(t,r);r=n/4}else for(;n>r;)s[r++]=1e7*Math.random()|0;for(n=s[--r],e%=W,n&&e&&(o=J(10,W-e),s[r]=(n/o|0)*o);s[r]===0;r--)s.pop();if(0>r)i=0,s=[0];else{for(i=-1;s[0]===0;i-=W)s.shift();for(n=1,o=s[0];o>=10;o/=10)n++;W>n&&(i-=W-n)}return a.e=i,a.d=s,a}function fr(e){return D(e=new this(e),e.e+1,this.rounding)}function mr(e){return(e=new this(e)).d?e.d[0]?e.s:0*e.s:e.s||NaN}function pr(e){return new this(e).sin()}function hr(e){return new this(e).sinh()}function gr(e){return new this(e).sqrt()}function yr(e,t){return new this(e).sub(t)}function br(){var e=0,t=arguments,i=new this(t[e]);for(_=0;i.s&&++e<t.length;)i=i.plus(t[e]);return _=1,D(i,this.precision,this.rounding)}function kr(e){return new this(e).tan()}function vr(e){return new this(e).tanh()}function Pr(e){return D(e=new this(e),e.e+1,1)}function ue(e,t){return new te(e).add(new te(t)).toNumber()}function at(e){return e.replace(/\s+\)/g,")").replace(/\(\s+/g,"(").replace(/\s*,\s*/g,",").replace(/\s+/g," ")}function At(e){switch(e){case"Cb":return"B";case"Db":return"C#";case"Eb":return"D#";case"E#":return"F";case"Fb":return"E";case"Gb":return"F#";case"Ab":return"G#";case"Bb":return"A#";case"B#":return"C";default:return e}}function Pe(e){if(e.length===3){const t=e.replace(/^([CDEFGAB])(b#|#b)$/,"$1");if(t!==e)return t;{const i=e.match(/^([CDEFGAB]#)#$/);if(i)return gn(i[1]);{const n=e.match(/^([CDEFGAB])bb$/);if(n)return yn(n[1],2)}}}return At(e)}function gn(e){const t=ye.iKey,i=t.indexOf(e)+1;return t[i%12]}function yn(e,t=1){const i=ye.iKey,n=i.indexOf(e)-t;return i[(12+n)%12]}function ct(e){const t=[{sym:"E",note:64},{sym:"B",note:59},{sym:"G",note:55},{sym:"D",note:50},{sym:"A",note:45},{sym:"E",note:40},{sym:"B",note:35},{sym:"F#",note:30},{sym:"C#",note:25}],i=[];for(let n=0;e.length>n;n++){const o=e.length-n-1,r=Oi[e[n]].indexOf(t[o].sym);i.unshift(t[o].note-r)}return i}function bn(e,t){return Array.from({length:t-e+1},(i,n)=>e+n)}function kn(e,t){return e.length>(t=Math.abs(t)%(2*(e.length-1)))||(t=2*(e.length-1)-t),t}function $t(e,t){const i=e.slice(0,t);return e.slice(t,e.length+1).concat(i)}function lt(e,t){const i=e.indexOf(t),n=e.slice(0,i);return e.slice(i,e.length+1).concat(n)}function _e(e,t,i,n=[]){const o=[];let r="",a=e,s=t,c=e,u=t,l=0;for(const f of i)f===`
`?(a++,s=1,l?r+=f:(/\S/.test(r)&&o.push({token:r.trim(),line:c,pos:u}),c=a,u=s,r="")):n.includes(f)?l?r+=f:(/\S/.test(r)&&o.push({token:r.trim(),line:c,pos:u}),c=a,u=s+(e===c?1:0),r=""):f==="("?l++:f===")"?l--:/\s/.test(f)?/\S/.test(r)?r+=f:u++:r+=f,s++;return/\S/.test(r)&&o.push({token:r.trim(),line:c,pos:u}),o}function wr(e,t,i,n){const o={};let r="";if(/!/.test(e)){const c=e.split("!"),u=parseInt(c[1]);if(1>u||u>F.maxApproachPercent)return new M(t,i,e,`Invalid shift order '${u}'. Approach speed must be an integer with a value between 1 and ${F.maxApproachPercent}.`);o.percentOfSpeed=u,r=c[0]}else r=e;const a=r.split("|"),s=n.map((c,u)=>{const l=parseInt(a[n.length-1-u]);return l>F.maxTopFret?-2:isNaN(l)?void 0:l});return a.length>n.length?new M(t,i,e,`Invalid velocity value '${r}'. 
You cannot specify more than the number of strings. Please set the number of strings using "set.turning".`):s.includes(-2)?new M(t,i,e,`Invalid token '${r}'. Up to ${F.maxTopFret} frets can be used`):(o.bowWithFret=s,new R(o))}function Mr(e,t,i){const n=[],o=_e(t,i+3,e,[","]);let r=0,a=-1,s=0;for(const c of o){const u={row:c.token,line:c.line,linePos:c.pos};let l=c.pos,f=c.token;const d=c.token.split(/\s+/).length;for(let m=0;d>m;m++){const h=f.match(/^((?:[^\s]+)(?:\s+|$))/);f=f.replace(/^[^\s]+\s+/,"");const p=h?h[1]:"",g=p.trimEnd();if(/^(\d+)?\.\./.test(g)){const y=g.match(/^(\d+)?\.\.(\d+)?(\/\d+)?$/);if(!y)return new M(c.line,l,g,`Invalid bend token '${g}'. e.g. 0..2/4`);if(y[3]){const b=parseInt(y[3].replace(/\//,""));if(r&&r!==b)return new M(c.line,l,c.token,`Different denominators cannot be set. '/${b}'`);if(r=parseInt(y[3].replace(/\//,"")),r>F.bendMaxFixedUntilDenom)return new M(c.line,l,c.token,`The division denominator for Bend is ${F.bendMaxFixedUntilDenom}, but the setting value is ${r}.`)}else r===0&&(r=16);u.untilRange=[/^\d+$/.test(y[1])?parseInt(y[1]):0,/^\d+$/.test(y[2])?parseInt(y[2]):-1,r]}else if(g==="reset")if(s===0)u.untilRange=[0,0,1],u.pitch=0;else{if(s!==o.length-1)return new M(c.line,l,c.token,"Bend 'reset' can only be specified at the beginning or end.");u.untilRange=[-2,-2,1],u.pitch=0}else if(/^(-|\+)?(\d+)(\.\d+)?$/.test(g)){const y=parseFloat(g);if(-2>y||y>2)return new M(c.line,l,c.token,`Invalid bend pitch '${y}'. Pitch can be set from -2 to 2.`);u.pitch=y}else if(/^(ast|tri)$/.test(g))u.curve=g==="try"?Ue.tri:Ue.ast;else if(g==="vib")u.method=on.vib;else if(/^tpl::/.test(g))u.template=g;else if(g!=="cho")return new M(c.line,l,c.token,`Wrong way to bend property '${g}'`);l+=p.length}if(u.template){if(u.untilRange||u.curve||u.cycle||u.pitch||n.length>0)return new M(c.line,i,e,"Bend templates cannot overlap with other settings.")}else u.untilRange||(r===0&&(r=8),u.untilRange=u.method===on.vib?[0>a?0:a,-1,r]:[0,-1,r]);if(u.method===void 0&&u.pitch===void 0&&(u.pitch=1),s!==0&&u.untilRange[0]!==-2){if(a===-1)return new M(c.line,l,c.token,`The previous specification has already specified the end. '${c.token}'`);a>u.untilRange[0]&&(u.untilRange[0]=a)}a=u.untilRange[1],n.push(u),s++}return new R(n)}function Sr(e,t,i,n){let o=e.trim();const r={line:i,linePos:n,row:o};if(!/\D/.test(o)){const c=Ct(e,i,n);return c.fail()?c:(r.type=1,r.beforeBPM=c.res,new R(r))}if(/^(-|\+)\d+$/.test(o))return new M(i,n,e,`Invalid bpm token '${e}'. If you use +- signs, start with '..'.
e.g. bpm(120..-10)`);const a=o.match(/\s*(\.\.)\s*?([+-])?(\d+)$/);a&&(r.type=a[1]?2:1,a[2]&&(r.afterSign=a[2]==="+"?1:-1),r.afterBPM=parseInt(a[3]),o=o.replace(/\s*(\.\.)\s*?[+-]?\d+$/,""));const s=o.match(/^(\+|-)?(\d+)$/);return s&&(r.type=3,s[1]&&(r.beforeSign=s[1]==="+"?1:-1),r.beforeBPM=parseInt(s[2]),o=o.replace(/^(\+|-)?(\d+)$/,"")),r.type!==2&&r.type!==3||t===B.closingCurlyBrace?o!==""?new M(i,n,o,`Invalid BPM format '${o}'. e.g. bpm(100..200) or bpm(-20..+20) or bpm(140) etc..`):new R(r):new M(i,n,e,`Invalid set position transition bpm '${e}'. Transition BPM cannot be specified for a single note.`)}function Ct(e,t,i){if(e=e.trim(),/[^\d]/.test(e))return new M(t,-1,null,`Invalid BPM '${e}', The entered value is outside the accepted range of ${F.minBPM}-${F.maxBPM}. Please enter a value within this range.`);const n=parseInt(e);return F.minBPM>n||n>F.maxBPM||isNaN(n)?new M(t,i,e,`Invalid BPM '${e}', The entered value is outside the accepted range of ${F.minBPM}-${F.maxBPM}. Please enter a value within this range.`):new R(n)}function Tr(e,t,i){const n={};if(e==="")return new M(t,i,e,"'delay' properties need to be set.");if(!/^\d+\/\d+$/.test(e))return new M(t,i,e,`Invalid delay property '${e}'.`);{const o=de(e,t,i);if(o.fail())return o;n.startUntil=o.res}return n.startUntil[0]===0?new M(t,i,e,`Invalid delay property '${e}'. Molecule cannot be specified as 0.`):n.startUntil[0]>n.startUntil[1]?new M(t,i,e,`Invalid delay property '${e}'. Make the numerator smaller than the denominator because it exceeds the range.`):new R(n)}function Lt(e,t,i){const n={},o=function(f,d,m){const h=[];let p="",g=d,y=0,b=0;const P=()=>{h.push({token:p,line:y+f,pos:g}),g+=p.length};let k=0;const S=m.length;for(;S>k;){const v=m[k];switch(v){case" ":b?p+=v:p.length&&(P(),p=""),g++;break;case`
`:b?p+=v:(p.length&&(P(),p=""),y++,g=0),g++;break;case"(":b++,p+=v;break;case")":b--,p+=v;break;default:p+=v}k++}return p.length&&P(),h}(t,i+4,e);let r="";for(const f of o){const d=f.token,m=f.line,h=f.pos,p=d.match(/^([CDEFGAB](?:#|b)?)(m|M)?$/);if(p)p[1]&&(n.tonic=At(p[1])),p[2]==="m"?n.tonal=le.minor:p[2]==="M"&&(n.tonal=le.major);else{if(/^[CDEFGAB](#|b)?:[01]+$/.test(d))return new fo(t,i,d,`CustomScale Not Allowed. '${d}'`);if(/^\d+th$/.test(d)){const g=parseInt(d.replace(/th$/,""));if(r===le.major||r===le.minor||r===Se.harmonic||r===Se.melodic){if(g!==7&&g!==6)return new M(m,h,d,`Invalid shift order '${d}'. Set numerical values with 'th' for tonality to 6 or 7; however, note that some sequences are not supported.
e.g. minor 6th`);n.tonalShift=g}else{if(r!=="mode")return new M(m,h,d,`Invalid token '${d}'. Set numerical values with 'th' after 'major', 'minor', 'mode'.
e.g. harmonic minor 7th mode 5th`);if(1>g||g>7)return new M(m,h,d,`Invalid shift order '${d}'. Must be an integer with a value between 1 and 7.`);n.modalShift=g}}else switch(d){case"mode":r=d;break;case Se.harmonic:case Se.melodic:n.scale=d;break;case le.major:case le.minor:n.tonal=d;break;default:return new M(m,h,d,`'${d}' is an invalid token that cannot be set as a key.
e.g. C# melodic minor 7th mode 3th`)}}r=d}if(n.scale&&!n.tonal)return new M(t,i,n.scale,`Invalid order '${n.scale}. 'minor' or 'major' is required after '${n.scale}'.
e.g. harmonic minor 7th mode 5th`);n.tonic||(n.tonic=xi.C),n.scale||(n.scale=Se.normal),n.tonal||(n.tonal=le.major);const a=`${n.scale} ${n.tonal} ${s=n.tonalShift,s?s+"th":""}`.trim();var s;const c=ho(a);if(!c)return new M(t,i,a,`Invalid scale combination '${a}'.`);n.modalShift&&(c.evolvedCodePrefix=$t(c.evolvedCodePrefix,n.modalShift-1),c.bin=$t(c.bin,function(f,d){const m=f.map((h,p)=>h===1?p:-1).filter(h=>h!==-1);return d>m.length?-1:m[d-1]}(c.bin,n.modalShift))),n.diatonicEvolverValue=c;const u=lt(ye.iKey,n.tonic),l=u.map((f,d)=>c.bin[d]===1?f:null).filter(f=>f!==null);return n.sys={shiftedKeyArray:u,note7array:l},new R(n)}function xr(e,t,i){const n=[];if(!/\S/.test(e))return new M(t,i,"map","Invalid map syntax. Symbol must be specified for map.");const o=_e(t,i,e,[","]);for(let r=0;o.length>r;r++){const a=o[r],s=[];let c=0;const u=a.token.match(/((?:-|\+)?\d+)\.\.((?:-|\+)?\d+)(?:\s*step\s*(\d+))?\s*/);u&&(a.token=a.token.replace(u[0],""));const l=a.token.match(/((?:-|\+)?\d+)\s*step\s*((?:-|\+)?\d+)\s*\*\s*((?:-|\+)?\d+)\s*/);l&&(a.token=a.token.replace(l[0],""));const f=a.token.match(/^(\d+)?\s*\*\s*(\d+)$/);if(f&&(a.token=a.token.replace(f[0],"")),a.token!==""){const d=a.token.split(/\s+/);for(let m=0;d.length>m;m++){const h=d[m];if(lo.includes(h))s.push(xe[h]);else{if(!/^(\+|-)?\d+$/.test(h))return new M(a.line,a.pos,e,`Invalid Mapping token '${h}'.
e.g. 3 ss, -2..+2 rev etc..`);c=parseInt(h)}}}if(f){const d=f[1]===void 0?0:parseInt(f[1]),m=parseInt(f[2]);if(m>F.maxMappedStepOrder)return new M(a.line,a.pos,f[0],`Invalid map prop '${f[0]}'. The coefficient limit for this specification is ${F.maxMappedStepOrder}.`);for(let h=0;m>h;h++)n.push({shift:d,options:s,location:{row:a.token,line:a.line,linePos:a.pos}})}else if(l){const d=parseInt(l[1]),m=parseInt(l[2]),h=parseInt(l[3]);if(1>h)return new M(a.line,a.pos,l[0],`Invalid Mapping token '${l[0]}'. Coefficient cannot be less than or equal to zero.
e.g. map(1 step 2 * 3)`);if(h>F.maxMappedStepOrder)return new M(a.line,a.pos,l[0],`Invalid map order '${l[0]}'. The coefficient limit for this specification is ${F.maxMappedStepOrder}.`);let p=d;for(let g=0;h>g;g++){const y={shift:p,options:s,location:{row:a.token,line:a.line,linePos:a.pos}};p+=m,n.push(y)}}else if(u){const d=parseInt(u[1]),m=parseInt(u[2]);let h=u[3]!==void 0&&/^[1-9]/.test(u[3])?parseInt(u[3]):1;if(h=d>m?-Math.abs(h):Math.abs(h),Math.abs(d-m)>=F.maxMappedStepOrder)return new M(a.line,a.pos,u[0],`Invalid map order '${u[0]}'. Step count range is up to ${F.maxMappedStepOrder}.`);for(let p=d;h>0?m>=p:p>=m;p+=h)n.push({shift:p,options:s,location:{row:a.token,line:a.line,linePos:a.pos}})}else n.push({shift:c,options:s,location:{row:a.token,line:a.line,linePos:a.pos}})}return new R(n)}function vn(e,t,i){const n=e.split("|"),o=n.find(s=>s===""||!/^[CDEFGAB](#|b)?$/.test(s));if(o||o==="")return new M(t,i,e,`Invalid tuning '${o}', tuning supports only ${ye.iKey.map(s=>`'${s}'`)}.`+(/^\||\|$/.test(e)?`
Please set without '|' on both sides.`:"")+`
e.g. D|A|D|G|A|D or C#|A|D|G|B|E or C#|F#|B|E|A|D|G|B|E`);if(6>n.length||n.length>F.maxBows)return new M(t,i,e,`Invalid tuning '${n.join("|")}'. The number of strings that can be set ranges from 6 to ${F.maxBows}.`);const r=n.map(s=>Pe(s)),a=ct(r);for(let s=1;a.length>s;s++)if(a[s]>a[s-1])return new M(t,i,e,`Invalid tuning ${e}.
The treble strings cannot be lower than the bass strings.
e.g. C#|F#|B|E|A|D|G|B|E`);return new R(r)}function de(e,t,i){if(!/^\d+\/\d+$/.test(e))return new M(t,i,e,`Invalid token '${e}'. specify A as a fraction. e.g. 1/4`);const n=e.split("/").map(o=>parseInt(o.trim()));return n[0]>F.maxUntilNext0?new M(t,i,e,`Invalid token '${n.join("/")}', numerator value '${n[0]}' exceeds the allowed maximum of ${F.maxUntilNext0}.`):n[1]>F.maxUntilNext1||1>n[1]?new M(t,i,e,`Invalid token '${n.join("/")}', The entered value is outside the accepted range of 1-${F.maxUntilNext1}. Please enter a value within this range.`):new R(n)}function Ir(e,t,i){const n={};if(e==="")return new M(t,i,e,"staccato requires property");if(!/^\d+\/\d+$/.test(e))return new M(t,i,e,`Invalid staccato property '${e}'.`);{const o=de(e,t,i);if(o.fail())return o;n.cutUntil=o.res}return n.cutUntil[0]===0?new M(t,i,e,`Invalid staccato property '${e}'. Molecule cannot be specified as 0.`):n.cutUntil[0]>n.cutUntil[1]?new M(t,i,e,`Invalid staccato property '${e}'. Make the numerator smaller than the denominator because it exceeds the range.`):new R(n)}function Nr(e,t,i,n,o,r){if(!/\S/.test(n))return new M(o,i,t,"Invalid step syntax. Symbol must be specified for step.");const a=function(l,f,d,m){let h=d,p=m-1,g=d,y=m-1;const b=[];let P=0,k="",S="";for(const v of f)if(v!==`
`)if(y++,/\s/.test(v))S+=" ";else{if(!/[.MmnDdUuf123456789rRN~^=()]/.test(v))return new M(g,y,v,`Invalid step symbol '${v}'. Only '.MmnDdUuf123456789rR' can be used with step.`);if(/\d/.test(v)&&parseInt(v)>l.length)return new M(g,y,v,`Invalid pos value '${v}'. The string specification exceeds the number of strings specified in tuning ${l.length} strings.`);if(v!=="(")if(v!==")")if(k==="")h=g,p=y,k+=v,S+=v;else if(P)k+=v,S+=v;else if(/m|M|n|N|~|=|\^|\./.test(v)){if(k==="")return new M(g,y,v,`Invalid step symbol '${v}'. Instrument specification cannot be at the beginning.`);k+=v,S+=v}else b.push({sym:k,startLine:h,startPos:p,endPos:p+S.trim().length}),k=v,S=v,h=g,p=y;else{if(k==="")return new M(g,y,v,`Invalid step symbol '${v}'. Parentheses must specify a symbol.`);if(/^(~|=|\^|\.)/.test(k))return new M(g,y,v,`Invalid step symbol '${k}'.. Instrument specification cannot be at the beginning.`);P=0,b.push({sym:k,startLine:h,startPos:p,endPos:p+S.trim().length}),k="",S=""}else{if(P)return new M(g,y,v,`Invalid pos value '${v}'. Parentheses can only be one level deep.`);k!==""&&(b.push({sym:k,startLine:h,startPos:p,endPos:p+S.trim().length}),k="",S=""),P=1}}else P||k===""||(b.push({sym:k,startLine:h,startPos:p,endPos:p+S.trim().length}),k="",S=""),g++,y=0;return k!==""&&b.push({sym:k,startLine:h,startPos:p,endPos:p+S.trim().length}),new R(b)}(e,n,o,r);if(a.fail())return a;const s={parsedStep:[]},c=[],u=Array.from({length:e.length},(l,f)=>f);for(let l=0;a.res.length>l;l++){const f=a.res[l].sym,d={line:a.res[l].startLine,startPos:a.res[l].startPos,endPos:a.res[l].endPos},m=f.match(/\d/g);if(/f|D|d|U|u/.test(f))d.stringIndexes=u;else if(/R|rn/.test(f))d.stringIndexes=void 0,d.inst=L.restNoise;else if(/r/.test(f))d.stringIndexes=void 0,d.inst=L.rest;else{if(!m)return new M(o,r,n,`Invalid step symbol '${n}'. Specification violation.`);d.stringIndexes=m.map(g=>parseInt(g)-1)}const h=f.replace(/rn/,"").match(/[nmMDdUuN]/g);if(h){if(h.length>1)return new M(o,r,n,`Invalid step symbol '${h.join("")}'. Multiple inst specifications cannot be specified for one string.`);d.inst={n:L.normal,m:L.mute,M:L.muteContinue,D:L.brushing_D,d:L.brushing_d,U:L.brushing_U,u:L.brushing_u,N:L.normalUnContinueForStep}[h[0]]}const p=f.replace(/[fnmMDdUu]/g,"").replace(/\./g,"~").match(/[~^=]+/g);p&&(d.suffix=p[0]),c.push(f),d.stepSym=[...c],s.parsedStep.push(d)}return new R(s)}function Or(e,t,i,n){const o={};if(t!==""){const r=t.split(",");for(const a of r)if(/\D/.test(a)){if(!/^\d+\/\d+$/.test(a))return new M(i,n,t,`Invalid strum property '${a}'.`);{const s=de(a,i,n);if(s.fail())return s;o.startUntil=s.res}}else{const s=parseInt(a);if(0>s||s>F.maxStrumWidthMSec)return new M(i,n,t,`Invalid strum msec '${a}'. Strum must be between 0 and ${F.maxStrumWidthMSec}.`);o.strumWidthMSec=s}}return o.startUntil&&o.startUntil[0]===0?new M(i,n,t,`Invalid strum property '${t}'. Molecule cannot be specified as 0.`):o.startUntil&&o.startUntil[0]>o.startUntil[1]?new M(i,n,t,`Invalid strum property '${t}'. Make the numerator smaller than the denominator because it exceeds the range.`):(o.startUntil||(o.startUntil=[0,1]),o.strumWidthMSec||(o.strumWidthMSec=e.settings.play.strum.defaultStrumWidthMSec),new R(o))}function Ar(e,t,i,n){const o={},r=function(a,s,c){const u=[];if(!/\S/.test(c))return new R(u);let l,f="",d=0,m=a,h=s,p=a,g=s,y=0,b=0,P={};const k=w=>{let N=f;if(/^\s*\(\s*/.test(f)){const E=function(U,C,T){const I=U.split(`
`);for(let $=0;I.length>$;$++){const x=I[$].search(/[^\s(]/);if(x!==-1){C+=$,T=x+($===0?T:1);break}}return{line:C,pos:T}}(f,p,g);p=E.line,g=E.pos,N=f.replace(/^\s*\(\s*(.+?)\s*\)\s*$/,"$1")}else N=f.replace(/^\s*(.+?)\s*$/,"$1");if(w===0){if(!/\S/.test(N))return void(l=new M(p,g,N,"key required."));if(/\s/.test(N))return void(l=new M(p,g,N,`Invalid token '${N.replace(/\s/," ")}'. key is separated.`));P.key={token:N,line:p,pos:g}}else{if(!/\S/.test(N))return void(l=new M(p,g,N,"Value required."));if(!P.key)return void(l=new M(p,g,N,"Required in key-value format."));P.val={token:N,line:p,pos:g},u.push(P),P={}}g=h,p=m,f=""},S=c.replace(/(\s*,\s*)+$/,""),v=S.length;for(;v>d;){const w=S[d];switch(w){case`
`:y||(/\S/.test(f)?(k(1),b=0):(p++,g=1)),h=1,m++,f+=w;break;case":":if(y)f+=w;else{if(b===1){l=new M(m,h,f,"Wrong order of value.");break}k(0),b=1}break;case",":if(y)f+=w;else{if(b===0){l=new M(m,h,f,"Wrong order of key.");break}k(1),b=0}break;case"(":y++,f+=w;break;case")":y--,f+=w;break;case" ":/\S/.test(f)||g++,f+=w;break;default:f+=w}h++,d++}return/\S/.test(f)&&k(1),b===0&&/,\s+$/.test(c)?new M(a,s,c,'Syntax Error By Style. The final "," is not allowed.'):P.key&&!P.val?new M(P.key.line,P.key.pos,P.key.token,`value of '${P.key.token}' not found.`):l||new R(u)}(i,n+4,t);if(r.fail())return r;for(let a=0;r.res.length>a;a++){const s=r.res[a];switch(s.key.token){case"L":case"loc":case"location":{const c={low:1,mid:2,high:3,higher:4}[s.val.token];if(c===void 0)return new M(s.val.line,s.val.pos,s.key.token,`Invalid pos.${s.key.token} value '${s.val.token}'. Possible values are 'low', 'mid', 'high', or 'higher'.`);o.location=c;break}case"I":case"inv":case"inversion":if(/[^12345]/.test(s.val.token))return new M(s.val.line,s.val.pos,s.val.token,`>>>Invalid pos.${s.key.token} value '${s.val.token}'. ${s.key.token} must be between 1 and 5.`);o.inversion=parseInt(s.val.token);break;case"E":case"exc":case"exclusion":if(/^[\s\d,]+$/.test(s.val.token)){s.val.token=s.val.token.replace(/\s|,/g,"");const c=s.val.token.split("").map(u=>{const l=parseInt(u);return l>e.length?-1:l});if(c.includes(-1))return new M(s.val.line,s.val.pos,s.val.token,`strings '${s.val.token}' don't exist.`);o.exclusion=c;break}return new M(s.val.line,s.val.pos,s.val.token,`Invalid pos.${s.key.token} value '${s.val.token}'. ${s.key.token} must be 1 or 5.`);case"U":case"use":case"useStrings":if(/^[\s\d,]+$/.test(s.val.token)){if(s.val.token=s.val.token.replace(/\s|,/g,""),s.val.token.length>e.length)return new M(s.val.line,s.val.pos,s.val.token,"over length: "+s.val.token);const c=s.val.token.split("").map(u=>{const l=parseInt(u);return l>e.length?-1:l});if(c.includes(-1))return new M(s.val.line,s.val.pos,s.val.token,`strings ''${s.val.token}'' don't exist..`);o.useStrings=c.sort()}else{if(s.val.token!=="full"&&s.val.token!=="f")return new M(s.val.line,s.val.pos,s.val.token,`Invalid pos.${s.key.token} value '${s.val.token}'.`);o.useStrings=e.map((c,u)=>u+1)}break;case"R":case"req":case"required":if(/^[\s\d,]+$/.test(s.val.token)){if(s.val.token=s.val.token.replace(/\s|,/g,""),s.val.token.length>e.length)return new M(s.val.line,s.val.pos,s.val.token,`strings '''${s.val.token}''' don't exist.`);const c=s.val.token.split("").map(u=>{const l=parseInt(u);return l>e.length?-1:l});if(c.includes(-1))return new M(s.val.line,s.val.pos,s.val.token,`strings ''''${s.val.token}'''' don't exist.`);o.required=c.sort()}else{if(s.val.token!=="full"&&s.val.token!=="f")return new M(s.val.line,s.val.pos,s.val.token,`Invalid pos.${s.key.token} value '${s.val.token}'.`);o.required=e.map((c,u)=>u+1)}break;case"C":case"cov":case"cover":{const c={true:0,false:1,error:2,err:2,warn:3,warning:3}[s.val.token];if(c===void 0)return new M(s.val.line,s.val.pos,s.val.token,`Invalid pos.${s.key.token} value '${s.val.token}'. Possible values are 'true', 'false', 'warn', or 'error'.`);o.cover=c;break}default:return new M(s.key.line,s.key.pos,s.key.token,`Unknown pos key '${s.key.token}'.`)}}return Object.keys(o).length?new R(o):new M(i,n,t,"'pos' properties need to be set.")}function $r(e,t,i){const n={},o=_e(t,i+3,e,["!",",","."]);for(const r of o)if(/^\d+\/\d+$/.test(r.token)){const a=de(r.token,r.line,r.pos);if(a.fail())return a;n.until=a.res}else if(r.token==="off")n.off=1;else{if(r.token!=="up")return new M(r.line,r.pos,r.token,`The stroke property '${r.token}' is invalid.
e.g. ## stroke(1/8) or stroke(1/8.up) or stroke(off) etc..`);n.up=1}return new R(n)}function Pn(e,t,i){const n={},o=_e(t,i,e,[","," "]);for(let r=0;o.length>r;r++){const a=o[r];if(/^[CDEFGAB](#|b)?$/.test(a.token))n.key=Pe(a.token);else if(Ii.includes(a.token))n.scale=Ii.indexOf(a.token),n.bin=Ni[n.scale].bin;else{if(!/^\d+$/.test(a.token))return new M(a.line,a.pos,e,`Invalid scale token '${a.token}'.
e.g. E dorian`);if(!/^[01]+$/.test(a.token))return new M(a.line,a.pos,e,`Invalid scale token '${a.token}'. Customize scale to shape "1" and "0".
e.g. E 101101011010`);if(a.token.length!==12)return new M(a.line,a.pos,e,`Invalid scale token '${a.token}'. Customize the scale to 12 digits.
e.g. E 101101011010`);n.scale=a.token,n.bin=a.token.split("").map(s=>s==="1"?1:0)}}return n.key?n.scale===void 0?new M(t,i,e,`Invalid scale token '${e}'. Scales need scale name.
e.g. E minor`):new R(n):new M(t,i,e,`Invalid scale token '${e}'. Scales need keys.
e.g. E minor`)}function wn(e,t,i,n){const o={},r=_e(t,i-2,e,["!",","]);for(const a of r){if(/^\d+\/\d+$/.test(a.token)){const u=de(a.token,a.line,a.pos);if(u.fail())return u;o.startUntil=u.res;continue}const s=a.token.match(/^(fast|mid|slow)(?:\.?(\d+))?$/);if(s){o.inSpeed=s[1],s[2]&&(o.inSpeedLevel=parseInt(s[2]));continue}const c=a.token.match(/^(hi|low)(?:\.?(\d+))?$/);if(c)o.type="release",o.arrow=c[1]==="hi"?1:-1,c[2]&&(o.releaseWidth=parseInt(c[2]));else if(a.token!=="continue"){if(a.token!=="auto")return new M(a.line,a.pos,a.token,`The slide property '${a.token}' is invalid because it is an unknown word.`);o.auto=1}else o.continue=1}return o.type||(o.type="to"),o.startUntil||(o.startUntil=o.arrow?[6,8]:[1,2],o.type==="to"&&(o.auto=1)),o.inSpeedLevel||(o.inSpeedLevel=48),n&&(o.continue=1),o.continue&&o.type==="release"&&(o.continue=void 0),new R(o)}function Mn(e,t,i,n,o){const r=t.split(/[|,]/).map((a,s)=>{const c=a.trim();return c===""?e.settings.play.velocities[s]:/^\d+$/.test(c)?parseInt(c):NaN}).reverse();return r.some(a=>a!==void 0&&(a>100||0>a||isNaN(a)))?new M(n,o,t,`Invalid velocities value '${t}'. Must be an integer with a value between 0 and 100.`):r.length>i.length?new M(n,o,t,`Invalid velocity value '${t}'. 
You cannot specify more than the number of strings. Please set the number of strings using "set.turning".
e.g. for 7 strings it is "set.turning: D|E|A|D|G|B|E"`):new R(r)}function Sn(e,t,i){const n=parseInt(e.replace(/^\s/g,""));return n>100||!/^s*\d+\s*$/.test(e)?new M(t,i,e,`Invalid velocity value '${e}'. Must be an integer with a value between 0 and 100.`):new R(n||1)}function ut(e){const t=e.token;if(/^([./!']+)?([|\dr]+(!\d+)?>>)/.test(e.token)){const i=e.token.match(/^([./!']+)?([|\dr]+)(!\d+)?>>/);if(i){if(/r/.test(i[2]))return new M(e.line,e.linePos,e.token,"The rest 'r' cannot be specified for the approach.");e.styles.push(`approach(${i[2]+(i[3]?i[3]:"")})`),e.linesOfStyle.push(e.line),e.linePosOfStyle.push(e.linePos+(i[1]?i[1].length:0)),e.token=e.token.replace(/^([./!']+)?[|\dr]+(!\d+)?>>/,"$1")}}if(/^([/!']+)?\.\./.test(e.token)&&(e.styles.push("continue"),e.linesOfStyle.push(e.line),e.linePosOfStyle.push(e.linePos),e.token=e.token.replace(/^([/!']+)?\.\./,"$1")),/^'*?\//.test(e.token)&&(e.styles.push("strum"),e.linesOfStyle.push(e.line),e.linePosOfStyle.push(e.linePos),e.token=e.token.replace(/^('*?)\//,"$1")),/^!?('+)/.test(e.token)||/^!('+)?/.test(e.token)){const i=e.token.match(/^(!)?('*)/);if(i){const n=i[2].split("").length;if(n>8)return new M(e.line,e.linePos,e.token,"The prefix >>'<< that specifies stroke cannot exceed 8.");const o=[16,12,8,6,4,3,2,1][n-1];e.styles.push(`stroke(${o?"1/"+o:""}${i[1]?".up":""})`),e.linesOfStyle.push(e.line),e.linePosOfStyle.push(e.linePos),e.token=e.token.replace(/^!?'*/,"")}}return/^[.!/>]/.test(e.token)?/>/.test(e.token)?new M(e.line,e.linePos,e.token,`Invalid approach prefix ${t}.
e.g. ||||2|2>>||||5|5 or ||||2|2!200>>||||5|5 etc..`):/\.\.\./.test(t)||/\./.test(e.token)?new M(e.line,e.linePos,e.token,`Invalid continue prefix '${t}'. Continue dots are only valid for 2 connections.
e.g. ..|3|2|3|2`):new M(e.line,e.linePos,t,`Invalid token prefix '${t}'.
e.g. ..C or ''C or ..''|||2|2| or /|||2|2| or ||||2|2>>||||5|5 or ||||2|2!200>>||||5|5 etc..`):(e.prefixLength=t.length-e.token.length,j())}function Cr(e,t,i,n,o){const r=e.marks.styleMappedGroupList,a=r.findIndex(b=>b>0);let s=-1;if(r[a]>0?(s=r[a]+1,r.splice(a,0,s)):(s=1,r.splice(1,0,s)),n.decidedProp.noteStr.match(/\/$/))return new M(n.line,n.linePos,n.decidedProp.noteStr,`Not found fret token. ${n.decidedProp.noteStr}
e.g. 6/1-2-3`);const c=n.decidedProp.noteStr.replace(/:.*?$/,"").match(/^(.*?)\d\/[^/]+$/);let u=0;c&&(u=c[1].length);let l=0,f=n.linePos+u;const[d,m]=n.token.split("/"),h=parseInt(d);if(1>h||h>t.length)return new M(n.line,f,""+h,`Not Found strings '${h}'. Only the tuning string can be specified.`);const p=t.length-h;f+=d.length+1;const g=Object.keys(n.decidedProp.styles),y=m.replace(/-+$/,"").split("-");for(let b=0;y.length>b;b++){const P=y[b];if(P===""){f++;continue}const k=P.match(/^(\d+|r|R)([nmMDdUu])?([~^=]+)?$/);if(!k)return new M(n.line,f,P,`Invalid fret token option '${P}'. Permitted frets include n,m,M,D,d,U,u,R,r, etc..
e.g. 2/4m-5-7-r-5-7`);const S=k[1],v=S==="R"?"R":k[2],w=k[3],N={};g.forEach(I=>{if(n.decidedProp.styles[I]!==void 0){switch(I){case"bd":case"bpm":case"until":case"degree":case"legato":case"scaleX":case"staccato":case"velocity":case"velocityPerBows":case"turn":N[I]=n.decidedProp.styles[I];break;case"mapped":N[I]=structuredClone(n.decidedProp.styles[I]),N[I].forEach($=>{$.group===-1&&($.group=s)})}if(b===0)switch(I){case"approach":case"continue":case"delay":case"strum":N[I]=n.decidedProp.styles[I]}b===y.length-1&&I==="slide"&&(N[I]=n.decidedProp.styles[I])}});const E={n:L.normal,m:L.mute,M:L.muteContinue,R:L.restNoise,D:L.brushing_D,d:L.brushing_d,U:L.brushing_U,u:L.brushing_u}[v];E===L.restNoise&&(N.restNoise=1),N.inst=E!==void 0?E:n.decidedProp.styles.inst!==void 0?n.decidedProp.styles.inst:L.normal,b===0||!n.decidedProp.styles.continue||l||N.inst!==L.normal&&N.inst!==L.muteContinue?b!==0&&(l=1):N.continue=1;const U="|".repeat(p)+(S==="R"?"r":S)+(p===0?"|":"")+(w||""),C=structuredClone(n.decidedProp.extensionViewProp)||{};C.bullet={row:P,index:b};const T={curlyLevel:n.curlyLevel,type:B.note,typesStyle:[],line:n.line,linePos:f,linesOfStyle:[],linePosOfStyle:[],endLine:n.line,endPos:f+P.length,token:U,styles:[],decidedProp:{noteStr:n.decidedProp.noteStr,extensionViewProp:C,list:void 0,tick:structuredClone(n.decidedProp.tick),styles:N,fingering:void 0,chordDicRef:n.decidedProp.chordDicRef,isBullet:o.num},regionRegionForDualConnection:n.regionRegionForDualConnection,locationInfoRefStackUpList:n.locationInfoRefStackUpList};f+=P.length+1,i.push(T)}return j()}function Ge(e,t){return t*(60/e)*(1/F.PPS)}function Tn(e,t){return F.PPS*e/60*(t/1e3)}function we(e){return F.PPS/e[1]*e[0]}function xn(e){const t=function(i,n){for(;n!==0;){const o=i;i=n,n=o%n}return i}(e[0],e[1]);return[e[0]/t,e[1]/t]}function In(e,t,i,n){let o=0;const r=t.match(/[\^=~]+$/);if(r){if(r[0].length>F.maxSuffixExtensionLength)return new M(i,n,t,`Invalid suffix extension token '${t}'. Up to ${F.maxSuffixExtensionLength} suffix extensions can be used.`);const a=r[0].match(/=/g);a&&(e[1]=3*e[1]*a.length);const s=r[0].match(/~/g);s&&(e[0]=e[0]*(s.length+1));const c=r[0].match(/\^/g);c&&(e[1]=2*e[1]*c.length),[e[0],e[1]]=xn(e),o=1}return new R(o)}function Lr(e,t){for(let i=0;t.length>i;i++){const n=t[i];if(n.type!==B.regionStart&&(n.type===B.degreeName||n.type===B.note)){const o=n.decidedProp.styles;n.decidedProp.tick={untilNext:o!=null&&o.until?structuredClone(o.until):structuredClone(e.regionList[n.regionRegionForDualConnection].untilNext)};const r=In(n.decidedProp.tick.untilNext,n.token,n.line,n.linePos);if(r.fail())return r;r.res&&(n.token=n.token.replace(/[\^~=]+$/,""))}}return j()}function Br(e,t,i){const n=[];let o=e.regionList.length-1,r=e.regionList[o].tuning,a=1;const s={};for(let c=t.length-1;c>=0;c--){const u=t[c];switch(u.type){case B.closingCurlyBrace:{const l=u.styles.map((d,m)=>{const h=at(d);return{row:u.styles[m],line:u.linesOfStyle[m],linePos:u.linePosOfStyle[m],s:h,g:h.startsWith("bpm(")||h.startsWith("turn")||h.startsWith("map(")?a++:0}}),f=l.map(d=>d.g).filter(d=>d>0);l.forEach(d=>d.g=d.g>0?f.pop():0),n.push(l);break}case B.openingCurlyBrace:n.pop();break;case B.regionStart:o--,0>o||(r=e.regionList[o].tuning);break;case B.bullet:case B.degreeName:case B.note:{let l={};r=e.regionList[u.regionRegionForDualConnection].tuning;for(let f=0;n.length>f;f++){const d=n[f];for(let m=d.length-1;m>=0;m--){const h=d[m];let p={};if(h.g>0)p=structuredClone(i[`${""+r}_${h.s}`]),p!=null&&p.bpm?p.bpm.group=h.g:p!=null&&p.turn?p.turn.group=h.g:p!=null&&p.mapped&&(p.mapped[0].group=h.g,s[h.g]=1);else{let g="";/^step/.test(h.s)&&(g=":"+h.line+":"+h.linePos),p=i[`${""+r}_${h.s}`+g]}if(l.mapped&&p.mapped){if(p.mapped[0].row=h.row,p.mapped[0].line=h.line,p.mapped[0].linePos=h.linePos,l.mapped.unshift(p.mapped[0]),l.mapped.reduce((g,y)=>g*y.style.length,1)>F.maxMappedStepOrder){const g=l.mapped[l.mapped.length-1];return new M(g.line,g.linePos||-1,g.row||null,`Invalid mapped step order '${g.row}'. The total number of nested map operations exceeds the limit of '${F.maxMappedStepOrder}'.`)}}else{const g=Object.keys(p)[0];typeof p[g]!="object"||Array.isArray(p[g])||(p[g].row=h.row,p[g].line=h.line,p[g].linePos=h.linePos),l={...l,...p}}}}for(let f=u.styles.length-1;f>=0;f--){let d="";/^step/.test(u.styles[f])&&(d=":"+u.linesOfStyle[f]+":"+u.linePosOfStyle[f]);const m=structuredClone(i[`${""+r}_${at(u.styles[f])}`+d]);if(m.mapped){if(m.mapped[0].row=u.styles[f],m.mapped[0].line=u.linesOfStyle[f],m.mapped[0].linePos=u.linePosOfStyle[f],s[a]=1,m.mapped[0].group=a++,l.mapped?l.mapped.unshift(m.mapped[0]):l.mapped=[m.mapped[0]],l.mapped.reduce((h,p)=>h*p.style.length,1)>F.maxMappedStepOrder){const h=l.mapped[l.mapped.length-1];return new M(h.line,h.linePos||-1,h.row||null,`Invalid mapped step order '${h.row}'. The total number of nested map operations exceeds the limit of '${F.maxMappedStepOrder}'.`)}}else{const h=Object.keys(m)[0];typeof m[h]!="object"||Array.isArray(m[h])||(m[h].row=u.styles[f],m[h].line=u.linesOfStyle[f],m[h].linePos=u.linePosOfStyle[f]),l={...l,...m}}}u.decidedProp.styles=l}}}return e.marks.styleMappedGroupList=Object.keys(s).map(c=>parseInt(c)).reverse(),j()}function Er(e,t,i,n){let o=[];for(const r of i)if(r.type!==B.regionStart&&(r.decidedProp&&/^\|(:.+)?$/.test(r.decidedProp.noteStr)&&r.styles.push("0/1"),r.styles.length)){const a=r.styles.length;for(let s=0;a>s;s++){o=t.regionList[r.regionRegionForDualConnection].tuning;const c=r.styles[s],u=at(c);let l="";/^step/.test(r.styles[s])&&(l=":"+r.linesOfStyle[s]+":"+r.linePosOfStyle[s]);const f=`${""+o}_${u}`+l;if(!n[f]){switch(c){case"n":n[f]={inst:L.normal};break;case"m":n[f]={inst:L.mute};break;case"M":n[f]={inst:L.muteContinue};break;case"rn":n[f]={inst:L.restNoise,restNoise:1};break;case"d":n[f]={inst:L.brushing_d};break;case"D":n[f]={inst:L.brushing_D};break;case"u":n[f]={inst:L.brushing_u};break;case"U":n[f]={inst:L.brushing_U};break;case"N":n[f]={inst:L.normalUnContinueForStep};break;case"continue":n[f]={continue:1};break;case"leg":n[f]={legato:1}}if(n[f])continue;if(c.startsWith("approach")){const d=wr(c.replace(/^approach\(|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+9,o);if(d.fail())return d;n[f]={approach:d.res};continue}if(c.startsWith("bd")){const d=Mr(c.replace(/^bd\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]);if(d.fail())return d;n[f]={bd:d.res};continue}if(c.startsWith("bpm")){const d=Sr(c.replace(/^bpm\(|\)$/g,""),r.type,r.linesOfStyle[s],r.linePosOfStyle[s]+4);if(d.fail())return d;n[f]={bpm:{style:d.res,group:-1,groupEndTick:-1}};continue}if(c.startsWith("delay")){const d=Tr(u.replace(/^delay\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+0);if(d.fail())return d;n[f]={delay:d.res};continue}if(c.startsWith("%(")){const d=Lt(c.replace(/^(%)\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]-2);if(d.fail())return d;n[f]={degree:d.res};continue}if(c.startsWith("degree(")){const d=Lt(c.replace(/^(degree)\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+3);if(d.fail())return d;n[f]={degree:d.res};continue}if(c.startsWith("map")){const d=xr(c.replace(/^map\(|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+4);if(d.fail())return d;n[f]={mapped:[{style:d.res,group:-1,row:c,line:r.linesOfStyle[s],linePos:r.linePosOfStyle[s]}]};continue}if(c.startsWith("pos")){const d=Ar(o,c.replace(/^pos\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]);if(d.fail())return d;Object.keys(d.res).length&&(n[f]={pos:d.res});continue}if(/^scale\(.*?\)$/.test(c)){const d=Pn(c.replace(/^scale\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+6);if(d.fail())return d;n[f]={scaleX:d.res};continue}if(/^to&($|\(.+?\))$/.test(c)){const d=wn(c.replace(/^to&\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+6,1);if(d.fail())return d;n[f]={slide:d.res};continue}if(/^to($|\(.+?\))$/.test(c)){const d=wn(c.replace(/^to\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+5);if(d.fail())return d;n[f]={slide:d.res};continue}if(c.startsWith("staccato")){const d=Ir(u.replace(/^staccato\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+9);if(d.fail())return d;n[f]={staccato:d.res};continue}if(c.startsWith("step")){if(r.type===B.bullet)return new M(r.linesOfStyle[s],r.linePosOfStyle[s],r.token,`Invalid style '${c}'. Cannot specify a step in bullet format.`);const d=Nr(o,c,r.linePosOfStyle[s]+1,c.replace(/^step\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+5);if(d.fail())return d;n[f]={step:d.res};continue}if(c.startsWith("stroke")){const d=$r(u.replace(/^stroke\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+4);if(d.fail())return d;n[f]={stroke:d.res};continue}if(c.startsWith("strum")){const d=Or(e,u.replace(/^strum\(?|\)$/g,""),r.linesOfStyle[s],r.linePosOfStyle[s]+6);if(d.fail())return d;n[f]={strum:d.res};continue}if(c.startsWith("turn(")||c==="turn"){n[f]={turn:{props:c.replace(/^turn\(?|\)$/g,""),group:-1}};continue}if(c.startsWith("v(")){const d=Mn(e,c.replace(/v\(|\)$/g,""),o,r.linesOfStyle[s],r.linePosOfStyle[s]+2);if(d.fail())return d;n[f]={velocityPerBows:d.res};continue}if(/^\d+\/\d+$/.test(c)){const d=de(c,r.linesOfStyle[s],r.linePosOfStyle[s]);if(d.fail())return d;n[f]={until:d.res};continue}if(/^v\d+$/.test(c)){const d=Sn(c.replace(/^v/,""),r.linesOfStyle[s],r.linePosOfStyle[s]+1);if(d.fail())return d;n[f]={velocity:d.res};continue}return new be(r.linesOfStyle[s],r.linePosOfStyle[s],c,`Unknown style '${c.replace(/\(.+$/,"")}'`)}}}return j()}function Nn(e){return e!==null&&typeof e=="object"&&"name"in e&&typeof e.name=="string"?1:0}function On(e){return e!==null&&typeof e=="object"&&"step"in e&&typeof e.step=="number"&&"alt"in e&&typeof e.alt=="number"?1:0}function An(e){const{step:t,alt:i,oct:n,dir:o=1}=e,r=Zn[t]+7*i;return n===void 0?[o*r]:[o*r,o*(n-_t[t]-4*i)]}function $n(e){const[t,i,n]=e,o=Xn[function(a){const s=(a+1)%7;return 0>s?7+s:s}(t)],r=Math.floor((t+1)/7);return i===void 0?{step:o,alt:r,dir:n}:{step:o,alt:r,oct:i+4*r+_t[o],dir:n}}function qe(e){return typeof e=="string"?qt[e]||(qt[e]=function(t){const i=function(m){const h=Yn.exec(""+m);return h===null?["",""]:h[1]?[h[1],h[2]]:[h[4],h[3]]}(t);if(i[0]==="")return bt;const n=+i[0],o=i[1],r=(Math.abs(n)-1)%7,a=Kt[r];if(a==="M"&&o==="P")return bt;const s=a==="M"?"majorable":"perfectable",c=""+n+o,u=0>n?-1:1,l=n===8||n===-8?n:u*(r+1),f=function(m,h){return h==="M"&&m==="majorable"||h==="P"&&m==="perfectable"?0:h==="m"&&m==="majorable"?-1:/^A+$/.test(h)?h.length:/^d+$/.test(h)?-1*(m==="perfectable"?h.length:h.length+1):0}(s,o),d=Math.floor((Math.abs(n)-1)/7);return{empty:0,name:c,num:n,q:o,step:r,alt:f,dir:u,type:s,simple:l,semitones:u*(Vt[r]+f+12*d),chroma:(u*(Vt[r]+f)%12+12)%12,coord:An({step:r,alt:f,oct:d,dir:u}),oct:d}}(e)):On(e)?qe(function(t){const{step:i,alt:n,oct:o=0,dir:r}=t;if(!r)return"";const a=i+1+7*o;return(0>r?"-":"")+(a===0?i+1:a)+function(s,c){return c===0?s==="majorable"?"M":"P":c===-1&&s==="majorable"?"m":c>0?Gt("A",c):Gt("d",s==="perfectable"?c:c+1)}(Kt[i]==="M"?"majorable":"perfectable",n)}(e)):Nn(e)?qe(e.name):bt}function fe(e){const t=JSON.stringify(e),i=Ht.get(t);if(i)return i;const n=typeof e=="string"?function(o){const r=Cn(o);if(r[0]===""||r[3]!=="")return zt;const a=r[0],s=r[1],c=r[2],u=(a.charCodeAt(0)+3)%7,l=ti(s),f=c.length?+c:void 0,d=An({step:u,alt:l,oct:f}),m=a+s+c,h=a+s,p=(kt[u]+l+120)%12,g=f===void 0?ii(kt[u]+l,12)-1188:kt[u]+l+12*(f+1),y=0>g||g>127?null:g;return{empty:0,acc:s,alt:l,chroma:p,coord:d,freq:f===void 0?null:440*Math.pow(2,(g-69)/12),height:g,letter:a,midi:y,name:m,oct:f,pc:h,step:u}}(e):On(e)?fe(function(o){const{step:r,alt:a,oct:s}=o,c=Qn(r);if(!c)return"";const u=c+ei(a);return s||s===0?u+s:u}(e)):Nn(e)?fe(e.name):zt;return Ht.set(t,n),n}function Cn(e){const t=ni.exec(e);return t?[t[1].toUpperCase(),t[2].replace(/x/g,"##"),t[3],t[4]]:["","","",""]}function Ln(e){return ri.test(e)}function Bn(e){const t=Ln(e)?e:oi(e)?Zt(e):Array.isArray(e)?function(i){if(i.length===0)return Be.chroma;let n;const o=[0,0,0,0,0,0,0,0,0,0,0,0];for(let r=0;i.length>r;r++)n=fe(i[r]),n.empty&&(n=qe(i[r])),n.empty||(o[n.chroma]=1);return o.join("")}(e):si(e)?e.chroma:Be.chroma;return Yt[t]=Yt[t]||function(i){const n=Xt(i),o=function(s){const c=s.split("");return c.map((u,l)=>function(f,d){const m=d.length,h=(f%m+m)%m;return d.slice(h,m).concat(d.slice(0,h))}(l,c).join(""))}(i).map(Xt).filter(s=>s>=2048).sort()[0],r=Zt(o),a=function(s){const c=[];for(let u=0;12>u;u++)s.charAt(u)==="1"&&c.push(ai[u]);return c}(i);return{empty:0,name:"",setNum:n,chroma:i,normalized:r,intervals:a}}(t)}function Bt(e,t,i){const n=function(d){return Ee[d]||li}(e),o=fe(t||""),r=fe("");if(n.empty||t&&o.empty||i)return vt;const a=function(d,m){const h=fe(d),p=fe(m);if(h.empty||p.empty)return"";const g=h.coord,y=p.coord,b=y[0]-g[0];return function(P,k){const[S,v=0]=P;return qe($n(k||0>7*S+12*v?[-S,-v,-1]:[S,v,1]))}([b,g.length===2&&y.length===2?y[1]-g[1]:-Math.floor(7*b/12)],p.height===h.height&&p.midi!==null&&h.midi!==null&&h.step>p.step).name}(o.pc,r.pc),s=n.intervals.indexOf(a)+1;if(!r.empty&&!s)return vt;const c=Array.from(n.intervals);for(let d=1;s>d;d++){const m=c[0][1];c.push(`${parseInt(c[0][0],10)+7}${m}`),c.shift()}const u=o.empty?[]:c.map(d=>function(m,h){const p=fe(m),g=Array.isArray(h)?h:qe(h).coord;if(p.empty||!g||2>g.length)return"";const y=p.coord;return function(b){return fe($n(b))}(y.length===1?[y[0]+g[0]]:[y[0]+g[0],y[1]+g[1]]).name}(o,d));e=n.aliases.indexOf(e)!==-1?e:n.aliases[0];const l=`${o.empty?"":o.pc}${e}${r.empty||1>=s?"":"/"+r.pc}`,f=`${t?o.pc+" ":""}${n.name}${s>1&&i?" over "+r.pc:""}`;return{...n,name:f,symbol:l,type:n.name,root:r.name,intervals:c,rootDegree:s,tonic:o.name,notes:u}}function Fr(e,t){const i=[],n=e.length-1,o=n-(e.length-t.notes.length),r=(4>t.options.searchFretWidth||t.options.searchFretWidth>12?4:t.options.searchFretWidth)-1,a={},s=t.notes.filter(f=>f!==t.tonic),c=s.filter(f=>f!==t.perfectFifth),u=f=>{const d=Array.from(new Set(f));return c.every(m=>d.includes(m))},l=(f,d,m)=>{const h=[];for(let g=0;d>g;g++){const y=[],b=f+r;for(let P=f;b>=P;P++){const k=t.basicBoardList[g][P];k&&y.push({key:k,string:g,fret:P})}h.push(y)}(function(g){const y=g.filter(k=>k.length>0);if(y.length===0)return[];const b=(k,S)=>{k!==y.length?y[k].forEach(v=>b(k+1,[...S,v])):P.push([...S])},P=[];return b(0,[]),P})(h).filter(g=>{const y=g.map(b=>`${b.string},${b.fret}`).join("+");return a[y]||!(b=>{const P=Array.from(new Set(b.map(k=>k.key)));return s.every(k=>P.includes(k))})(g)?0:(a[y]=1,1)}).forEach(g=>{const[y,b]=((v,w,N)=>{let[E,U]=((C,T,I)=>{var $;let x=0,O=0;const G=Math.min(...C.map(K=>K.fret));var V;I===0?G>0&&(O=G):O=G,t.options.notRequiredPerfectFifth&&I!==0&&C[C.length-1].key===t.perfectFifth&&C[C.length-2].key!==t.tonic&&!(($=t.options.requiredStrings)!=null&&$.includes(C[C.length-1].string))&&(C[C.length-1].fret=-1,C[C.length-1].key="_"),t.options.requiredStrings&&(V=[T,...C.map(K=>K.string)],t.options.requiredStrings.every(K=>V.includes(K))||(x-=8)),t.options.useHighestTensionPossible&&t.tensionNotes.length&&(t.tensionNotes.includes(C[0].key)||(x-=4));let oe=0;const ne=[];for(let K=C.length-1;K>=0;K--){if((O!==I||C[K].fret>=0&&C[K].fret!==O)&&oe++,oe>t.options.difficulty){x-=1;const X=u(ne);let ie=1;if(t.options.requiredStrings&&(ie=!t.options.requiredStrings.some(Ie=>K>=Ie)),X&&C[K].fret!==O){ie||(x-=2);const Ie=structuredClone(C);for(let se=K;se>=0;se--)Ie.shift();const $e=Ie.map(se=>`${se.string},${se.fret}`).join("+");if(!a[$e]){a[$e]=1;for(let se=K;se>=0;se--)C.shift();return x+=1,["memo",x]}}}ne.push(C[K].key)}return["memo",x]})(v,w,N);return t.options.requiredStrings&&(function(C,T){if(C.length!==T.length)return 0;for(let I=0;C.length>I;I++)if(C[I]!==T[I])return 0;return 1}([...v.map(C=>C.string),w],t.options.requiredStrings)||(U-=2)),3>v.length&&(U-=3),[U,E]})(g,d,m),P=Array(e.length).fill(void 0);P[d]=m;const k=Array(e.length).fill(void 0);k[d]=t.tonic,g.forEach(v=>{0>v.fret||(P[v.string]=v.fret,k[v.string]=v.key)});const S={positionScore:Math.round((P.reduce((v,w)=>(v||0)+(w||0),0)||0)/g.length),score:y,tab:P,notes:k,sym:P.map(v=>v!==void 0?v:"").reverse().join("|"),memo:b};i.push(S)})};for(let f=n;f>=o;f--){const d=Math.min(17,F.maxTopFret);for(let m=0;d>=m;m++){const h=t.basicBoardList[f][m];if(!h||h!==t.tonic)continue;const p=m===0&&t.options.wideUseOpenString?t.options.maxSearchRootFret:m;for(let g=0>m-r?0:m-r;p>=g;g++)l(g,f,m)}}return t.options.sortByPosition&&i.sort(t.options.sortByPosition==="low"?(f,d)=>f.positionScore-d.positionScore:(f,d)=>d.positionScore-f.positionScore),i.sort((f,d)=>d.score-f.score),{fingerings:i,notes:t.notes,tonic:t.tonic,intervals:t.intervals,tensionNotes:t.tensionNotes}}function Ur(e,t,i,n){const o={},[r,a]=t.split("/");let s="",c="";if(/^[1234567]/.test(r))o.numeratorNum=parseInt(r[0])-1,s=e.sys.note7array[o.numeratorNum];else{if(!/^[CDEFGAB]/.test(r))return new M(i,n,t,`Invalid numerator '${t}'. A degree symbol must start with one of 1-7, C-B`);s=r}if(o.numeratorNum!==void 0&&(r[1]==="#"||r[1]==="b"?(s+=r[1],o.numeratorTails=r.length>2?r.slice(2):void 0):o.numeratorTails=r.length>1?r.slice(1):void 0,s=Pe(s)+(o.numeratorTails?o.numeratorTails:"")+(r.length===1?e.diatonicEvolverValue.evolvedCodePrefix[o.numeratorNum]:"")),a){if(/^[1234567](#|b)?/.test(a))o.denominatorNum=parseInt(a[0])-1,c=e.sys.note7array[o.denominatorNum];else{if(!/^[CDEFGAB](#|b)?/.test(a))return new M(i,n,t,`Invalid denominator '${t}'. A degree symbol must start with one of 1-7, C-B[1]`);c=a}if(o.denominatorNum!==void 0){if(a[1]==="#"||a[1]==="b"){if(c+=a[1],a.length>2)return new M(i,n,t,`Invalid denominator '${t}'.`)}else if(a.length>1)return new M(i,n,t,`Invalid denominator '${t}'. A degree symbol must with one of 1-7(#|b), C-B(#|b).`);c=Pe(c)}return new R(s+"/"+c)}return new R(s)}function jr(e,t,i,n){if(/^\//.test(t))return new M(i,n,t,`Invalid symbol '${t}'. The prefix "/" cannot be used in code specifications.`);if(/%/.test(e))return new M(i,n,t,`Invalid symbol '${t}'.`);if(!/^[rCDEFGAB]/.test(e))return new M(i,n,t,`Invalid chord name '${e}'. A chord symbol must start with one of C, D, E, F, G, A, B or r rn of rest.`);if(/\//.test(e)){const o=e.split(/\//);if(o[1]&&/^[^CDEFGAB]/.test(o[1]))return new M(i,n,t,`Invalid molecule of chord name '${e}'. A molecule of chord symbol must with one of C, D, E, F, G, A, B.`)}return j()}function Dr(e,t,i,n){const o=[],r=t.split("|");if(r.length>e.length)return new M(i,n,t,`'${t}' beyond tuning. Fret designation cannot exceed the number of strings specified in tuning.`);let a=n;for(let s=0;e.length>s;s++){const c=r[s];if(c===""||c===void 0){o.unshift(void 0),a+=1;continue}if(c==="r"){o.unshift(-1),a+=2;continue}if(/\D/.test(c))return new M(i,a,c,`Invalid tab token '${c}'. Tab can only specify 'r' for frets 0 to 24 or rests.
e.g. 0|2|2|0|0|0 or 0|2 or r|r|2|2 etc..`);const u=parseInt(c);if(u>F.maxTopFret)return new M(i,a,c,`Invalid token '${c}'. Up to ${F.maxTopFret} frets can be used.`);o.unshift(u),a+=c.length+1}return new R(o)}function Rr(e,t,i,n,o,r,a,s,c){return e.flash.other.push({name:r,dualId:t,regionId:i,fullNoteIndex:n,regionNoteIndex:o,location:{line:s,linePos:c},dataStr:a}),j()}function Et(e,t,i,n,o,r,a){if(t!==0)return new M(r,a,null,"@click cannot be set on anything other than the base block.");const s=o.replace(/^@click\(\s*|^@click|\s*\)/g,""),c=e.settings;if(s==="@/click")return e.flash.click.push({stop:{regionIndex:i,noteIndex:n}}),j();if(s==="")return e.flash.click.push({start:{regionIndex:i,fullNoteIndex:n,until:e.mixesList[0].regionList[i].untilNext,inst:c.click.inst,velocity:c.click.velocity}}),j();const u=de(s,r,a);return u.fail()?u:1>u.res[0]?new M(r,-1,null,`Invalid click step value '${u.res[0]}', The entered value is outside the accepted range.`):(e.flash.click.push({start:{regionIndex:i,fullNoteIndex:n,until:u.res,inst:c.click.inst,velocity:c.click.velocity}}),j())}function Wr(e,t,i){var n,o;let r=0,a=0;const s={tabObjId:0,tickAcrossBlock:F.startTick,fullNoteIndex:0,blockNoteIndex:0,noteTotalTickInRegion:0},c=e.mixesList[t];for(let u=0;i.length>u;u++){const l=i[u];if(l.type!==B.regionStart){if(l.type===B.flash)if(l.token==="@offset")c.regionList[l.regionRegionForDualConnection].offsetTickWidth=s.noteTotalTickInRegion,c.regionList[l.regionRegionForDualConnection].flashOffsetLocation={line:l.line,linePos:l.linePos,token:l.token};else{const f=wo.resolve(e,t,l.regionRegionForDualConnection,s.fullNoteIndex,s.blockNoteIndex,l);if(f.fail())return f}else if(l.decidedProp){const f=r||l.decidedProp.styles.strum?0:{[L.normal]:l.decidedProp.styles.continue?1:0,[L.mute]:0,[L.muteContinue]:1,[L.rest]:0,[L.restNoise]:0,[L.brushing_d]:0,[L.brushing_D]:0,[L.brushing_u]:0,[L.brushing_U]:0,[L.strum]:0,[L.normalUnContinueForStep]:0,[void 0]:l.decidedProp.styles.continue?1:0}[l.decidedProp.styles.inst];r=((n=l.decidedProp.styles.slide)==null?void 0:n.type)!=="release"?0:1,a&&l.decidedProp.styles.stroke&&(l.decidedProp.styles.stroke=void 0),a=(o=l.decidedProp.styles.slide)!=null&&o.continue?1:0,Gr(e,t,e.mixesList[t].regionList[l.regionRegionForDualConnection],l,f,s)}l.type===B.closingCurlyBrace&&l.curlyLevel===1&&(c.regionList[l.regionRegionForDualConnection].endLayerTick=s.tickAcrossBlock,c.regionList[l.regionRegionForDualConnection].usedTotalTick=s.noteTotalTickInRegion,s.noteTotalTickInRegion=0,e.mixesList[t].regionList[l.regionRegionForDualConnection].end={line:l.endLine,linePos:l.endPos})}else t===0?c.regionList[l.regionRegionForDualConnection].startLayerTick===-1&&(c.regionList[l.regionRegionForDualConnection].startLayerTick=s.tickAcrossBlock):(s.tickAcrossBlock=e.mixesList[0].regionList[l.regionRegionForDualConnection].startLayerTick,c.regionList[l.regionRegionForDualConnection].startLayerTick=s.tickAcrossBlock),c.regionList[l.regionRegionForDualConnection].start={line:l.line,linePos:l.linePos},s.blockNoteIndex=0}return j()}function _r(e,t){const{flatTOList:i}=e.mixesList[t],n={},o={},r=[i.length?i[i.length-1].bar.stopTick:F.startTick];for(let a=i.length-1;a>=0;a--){const s=i[a];r.unshift(s.bar.startTick),s.styles.bpm&&s.styles.bpm.group>0&&(n[s.styles.bpm.group]||(n[s.styles.bpm.group]=1,o[s.styles.bpm.group]=s.bar.startTick),s.styles.bpm.groupEndTick=o[s.styles.bpm.group]),s.styles.turn&&s.styles.turn.group>0&&!n[s.styles.turn.group]&&(n[s.styles.turn.group]=1,s.styles.turn.groupFinal=1)}e.mixesList[t].marks.fullNoteIndexWithTick=r}function Gr(e,t,i,n,o,r){const a=i.tuning,s=e.settings.play.velocities.slice(0,a.length),c=n.decidedProp.styles.velocity;c&&s.forEach((d,m)=>s[m]*=c/100);const u=n.decidedProp.styles.velocityPerBows;u&&s.forEach((d,m)=>{u[m]!==void 0&&(s[m]*=u[m]/100)});const l={tick:we(n.decidedProp.tick.untilNext),fretStartTicks:Array(a.length).fill(void 0),fretStopTicks:Array(a.length).fill(void 0),startTick:void 0,stopTick:void 0},f={noteStr:n.decidedProp.noteStr,extendInfo:n.decidedProp.extensionViewProp,syntaxLocation:{row:"",line:n.line,linePos:n.linePos,endLine:n.endLine,endPos:n.endPos},tabObjId:r.tabObjId++,regionIndex:n.regionRegionForDualConnection,regionNoteIndex:r.blockNoteIndex,note:n.decidedProp.list,tab:n.decidedProp.fingering,trueTab:n.decidedProp.trueTab,shifted:n.decidedProp.shifted,velocity:s.map((d,m)=>n.decidedProp.fingering[m]!==void 0?d:void 0),continueX:o,styles:n.decidedProp.styles,bar:l,bpm:-1,isArpeggio:n.decidedProp.isArpeggio?1:0,isBullet:n.decidedProp.isBullet||0,refMovedSlideTarget:[],activeBows:[],refActiveBows:[],slideLandingTab:[],prevTabObj:void 0,nextTabObj:void 0,locationIndexes:n.locationInfoRefStackUpList,untilNext:n.decidedProp.tick.untilNext};n.decidedProp.styles.inst!==L.rest&&n.decidedProp.styles.inst!==L.restNoise||(f.isRest=1),e.mixesList[t].flatTOList.push(f),r.fullNoteIndex++,r.blockNoteIndex++,r.tickAcrossBlock+=l.tick,r.noteTotalTickInRegion+=l.tick}function qr(e,t,i){var n,o,r,a;const s=e.mixesList[t],c=i[t].length;for(let u=0;c>u;u++){const l=i[t][u];switch(l.type){case B.degreeName:{const f=s.regionList[l.regionRegionForDualConnection].tuning,d=Ur(l.decidedProp.styles.degree||e.settings.style.degree,l.token,l.line,l.linePos);if(d.fail())return d;if(l.token==="r")l.decidedProp.fingering=Array(f.length).fill(void 0),l.decidedProp.list=l.token,l.decidedProp.styles.inst!==L.restNoise&&(l.decidedProp.styles.inst=L.rest);else{const m={sortByPosition:"low",useHighestTensionPossible:1};(n=l.decidedProp.styles.step)!=null&&n.parsedStep&&(m.requiredStrings=[...(o=l.decidedProp.styles.step)==null?void 0:o.parsedStep.reduce((p,g)=>(g.stringIndexes&&g.stringIndexes.forEach(y=>p.add(y+1)),p),new Set)]);const h=$i.create(e.dic.chord,f,l.line,l.linePos,d.res,m);if(h.fail())return h;l.decidedProp.chordDicRef=h.res,l.decidedProp.list=h.res.symbol,l.decidedProp.fingering=h.res.fingerings[0].tab,l.decidedProp.trueTab=h.res.fingerings[0].tab}break}case B.note:{const f=s.regionList[l.regionRegionForDualConnection].tuning;if(/\|/.test(l.token)){l.decidedProp.list=l.token;const d=Dr(f,l.token,l.line,l.linePos+(l.prefixLength||0));if(d.fail())return d;l.decidedProp.fingering=d.res,l.decidedProp.trueTab=d.res}else{const d=jr(l.token,l.decidedProp.noteStr,l.line,l.linePos);if(d.fail())return d;if(l.token==="r")l.decidedProp.fingering=Array(f.length).fill(void 0),l.decidedProp.list=l.token,l.decidedProp.styles.inst!==L.restNoise&&(l.decidedProp.styles.inst=L.rest);else{const m={sortByPosition:"low",useHighestTensionPossible:1};(r=l.decidedProp.styles.step)!=null&&r.parsedStep&&(m.requiredStrings=[...(a=l.decidedProp.styles.step)==null?void 0:a.parsedStep.reduce((p,g)=>(g.stringIndexes&&g.stringIndexes.forEach(y=>p.add(y+1)),p),new Set)]);const h=$i.create(e.dic.chord,f,l.line,l.linePos,l.token,m);if(h.fail())return h;l.decidedProp.chordDicRef=h.res,l.decidedProp.list=h.res.symbol,l.decidedProp.fingering=h.res.fingerings[0].tab,l.decidedProp.trueTab=h.res.fingerings[0].tab}}break}default:continue}}return j()}function En(e,t,i=0){let n=0;for(const o of t.styles){if(/^\d+\/\d+$/.test(o)){const r=de(o,t.linesOfStyle[n],t.linePosOfStyle[n]);if(r.fail())return r;e.untilNext=r.res}else if(/^\d+$/.test(o)){if(i)return new M(t.linesOfStyle[n],t.linePosOfStyle[n],o,"Invalid Region Prop. BPM cannot be specified for dual block.");const r=Ct(o,t.linesOfStyle[n],t.linePosOfStyle[n]);if(r.fail())return r;e.bpm=r.res}else{if(!/\|/.test(o))return new M(t.linesOfStyle[n],t.linePosOfStyle[n],o,`unknown Block Property '${o}'.`);{const r=vn(o,t.linesOfStyle[n],t.linePosOfStyle[n]);if(r.fail())return r;e.tuning=r.res}}n++}return j()}function Vr(e,t,i,n,o){if(/^hash\./.test(n))return i.length>2047?new M(o,-1,null,`Invalid ${n} value '${i}'.`):new R(i);switch(t){case"tuning":return vn(i,o,-1);case"until":return de(i,o,-1);case"degree":{const r=Lt(i,o,-1);return r.fail()?new M(o,-1,null,r.message):r}case"scale":{const r=Pn(i,o,-1);return r.fail()?new M(o,-1,null,r.message):r}case"bpm":return Ct(i,o,-1);case"velocity":return Sn(i,o,-1);case"velocities":return Mn(e,i,["E","E","E","E","E","E","E","E","E"],o,-1);case"inst":case"accent":return/\D/.test(i)?new M(o,-1,null,`Invalid ${n} value '${i}'.`):new R(parseInt(i));case"pan":case"mappingNotResolved":return/^(?:true|false)$/.test(i)?new R(i==="true"?1:0):new M(o,-1,null,`Invalid ${n} value '${i}'. e.g. set.dual.pan: true`);case"panning":if(!/^\[[\d.,\s]+\]$/.test(i))return new M(o,-1,null,`Invalid ${n} value '${i}'. e.g. set.dual.panning: [0.5, 0.5, 0.5]`);try{const r=JSON.parse(i);return new R(r)}catch{return new M(o,-1,null,`Invalid ${n} value '${i}'. e.g. set.dual.panning: [0.5, 0.5, 0.5]`)}case"key":return/^[CDEFGAB](b|#)?$/.test(i)?new R(i):new M(o,-1,null,`Invalid ${n} value '${i}'. e.g. C#`);default:return new R(parseInt(i))}}function Ft(e,t){let i=t.startTick,n=1;const o=e.settings.click.accent,r=e.settings.click.until[1],a=e.settings.click.velocity/100;let s=e.settings.click.velocity/100+.3;s>1&&(s=1);const c=e.settings.click.inst;for(;t.endTick>i;)e.clickPointList.push({startTick:i,inst:c,velocity:n===o?s:a}),i+=t.untilRange,++n>r&&(n=1)}function Fn(e,t,i,n){const o=e;for(let r=t-1;r>=0;r--){const a=o[r].bar.fretStartTicks[n],s=o[r].bar.fretStopTicks[n];if(!a||i>a){if(s&&s>=i){o[r].bar.fretStopTicks[n]=i;break}}else o[r].bar.fretStartTicks[n]=void 0,o[r].bar.fretStopTicks[n]=void 0,o[r].tab[n]=void 0}}function Kr(e,t,i,n,o){let r=-1,a=-1;if(i.beforeBPM)if(i.beforeSign){if(r=t+i.beforeBPM*i.beforeSign,F.minBPM>r||r>F.maxBPM)return new xt(i.line,i.linePos,i.row||null,`Invalid BPM value '${i.row}'. bpm transitioned to an invalid value '${r}'.`)}else r=i.beforeBPM;else r=t;if(!i.afterBPM)return new xt(i.line,i.linePos,i.row||null,`Invalid BPM value '${i.row}'. SystemError.'.`);if(i.afterSign){if(a=r+i.afterBPM*i.afterSign,F.minBPM>a||a>F.maxBPM)return new xt(i.line,i.linePos,i.row||null,`Invalid BPM value '${i.row}'. bpm transitioned to an invalid value '${a}'.`)}else a=i.afterBPM;Un(e,n,o);const s=o-n,c=a-r,u=Math.abs(c)/F.bpmTransitionSpan,l=s/u,f=c/u;let d=n,m=r;for(let h=0;u>=h&&(e.push({tick:Math.floor(d),bpm:m,timeMS:-1}),d+=l,m+=f,o-1>d);h++);return e.push({tick:Math.floor(o-1),bpm:a,timeMS:-1}),j()}function Jr(e,t,i,n){if(!t.beforeBPM||t.type!==1)return new xt(-1,-1,null,"BPM SystemError.");Un(e,i,n),e.push({tick:Math.floor(i),bpm:t.beforeBPM,timeMS:-1}),e.push({tick:Math.floor(n-1),bpm:t.beforeBPM,timeMS:-1})}function Un(e,t,i){for(let n=0;e.length>n;n++)t>e[n].tick||e[n].tick>i||(e.splice(n,1),n--)}function dt(e,t,i,n){return{noteStr:"",syntaxLocation:void 0,tabObjId:t,regionIndex:e,regionNoteIndex:i,note:"",tab:Array(n).fill(void 0),velocity:Array(n).fill(void 0),continueX:0,styles:{},bar:{tick:void 0,fretStartTicks:Array(n).fill(void 0),fretStopTicks:Array(n).fill(void 0),startTick:void 0,stopTick:void 0},bpm:-1,isArpeggio:0,isBullet:0,refMovedSlideTarget:void 0,activeBows:Array(n).fill(void 0),refActiveBows:Array(n).fill(void 0),slideLandingTab:void 0,prevTabObj:void 0,nextTabObj:void 0,untilNext:void 0}}function zr(e,t,i,n,o,r){const{flatTOList:a,marks:s}=t,{settings:c}=e,u=[];for(let b=i.tuning.length-1;b>=0&&isNaN(n.tab[b]);b--)u.unshift({bowsIndex:b,thisStrumStartTick:-1});if(!u.length||u.length===i.tuning.length)return new R(0);const l=Math.floor(Tn(n.bpm,r.strumWidthMSec));let f;r.startUntil[0]>0&&(f=(n.bar.stopTick-n.bar.startTick)/r.startUntil[1]*r.startUntil[0],n.bar.fretStartTicks=n.bar.fretStartTicks.map(b=>b&&n.bar.startTick+f));let d=-1;n.bar.fretStartTicks.forEach(b=>{b&&(d=Math.max(d,b))});const m=d-l,h=l/u.length;for(let b=0;u.length>b;b++)if(u[u.length-1-b].thisStrumStartTick=Math.round(m+h*b),0>u[u.length-1-b].thisStrumStartTick)return new R(0);const p=dt(n.regionIndex,ue(n.tabObjId,.1),ue(n.regionNoteIndex,.1),i.tuning.length);u.forEach(b=>{p.tab[b.bowsIndex]=0,p.bar.fretStartTicks[b.bowsIndex]=b.thisStrumStartTick,p.bar.fretStopTicks[b.bowsIndex]=b.thisStrumStartTick+1});const g=u.map(b=>b.bowsIndex);p.velocity=Array(i.tuning.length).fill(c.play.strum.velocity).map((b,P)=>g.includes(P)?b+2*P:void 0),p.styles.inst=L.normal,p.styles.stroke={off:1},p.noteStr="#strum",n.styles.strum.t=1,a.splice(o+1,0,p),s.fullNoteIndexWithTick.splice(o+1,0,-1);const y=u[u.length-1].thisStrumStartTick;for(let b=0;9>b;b++)for(let P=o-1;P>=0;P--){const k=a[P];if(k.tab.length-1>=b&&k.bar.fretStartTicks!==void 0&&(k.bar.fretStartTicks[b]>y&&(k.tab[b]=void 0,k.bar.fretStartTicks[b]=void 0,k.bar.fretStopTicks[b]=void 0),y>k.bar.fretStartTicks[b]&&k.bar.fretStopTicks[b]>y)){k.bar.fretStopTicks[b]=y;break}}return new R(1)}function Hr(e,t,i,n,o,r){var a;const s=(a=n.styles.strum)!=null&&a.t?n.tab:n.activeBows,c=n.slideLandingTab?n.slideLandingTab:[],u=r.type==="to"?function(m,h,p){const g=[];let y=0;for(let b=0;m.length>b;b++){const P={};m[b]!==void 0&&m[b]!==h[b]&&(P.bowIndex=b,P.startFret=m[b],P.isOpenBowByStart=!P.startFret,h[b]!==void 0&&(P.landingFret=h[b],P.isOpenBowByLanding=!P.landingFret,P.slideWidth=P.landingFret-P.startFret,P.direction=P.slideWidth===0?0:0>P.slideWidth?-1:1,P.slideWidth=Math.abs(P.slideWidth),y++),g.push(P))}if(!g.length)return[];if(y){const b=g.filter(S=>S.landingFret!==void 0),P=g.filter(S=>S.slideWidth>1),k=Math.max(...P.map(S=>S.slideWidth));return b.forEach(S=>{const v=S.slideWidth-k;v&&S.slideWidth>1&&(S.slideWidth=k,S.startFret+=v*S.direction,1>S.startFret&&(S.startFret=1),S.startFret>24&&(S.startFret=24))}),b}{const b=h.filter(w=>w!==void 0);if(!b.length)return[];const P=[],k=[];if(g.forEach(w=>b.forEach(N=>{const E=N-w.startFret;E>0?P.push(E):0>E&&k.push(E)})),!P.length&&!k.length)return[];const S=P.length>k.length?1:-1,v=Math.abs(S>0?Math.max(...P):Math.min(...k));return p.continue=void 0,g.map(w=>(w.landingFret=w.startFret+v*S,w.direction=S,w.slideWidth=v,w)).filter(w=>w.landingFret>=0&&24>w.landingFret)}}(s,c,r):function(m,h,p){const g=[];if(p.releaseWidth===void 0&&!p.arrow){for(let y=0;m.length>y;y++)if(h[y]!==void 0&&m[y]!==void 0&&Math.abs(m[y]-h[y])>3){p.releaseWidth=m[y]-h[y],p.arrow=p.releaseWidth>0?1:-1,p.releaseWidth=Math.abs(p.releaseWidth);break}}if(p.releaseWidth===void 0&&!p.arrow){const y=Math.max(...m.filter(S=>!!S)),b=Math.min(...h.filter(S=>!!S)),P=Math.min(...m.filter(S=>!!S)),k=Math.max(...h.filter(S=>!!S));Math.abs(y-b)>Math.abs(P-k)?(p.releaseWidth=y-b,p.arrow=p.releaseWidth>0?1:-1,p.releaseWidth=Math.abs(p.releaseWidth)):(p.releaseWidth=k-P,p.arrow=p.releaseWidth>0?1:-1,p.releaseWidth=Math.abs(p.releaseWidth))}p.releaseWidth!==void 0||p.arrow||(p.releaseWidth=5,p.arrow=-1);for(let y=0;m.length>y;y++){const b={};if(m[y]!==void 0){if(b.startFret===0)continue;b.bowIndex=y,b.startFret=m[y],b.landingFret=b.startFret+(p.releaseWidth||9)*p.arrow,0>b.landingFret&&(b.landingFret=0),b.slideWidth=b.landingFret-b.startFret,b.direction=p.arrow,b.slideWidth=Math.abs(b.slideWidth),b.startFret!==b.landingFret&&g.push(b)}}return g}(s,c,r);if(!u.length)return n.slideTrueType=1,j();const l=Math.max(...u.map(m=>m.slideWidth));let f=[];const d={};if(l>1){const m=function(p,g,y,b){g.startableTick=Math.max(...y.map(k=>{var S;return(S=p.refActiveBows[k.bowIndex])==null?void 0:S.bar.fretStartTicks[k.bowIndex]}).filter(k=>!isNaN(k))),g.stopableTick=Math.min(p.bar.stopTick,...y.map(k=>{var S;return(S=p.refActiveBows[k.bowIndex])==null?void 0:S.bar.fretStopTicks[k.bowIndex]}).filter(k=>!isNaN(k)));const P=p.bar.startTick+p.bar.tick/b[1]*b[0];return g.startTick=g.startableTick>P?g.startableTick:P,j()}(n,d,u,r.startUntil);if(m.fail())return m;const h=function(p,g,y,b,P){const k=Math.max(...P.map(v=>v.slideWidth));let S=[];if(1>=k)return[];if(S=jn(b.startTick,b.stopableTick,k-1,y),y.auto||y.type==="release"){const v=g.bpm;if(Ge(v,Math.max(...S))>p.settings.play.slide.realization.autoStartPointAdjustmentThresholdSec)for(const w of[2,4,6,8,12,16,23,32,64,128,256,568,1024]){const N=g.bar.startTick+g.bar.tick/w*(w-1),E=jn(N,b.stopableTick,k-1,y),U=Ge(v,Math.max(...E));if(p.settings.play.slide.realization.autoStartPointAdjustmentThresholdSec>U){S=E,b.startTick=N;break}}}return S}(e,n,r,d,u);u.forEach(p=>{n.refActiveBows[p.bowIndex].bar.fretStopTicks[p.bowIndex]=d.startTick}),f=function(p,g,y,b,P){var k,S;const v=((S=(k=g.styles)==null?void 0:k.slide)==null?void 0:S.type)==="to"?{min:p.settings.play.slide.velocity.min,max:p.settings.play.slide.velocity.max,decrease:p.settings.play.slide.velocity.decrease}:{min:p.settings.play.release.velocity.min,max:p.settings.play.release.velocity.max,decrease:p.settings.play.release.velocity.decrease},w=[];let N=.001;const E=Array(g.tab.length).fill(void 0);b.flat().forEach(T=>{E[T.bowIndex]=g.refActiveBows[T.bowIndex].velocity[T.bowIndex],E[T.bowIndex]>v.max&&(E[T.bowIndex]=v.max)});let U=y.startTick;const C=Math.max(5,20*Ge(g.bpm,U-g.bar.startTick));y.attenuationVelocity=C;for(let T=0;P.length>T;T++){const I=P[T];E.forEach((x,O)=>{E[O]!==void 0&&(E[O]=Math.max(E[O]-5,v.min)-C)});const $=dt(g.regionIndex,ue(g.tabObjId,N),ue(g.regionNoteIndex,N),g.tab.length);$.styles.inst=L.normal,$.noteStr="#slide",$.slideTrueType=3,N=ue(.001,N),b.forEach(x=>{x.slideWidth>1&&($.tab[x.bowIndex]=x.startFret+(1+T)*x.direction,$.bar.fretStartTicks[x.bowIndex]=Math.floor(U),$.bar.fretStopTicks[x.bowIndex]=Math.floor(U+I))}),$.velocity=E.map((x,O)=>$.tab[O]!==void 0?x:void 0),U+=I,w.push($)}return w}(e,n,d,u,h),t.splice(o+1,0,...f),i.fullNoteIndexWithTick.splice(o+1,0,...Array(f.length).fill(-1))}return n.nextTabObj&&r.continue&&!n.nextTabObj.isRest&&u.forEach(m=>{n.nextTabObj.velocity[m.bowIndex]=Math.max(e.settings.play.slide.velocity.landing,n.nextTabObj.velocity[m.bowIndex]-l*e.settings.play.slide.velocity.decrease)-d.attenuationVelocity}),n.slideTrueType=1,j()}function jn(e,t,i,n){const o=(t-e)/i,r=n.inSpeedLevel,a=Array(i).fill(o);if(n.inSpeed&&n.inSpeed!=="mid"){for(let s=0;a.length-1>s;s++){let c=r;0>a[s]-r&&(c=a[s]/2),a[s]-=c;const u=a.length-s-1;for(let l=s+1;a.length>l;l++)a[l]+=c/u}n.inSpeed==="slow"&&a.reverse()}return a}function Zr(e,t,i,n,o,r){const a=function(p,g){const y=[];let b=0;for(let P=0;p.length>P;P++){const k={};p[P]!==void 0&&p[P]!==g[P]&&(k.bowIndex=P,k.startFret=p[P],k.isOpenBowByStart=!k.startFret,g[P]!==void 0&&(k.landingFret=g[P],k.isOpenBowByLanding=!k.landingFret,k.slideWidth=k.landingFret-k.startFret,k.direction=k.slideWidth===0?0:0>k.slideWidth?-1:1,k.slideWidth=Math.abs(k.slideWidth),b++),y.push(k))}if(!y.length)return[];if(b){const P=y.filter(v=>v.landingFret!==void 0),k=y.filter(v=>v.slideWidth>1),S=Math.max(...k.map(v=>v.slideWidth));return P.forEach(v=>{const w=v.slideWidth-S;w&&v.slideWidth>1&&(v.slideWidth=S,v.startFret+=w*v.direction,1>v.startFret&&(v.startFret=1),v.startFret>24&&(v.startFret=24))}),P}{const P=g.filter(N=>N!==void 0);if(!P.length)return[];const k=[],S=[];if(y.forEach(N=>P.forEach(E=>{const U=E-N.startFret;U>0?k.push(U):0>U&&S.push(U)})),!k.length&&!S.length)return[];const v=k.length>S.length?1:-1,w=Math.abs(v>0?Math.max(...k):Math.min(...S));return y.map(N=>(N.landingFret=N.startFret+w*v,N.direction=v,N.slideWidth=w,N)).filter(N=>N.landingFret>=0&&24>N.landingFret)}}(r.bowWithFret,n.tab);if(!a.length)return n.slideTrueType=2,j();const s=Math.max(...a.map(p=>p.slideWidth)),c={},u=function(p,g,y){g.startableTick=Math.max(...y.map(P=>{var k;return(k=p.refActiveBows[P.bowIndex])==null?void 0:k.bar.fretStartTicks[P.bowIndex]}).filter(P=>!isNaN(P))),g.stopableTick=Math.min(...y.map(P=>{var k;return(k=p.refActiveBows[P.bowIndex])==null?void 0:k.bar.fretStopTicks[P.bowIndex]}).filter(P=>!isNaN(P)));const b=p.bar.startTick+p.bar.tick/1*0;return g.startTick=g.startableTick>b?g.startableTick:b,j()}(n,c,a);if(u.fail())return u;const{baseTick:l,maxSplitTick:f}=function(p,g,y){let b=p.settings.play.approach.widthOfSlide.baseTick,P=p.settings.play.approach.widthOfSlide.maxSplitTick;if(y){const k=y/100;b*=k,P*=k}return b>g.stopableTick-g.startableTick&&(b=g.stopableTick-g.startableTick),{baseTick:b,maxSplitTick:P}}(e,c,r.percentOfSpeed||0);let d=l/s;d>f&&(d=f);const{slideTabObjList:m,landingVelocity:h}=function(p,g,y,b,P,k){const S={min:p.settings.play.approach.velocity.min,max:p.settings.play.approach.velocity.max,decrease:p.settings.play.approach.velocity.decrease,minLanding:p.settings.play.approach.velocity.minLanding},v=[];let w=-.001;const N=p.settings.play.approach.velocity.decrease,E=p.settings.play.approach.velocity.min;let U=0;const C=b.map($=>$.bowIndex);let T=y.startTick;for(let $=0;k>$;$++){const x=dt(g.regionIndex,ue(g.tabObjId,w),ue(g.regionNoteIndex,w),g.tab.length);x.velocity=g.velocity.map((O,G)=>C.includes(G)?O:void 0),x.styles.inst=L.normal,x.noteStr="#approach",x.slideTrueType=4,w=ue(-.001,w),b.forEach(O=>{if((O.slideWidth>1||$===0)&&($===0?(x.tab[O.bowIndex]=O.startFret+$*O.direction,x.bar.fretStartTicks[O.bowIndex]=g.bar.fretStartTicks[O.bowIndex]!==void 0?g.bar.fretStartTicks[O.bowIndex]:g.bar.fretStartTicks.find(G=>G!==void 0)):(x.tab[O.bowIndex]=O.startFret+$*O.direction,x.bar.fretStartTicks[O.bowIndex]=Math.floor(T)),x.bar.fretStopTicks[O.bowIndex]=Math.floor(T+P)),U){x.velocity[O.bowIndex]>p.settings.play.approach.velocity.max&&(x.velocity[O.bowIndex]=p.settings.play.approach.velocity.max);const G=x.velocity[O.bowIndex],V=G-G*(U/100);x.velocity[O.bowIndex]=V>E?V:E}}),T+=P,U+=N,v.push(x)}const I=structuredClone(g.velocity);return b.forEach($=>{I[$.bowIndex]>p.settings.play.approach.velocity.max&&(I[$.bowIndex]=p.settings.play.approach.velocity.max);const x=I[$.bowIndex],O=x-x*(U/100);I[$.bowIndex]=O>S.minLanding?O:S.minLanding}),{slideTabObjList:v,landingVelocity:I}}(e,n,c,a,d,s);return t.splice(o,0,...m),i.fullNoteIndexWithTick.splice(o,0,...Array(m.length).fill(-1)),n.velocity=h,n.slideTrueType=2,a.forEach(p=>{n.bar.fretStartTicks[p.bowIndex]!==void 0&&(n.bar.fretStartTicks[p.bowIndex]=n.bar.fretStartTicks[p.bowIndex]+d*s)}),j()}function Me(e){return 10*jo*e}function Ut(e){return e>8191?8191:-8191>e?-8191:Math.floor(e)}function jt(e,t,i,n,o,r=0){const a=i-t,s=r?a:a/2;if(s===0)return[];const c=Me(n),u=Me(o)-c;for(let l=0;s>=l;l+=F.bendSeparateTick)e.push({pitch:Ut(c+Math.ceil((Math.sin(l/a*2*Math.PI-Math.PI/2)+1)/2*u)),tick:t+(r?l:2*l)});return e}function Ve(e,t,i,n,o,r=0){if(r){const a=i-t;return Ve(e,t,t+a/2-1,n,o),void Ve(e,t+a/2,i,o,n)}o>n?function(a,s,c,u,l){const f=c-s;if(!f)return[];const d=Me(u),m=Me(l)-d;for(let h=0;f>=h;h+=F.bendSeparateTick)a.push({tick:h+s,pitch:Ut(d+m/(f*f)*h*h)})}(e,t,i,n,o):function(a,s,c,u,l){const f=u,d=c-s,m=Me(l),h=Math.floor(Me(f))-m;if(h===0)return[];for(let p=0;d>=p;p+=F.bendSeparateTick){const g=d-p;a.push({tick:p+s,pitch:Ut(m+h/(d*d)*g*g)})}}(e,t,i,n,o)}function Xr(e,t,i){const n={specifiedPitch:0,untilStep:0},o={view:[],bend:[]};let r=0;const a=t.styles.inst===void 0||t.styles.inst===L.normal?0:1;for(let s=0;i.length>s;s++){const c=i[s],u=Yr(n,t,c,o);if(u.fail())return u;if(n.untilStep=c.untilRange[0],u.res.length&&(e.bendChannelList.push({bend:u.res,hasMute:a,tabObjId:t.tabObjId}),o.bend.push(u.res),t.continueX)){const l=[];u.res.forEach((f,d)=>{f.pitch>0||(u.res.length-1>d&&u.res[d+1].pitch>0?l.push({tick:f.tick,pitch:0}):t.styles.legato||(r=1,l.push(f)))}),l.length&&e.bendNormalList.push({bend:l,hasMute:a,tabObjId:t.tabObjId})}}if(r){const s=Math.max(...t.bar.fretStopTicks.map(c=>c!==void 0?c:-1));0>s||e.bendNormalList.push({bend:[{tick:s,pitch:0}],hasMute:a,tabObjId:t.tabObjId})}return j()}function Yr(e,t,i,n){return i.method===void 0?function(o,r,a,s){const c=[],u=function(l,f){const d=we([1,f[2]]);let m=l.bar.startTick+d*f[0],h=-1;f[1]===-1?h=l.bar.stopTick:f[1]===-2?(m=l.bar.stopTick,h=l.bar.stopTick):h=l.bar.startTick+d*f[1];let p=Math.max(...l.bar.fretStartTicks.map(y=>y!==void 0?y:-1)),g=l.bar.fretStopTicks.filter(y=>y!==void 0).length?Math.min(...l.bar.fretStopTicks.filter(y=>y!==void 0)):-1;return p!==-1&&g>p||(p=l.bar.startTick,g=l.bar.stopTick),p>h||m>g?new R(void 0):(h>g&&(h=g),p>m&&(m=p),new R({startTick:m,stopTick:h}))}(r,a.untilRange);return u.fail()?u:(u.res!==void 0&&(u.res.startTick===u.res.stopTick?(c.push({tick:u.res.startTick-1,pitch:Me(o.specifiedPitch)}),c.push({tick:u.res.startTick,pitch:Me(a.pitch)})):a.curve!==Ue.ast?jt(c,u.res.startTick,u.res.stopTick,o.specifiedPitch,a.pitch):Ve(c,u.res.startTick,u.res.stopTick,o.specifiedPitch,a.pitch),s.view.push({startTick:u.res.startTick,stopTick:u.res.stopTick,row:a.row,line:a.line,linePos:a.linePos})),o.specifiedPitch=a.pitch,new R(c))}(e,t,i,n):(i.pitch===void 0&&(i.pitch=e.specifiedPitch===0?.3:e.specifiedPitch>0?e.specifiedPitch-.3:e.specifiedPitch+.3),function(r,a,s,c){const u=[];let l=0;if(s.untilRange[1]===-1){const f=we([1,s.untilRange[2]]);s.untilRange[1]=a.bar.tick/f}for(let f=s.untilRange[0];s.untilRange[1]>f;f++){const d=Qr(a,[f,f+1,s.untilRange[2]]);if(d.fail())return d;d.res!==void 0&&(l?s.curve!==Ue.ast?jt(u,d.res.startTick,d.res.stopTick,s.pitch,r.specifiedPitch):Ve(u,d.res.startTick,d.res.stopTick,s.pitch,r.specifiedPitch):s.curve!==Ue.ast?jt(u,d.res.startTick,d.res.stopTick,r.specifiedPitch,s.pitch):Ve(u,d.res.startTick,d.res.stopTick,r.specifiedPitch,s.pitch),c.view.push({startTick:d.res.startTick,stopTick:d.res.stopTick,row:s.row,line:s.line,linePos:s.linePos}),l=l?0:1)}return r.specifiedPitch=l?s.pitch:r.specifiedPitch,new R(u)}(e,t,i,n))}function Qr(e,t){const i=we([1,t[2]]);let n=e.bar.startTick+i*t[0],o=-1;o=t[1]===-1?e.bar.stopTick:e.bar.startTick+i*t[1];let r=Math.max(...e.bar.fretStartTicks.map(s=>s!==void 0?s:-1)),a=e.bar.fretStopTicks.filter(s=>s!==void 0).length?Math.min(...e.bar.fretStopTicks.filter(s=>s!==void 0)):-1;return r!==-1&&a>r||(r=e.bar.startTick,a=e.bar.stopTick),r>o||n>a?new R(void 0):(o>a&&(o=a),r>n&&(n=r),new R({startTick:n,stopTick:o}))}function Dn(e,t,i){const n=function(a){const s=a[0].regionIndex;for(let c=1;a.length>c;c++){const u=a[c];if(s!==u.regionIndex)return new M(u.syntaxLocation.line,u.syntaxLocation.linePos,null,`Invalid legato place '${u.noteStr}'. Legato cannot be applied across regions.`)}return j()}(t);if(n.fail())return n;const o=function(a,s,c){const{flatTOList:u,marks:l}=a,f=[],d=[],m=s[0].tab,h=s[1].tab;for(let p=0;m.length>p;p++){const g=m[p],y=h[p];if(g===void 0||0>g){if(y!==void 0&&y>=0)return new R(-1);f.push(void 0),d.push(void 0)}else y===void 0||0>y?(d.push(void 0),f.push(g)):(d.push(g),f.push(void 0))}if(f.find(p=>p!==void 0)!==void 0){const p=s[s.length-1].bar.stopTick,g=dt(s[0].regionIndex,s[0].tabObjId,s[0].regionNoteIndex,s[0].tab.length);g.bar=structuredClone(s[0].bar),g.syntaxLocation=structuredClone(s[0].syntaxLocation),g.velocity=structuredClone(s[0].velocity),g.styles=s[0].styles,u[c+1].prevTabObj=u[c],c>0&&(u[c].prevTabObj=u[c-1]),u.splice(c,0,g),l.fullNoteIndexWithTick.splice(c,0,l.fullNoteIndexWithTick[c]),u[c].regionNoteIndex=-1,u[c].tab=f,u[c].continueX&&(u[c].bar.stopTick=p,u[c].bar.fretStopTicks.forEach((y,b)=>{u[c].bar.fretStopTicks[b]!==void 0&&(u[c].bar.fretStopTicks[b]=p)})),u[c+1].tab=d,u[c+1].tabObjId+=.1,u[c+1].styles.stroke={off:1},s[0]=u[c+1],c++}return new R(c)}(e,t,i);if(o.fail())return o;if(o.res===-1)return Rn(e,t,i),j();const r=function(a){var s;let c="";for(let g=0;a.length>g;g++)if(g===0)c=JSON.stringify(a[0].tab.map(y=>y!==void 0?1:0));else if(c!==JSON.stringify(a[g].tab.map(y=>y!==void 0?1:0)))return new R(void 0);const u=[];let l=-1;for(let g=0;a[0].tab.length>g;g++)if(u.length)for(let y=1;a.length>y;y++){const b=a[y-1].tab[g],P=a[y].tab[g];if(b!==void 0&&P!==void 0&&u[y-1]!==b-P)return new R(void 0)}else{l=g;for(let y=1;a.length>y;y++){const b=a[y-1].tab[g],P=a[y].tab[g];b!==void 0&&P!==void 0&&u.push(b-P)}}const f=[];for(let g=0;a.length>g;g++)f.push(a[g].tab[l]);const d=Math.min(...f),m=Math.max(...f);if(m-d>4)return new R(void 0);const h=f.map(g=>g===m?2:g===m-1?1:g===m-2?0:g===m-3?-1:-2),p=a[a.length-1].bar.stopTick;h[0]!==0&&(a[0].tabShift=-h[0]),a[0].styles.bd=[{untilRange:[0,0,16],pitch:h[0],isLegato:1}],a[0].bar.stopTick=p,a[0].bar.fretStopTicks.forEach((g,y)=>{a[0].bar.fretStopTicks[y]!==void 0&&(a[0].bar.fretStopTicks[y]=p)});for(let g=1;a.length>g;g++)a[g].continueX=1,a[g].tab=Array(a[g].tab.length).fill(void 0),a[g].styles.bd=[{untilRange:[0,0,16],pitch:h[g],isLegato:1}];return(s=a[a.length-1].styles.bd)==null||s.push({untilRange:[-2,-2,1],pitch:0,isLegato:1}),new R("success")}(t);return r.fail()?r:(r.res===void 0&&Rn(e,t,o.res),j())}function Rn(e,t,i){const{flatTOList:n}=e,o=n[i],r=Math.round(700*Ge(o.bpm,o.bar.tick));for(let a=1;t.length>a;a++)t[a].velocity=t[a].velocity.map(s=>s!==void 0?Math.max(55,s-r):void 0)}function eo(e){var t,i;return e.i?e:(typeof(t=e.default)=="function"?(i=function n(){return this instanceof n?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)},i.prototype=t.prototype):i={},Object.defineProperty(i,"i",{value:1}),Object.keys(e).forEach(function(n){var o=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(i,n,o.get?o:{enumerable:1,get:function(){return e[n]}})}),i)}function to(e){function t(){var a,s,c,u,l,f,d,m={};if(m.deltaTime=o.readVarInt(),240&~(a=o.readUInt8())){if(128&a)l=o.readUInt8(),n=a;else{if(n===null)throw"Running status byte encountered before status byte";l=a,a=n,m.running=1}switch(f=a>>4,m.channel=15&a,f){case 8:return m.type="noteOff",m.noteNumber=l,m.velocity=o.readUInt8(),m;case 9:return d=o.readUInt8(),m.type=d===0?"noteOff":"noteOn",m.noteNumber=l,m.velocity=d,d===0&&(m.byte9=1),m;case 10:return m.type="noteAftertouch",m.noteNumber=l,m.amount=o.readUInt8(),m;case 11:return m.type="controller",m.controllerType=l,m.value=o.readUInt8(),m;case 12:return m.type="programChange",m.programNumber=l,m;case 13:return m.type="channelAftertouch",m.amount=l,m;case 14:return m.type="pitchBend",m.value=l+(o.readUInt8()<<7)-8192,m;default:throw"Unrecognised MIDI event type: "+f}}else{if(a!==255){if(a==240)return m.type="sysEx",c=o.readVarInt(),m.data=o.readBytes(c),m;if(a==247)return m.type="endSysEx",c=o.readVarInt(),m.data=o.readBytes(c),m;throw"Unrecognised MIDI event type byte: "+a}switch(m.meta=1,s=o.readUInt8(),c=o.readVarInt(),s){case 0:if(m.type="sequenceNumber",c!==2)throw"Expected length for sequenceNumber event is 2, got "+c;return m.number=o.readUInt16(),m;case 1:return m.type="text",m.text=o.readString(c),m;case 2:return m.type="copyrightNotice",m.text=o.readString(c),m;case 3:return m.type="trackName",m.text=o.readString(c),m;case 4:return m.type="instrumentName",m.text=o.readString(c),m;case 5:return m.type="lyrics",m.text=o.readString(c),m;case 6:return m.type="marker",m.text=o.readString(c),m;case 7:return m.type="cuePoint",m.text=o.readString(c),m;case 32:if(m.type="channelPrefix",c!=1)throw"Expected length for channelPrefix event is 1, got "+c;return m.channel=o.readUInt8(),m;case 33:if(m.type="portPrefix",c!=1)throw"Expected length for portPrefix event is 1, got "+c;return m.port=o.readUInt8(),m;case 47:if(m.type="endOfTrack",c!=0)throw"Expected length for endOfTrack event is 0, got "+c;return m;case 81:if(m.type="setTempo",c!=3)throw"Expected length for setTempo event is 3, got "+c;return m.microsecondsPerBeat=o.readUInt24(),m;case 84:if(m.type="smpteOffset",c!=5)throw"Expected length for smpteOffset event is 5, got "+c;return u=o.readUInt8(),m.frameRate={0:24,32:25,64:29,96:30}[96&u],m.hour=31&u,m.min=o.readUInt8(),m.sec=o.readUInt8(),m.frame=o.readUInt8(),m.subFrame=o.readUInt8(),m;case 88:if(m.type="timeSignature",c!=2&&c!=4)throw"Expected length for timeSignature event is 4 or 2, got "+c;return m.numerator=o.readUInt8(),m.denominator=1<<o.readUInt8(),c===4?(m.metronome=o.readUInt8(),m.thirtyseconds=o.readUInt8()):(m.metronome=36,m.thirtyseconds=8),m;case 89:if(m.type="keySignature",c!=2)throw"Expected length for keySignature event is 2, got "+c;return m.key=o.readInt8(),m.scale=o.readUInt8(),m;case 127:return m.type="sequencerSpecific",m.data=o.readBytes(c),m;default:return m.type="unknownMeta",m.data=o.readBytes(c),m.metatypeByte=s,m}}}for(var i,n,o=new Y(e),r=[];!o.eof();)i=t(),r.push(i);return r}function Y(e){this.buffer=e,this.bufferLen=this.buffer.length,this.pos=0}function no(e,t,i){var n,o=new Q,r=t.length,a=null;for(n=0;r>n;n++)i.running!=0&&(i.running||t[n].running)||(a=null),a=io(o,t[n],a,i.useByte9ForNoteOff);e.writeChunk("MTrk",o.buffer)}function io(e,t,i,n){var o,r,a=t.type,s=t.text||"",c=t.data||[],u=null;switch(e.writeVarInt(t.deltaTime),a){case"sequenceNumber":e.writeUInt8(255),e.writeUInt8(0),e.writeVarInt(2),e.writeUInt16(t.number);break;case"text":e.writeUInt8(255),e.writeUInt8(1),e.writeVarInt(s.length),e.writeString(s);break;case"copyrightNotice":e.writeUInt8(255),e.writeUInt8(2),e.writeVarInt(s.length),e.writeString(s);break;case"trackName":e.writeUInt8(255),e.writeUInt8(3),e.writeVarInt(s.length),e.writeString(s);break;case"instrumentName":e.writeUInt8(255),e.writeUInt8(4),e.writeVarInt(s.length),e.writeString(s);break;case"lyrics":e.writeUInt8(255),e.writeUInt8(5),e.writeVarInt(s.length),e.writeString(s);break;case"marker":e.writeUInt8(255),e.writeUInt8(6),e.writeVarInt(s.length),e.writeString(s);break;case"cuePoint":e.writeUInt8(255),e.writeUInt8(7),e.writeVarInt(s.length),e.writeString(s);break;case"channelPrefix":e.writeUInt8(255),e.writeUInt8(32),e.writeVarInt(1),e.writeUInt8(t.channel);break;case"portPrefix":e.writeUInt8(255),e.writeUInt8(33),e.writeVarInt(1),e.writeUInt8(t.port);break;case"endOfTrack":e.writeUInt8(255),e.writeUInt8(47),e.writeVarInt(0);break;case"setTempo":e.writeUInt8(255),e.writeUInt8(81),e.writeVarInt(3),e.writeUInt24(t.microsecondsPerBeat);break;case"smpteOffset":e.writeUInt8(255),e.writeUInt8(84),e.writeVarInt(5),e.writeUInt8(31&t.hour|{24:0,25:32,29:64,30:96}[t.frameRate]),e.writeUInt8(t.min),e.writeUInt8(t.sec),e.writeUInt8(t.frame),e.writeUInt8(t.subFrame);break;case"timeSignature":e.writeUInt8(255),e.writeUInt8(88),e.writeVarInt(4),e.writeUInt8(t.numerator),e.writeUInt8(255&Math.floor(Math.log(t.denominator)/Math.LN2)),e.writeUInt8(t.metronome),e.writeUInt8(t.thirtyseconds||8);break;case"keySignature":e.writeUInt8(255),e.writeUInt8(89),e.writeVarInt(2),e.writeInt8(t.key),e.writeUInt8(t.scale);break;case"sequencerSpecific":e.writeUInt8(255),e.writeUInt8(127),e.writeVarInt(c.length),e.writeBytes(c);break;case"unknownMeta":t.metatypeByte!=null&&(e.writeUInt8(255),e.writeUInt8(t.metatypeByte),e.writeVarInt(c.length),e.writeBytes(c));break;case"sysEx":e.writeUInt8(240),e.writeVarInt(c.length),e.writeBytes(c);break;case"endSysEx":e.writeUInt8(247),e.writeVarInt(c.length),e.writeBytes(c);break;case"noteOff":(u=(n!=0&&t.byte9||n&&t.velocity==0?144:128)|t.channel)!==i&&e.writeUInt8(u),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteOn":(u=144|t.channel)!==i&&e.writeUInt8(u),e.writeUInt8(t.noteNumber),e.writeUInt8(t.velocity);break;case"noteAftertouch":(u=160|t.channel)!==i&&e.writeUInt8(u),e.writeUInt8(t.noteNumber),e.writeUInt8(t.amount);break;case"controller":(u=176|t.channel)!==i&&e.writeUInt8(u),e.writeUInt8(t.controllerType),e.writeUInt8(t.value);break;case"programChange":(u=192|t.channel)!==i&&e.writeUInt8(u),e.writeUInt8(t.programNumber);break;case"channelAftertouch":(u=208|t.channel)!==i&&e.writeUInt8(u),e.writeUInt8(t.amount);break;case"pitchBend":(u=224|t.channel)!==i&&e.writeUInt8(u),r=(o=8192+t.value)>>7&127,e.writeUInt8(127&o),e.writeUInt8(r);break;default:throw"Unrecognized event type: "+a}return u}function Q(){this.buffer=[]}function Wn(e,t,i){var n,o,r,a,s,c,u;if(i===void 0&&(i="ticks"),n=0,r=o=e.length,o>0&&t>=e[o-1][i])return o-1;for(;r>n;){if(c=e[(a=Math.floor(n+(r-n)/2))+1],(s=e[a])[i]===t){for(u=a;e.length>u;u++)e[u][i]===t&&(a=u);return a}if(t>s[i]&&c[i]>t)return a;s[i]>t?r=a:t>s[i]&&(n=a+1)}return-1}function _n(e){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][e%12]}function Gn(e,t){var i,n;for(i=0;e.length>i;i++)Array.isArray(n=e[i])?Gn(n,t):t.push(n)}function ro(e,t){return{absoluteTime:e.ticks,channel:t,controllerType:e.number,deltaTime:0,type:"controller",value:Math.floor(127*e.value)}}function oo(e){return{absoluteTime:0,channel:e.channel,deltaTime:0,programNumber:e.instrument.number,type:"programChange"}}function so(e,t=0){const i=(e===L.normal||e===L.normalUnContinueForStep?0:1)+(t?2:0);return{[L.normal]:{midiInst:i,vel:0},[L.mute]:{midiInst:i,vel:-.3},[L.muteContinue]:{midiInst:i,vel:-.3},[L.rest]:{midiInst:i,vel:0},[L.restNoise]:{midiInst:i,vel:.28,duration:1},[L.brushing_d]:{midiInst:i,vel:-.4,duration:1},[L.brushing_D]:{midiInst:i,vel:-.25,duration:1},[L.brushing_u]:{midiInst:i,vel:-.4,duration:1},[L.brushing_U]:{midiInst:i,vel:-.25,duration:1},[L.strum]:{midiInst:i,vel:-.25,duration:1},[L.normalUnContinueForStep]:{midiInst:i,vel:0}}[e]}var Le,me,ft,mt,pt,ht,qn,pe,_,gt,he,Dt,Rt,Vn,Z,J,Kn,Jn,zn,Wt,re,W,Hn,yt,A,q,te,B,Se,le,Ke,Zn,_t,Xn,Gt,bt,Yn,qt,Vt,Kt,Jt,zt,Ht,Qn,ei,ti,ni,ii,kt,Be,Zt,Xt,ri,oi,si,Yt,ai,ci,li,Qt,Ee,Je,vt,Ne,en,ze,ui,di,He,Oe,Fe,tn,Pt,Ze,wt,Mt,fi,Xe,Te,Ye,nn,mi,St,pi,Ae,hi,Tt,gi,yi,bi,rn,ki,Qe,vi,et,ge,Pi,wi,Mi,Si,Ti,L=(e=>(e.normal="normal",e.mute="mute",e.muteContinue="muteContinue",e.rest="rest",e.restNoise="restNoise",e.brushing_d="brushing_d",e.brushing_D="brushing_D",e.brushing_u="brushing_u",e.brushing_U="brushing_U",e.strum="strum",e.normalUnContinueForStep="normalUnContinueForStep",e))(L||{}),on=(e=>(e[e.vib=0]="vib",e))(on||{}),Ue=(e=>(e[e.ast=0]="ast",e[e.tri=1]="tri",e))(Ue||{}),ao=(e=>(e[e.vib=0]="vib",e[e.cho=1]="cho",e[e.end=2]="end",e))(ao||{}),co=(e=>(e[e.fast=0]="fast",e[e.slow=1]="slow",e[e.auto=2]="auto",e))(co||{}),xe=(e=>(e[e.rev=0]="rev",e[e.ss=1]="ss",e[e.sos=2]="sos",e[e.nos=3]="nos",e))(xe||{});const lo=Object.keys(xe).filter(e=>isNaN(+e)&&!isNaN(xe[e])),F={dualJoiner:">>",dualLength:3,basicTick:480,PPS:1920,startTick:480,bpmTransitionSpan:2,maxUntilNext0:128,maxUntilNext1:128,minBPM:1,maxBPM:1e3,maxTopFret:24,maxBows:9,maxApproachPercent:500,maxStrumWidthMSec:100,maxSuffixExtensionLength:16,bendSeparateTick:10,bendMaxFixedUntilDenom:128,maxMappedStepOrder:1e3},ye={iKey:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],iKey32material:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B","C","C#","D","D#","E","F","F#","G","G#","A","A#","B","C","C#","D","D#","E","F","F#","G","G#","A","A#","B"]};me=1e9,ft="0123456789abcdef",ht={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-(Le=9e15),maxE:Le,crypto:0},_=1,he=(gt="[DecimalError] ")+"Invalid argument: ",Dt=gt+"Precision limit exceeded",Rt=gt+"crypto unavailable",Z=Math.floor,J=Math.pow,Kn=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,Jn=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,zn=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Wt=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,re=1e7,W=7,Hn=(mt="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058").length-1,yt=(pt="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789").length-1,(A={toStringTag:Vn="[object Decimal]"}).absoluteValue=A.abs=function(){var e=new this.constructor(this);return 0>e.s&&(e.s=1),D(e)},A.ceil=function(){return D(new this.constructor(this),this.e+1,2)},A.clampedTo=A.clamp=function(e,t){var i=this,n=i.constructor;if(e=new n(e),t=new n(t),!e.s||!t.s)return new n(NaN);if(e.gt(t))throw Error(he+t);return 0>i.cmp(e)?e:i.cmp(t)>0?t:new n(i)},A.comparedTo=A.cmp=function(e){var t,i,n,o,r=this,a=r.d,s=(e=new r.constructor(e)).d,c=r.s,u=e.s;if(!a||!s)return c&&u?c!==u?c:a===s?0:!a^0>c?1:-1:NaN;if(!a[0]||!s[0])return a[0]?c:s[0]?-u:0;if(c!==u)return c;if(r.e!==e.e)return r.e>e.e^0>c?1:-1;for(t=0,i=(o=s.length)>(n=a.length)?n:o;i>t;++t)if(a[t]!==s[t])return a[t]>s[t]^0>c?1:-1;return n===o?0:n>o^0>c?1:-1},A.cosine=A.cos=function(){var e,t,i=this,n=i.constructor;return i.d?i.d[0]?(t=n.rounding,n.precision=(e=n.precision)+Math.max(i.e,i.sd())+W,n.rounding=1,i=function(o,r){var a,s,c,u,l;if(r.isZero())return r;for(32>(s=r.d.length)?c=""+1/st(4,a=Math.ceil(s/3)):(a=16,c="2.3283064365386962890625e-10"),o.precision+=a,r=Ce(o,1,r.times(c),new o(1)),u=a;u--;)l=r.times(r),r=l.times(l).minus(l).times(8).plus(1);return o.precision-=a,r}(n,mn(n,i)),n.precision=e,n.rounding=t,D(pe==2||pe==3?i.neg():i,e,t,1)):new n(1):new n(NaN)},A.cubeRoot=A.cbrt=function(){var e,t,i,n,o,r,a,s,c,u,l=this,f=l.constructor;if(!l.isFinite()||l.isZero())return new f(l);for(_=0,(r=l.s*J(l.s*l,1/3))&&Math.abs(r)!=1/0?n=new f(""+r):(i=H(l.d),(r=((e=l.e)-i.length+1)%3)&&(i+=r==1||r==-2?"0":"00"),r=J(i,1/3),e=Z((e+1)/3)-(e%3==(0>e?-1:2)),(n=new f(i=r==1/0?"5e"+e:(i=r.toExponential()).slice(0,i.indexOf("e")+1)+e)).s=l.s),a=(e=f.precision)+3;;)if(u=(c=(s=n).times(s).times(s)).plus(l),n=q(u.plus(l).times(s),u.plus(c),a+2,1),H(s.d).slice(0,a)===(i=H(n.d)).slice(0,a)){if((i=i.slice(a-3,a+1))!="9999"&&(o||i!="4999")){+i&&(+i.slice(1)||i.charAt(0)!="5")||(D(n,e+1,1),t=!n.times(n).times(n).eq(l));break}if(!o&&(D(s,e+1,0),s.times(s).times(s).eq(l))){n=s;break}a+=4,o=1}return _=1,D(n,e,f.rounding,t)},A.decimalPlaces=A.dp=function(){var e,t=this.d,i=NaN;if(t){if(i=((e=t.length-1)-Z(this.e/W))*W,e=t[e])for(;e%10==0;e/=10)i--;0>i&&(i=0)}return i},A.dividedBy=A.div=function(e){return q(this,new this.constructor(e))},A.dividedToIntegerBy=A.divToInt=function(e){var t=this.constructor;return D(q(this,new t(e),0,1,1),t.precision,t.rounding)},A.equals=A.eq=function(e){return this.cmp(e)===0},A.floor=function(){return D(new this.constructor(this),this.e+1,3)},A.greaterThan=A.gt=function(e){return this.cmp(e)>0},A.greaterThanOrEqualTo=A.gte=function(e){var t=this.cmp(e);return t==1||t===0},A.hyperbolicCosine=A.cosh=function(){var e,t,i,n,o,r,a,s,c=this,u=c.constructor,l=new u(1);if(!c.isFinite())return new u(c.s?1/0:NaN);if(c.isZero())return l;for(n=u.rounding,u.precision=(i=u.precision)+Math.max(c.e,c.sd())+4,u.rounding=1,32>(o=c.d.length)?t=""+1/st(4,e=Math.ceil(o/3)):(e=16,t="2.3283064365386962890625e-10"),c=Ce(u,1,c.times(t),new u(1),1),a=e,s=new u(8);a--;)r=c.times(c),c=l.minus(r.times(s.minus(r.times(s))));return D(c,u.precision=i,u.rounding=n,1)},A.hyperbolicSine=A.sinh=function(){var e,t,i,n,o,r,a,s,c=this,u=c.constructor;if(!c.isFinite()||c.isZero())return new u(c);if(i=u.rounding,u.precision=(t=u.precision)+Math.max(c.e,c.sd())+4,u.rounding=1,3>(n=c.d.length))c=Ce(u,2,c,c,1);else for(c=Ce(u,2,c=c.times(1/st(5,e=(e=1.4*Math.sqrt(n))>16?16:0|e)),c,1),r=new u(5),a=new u(16),s=new u(20);e--;)o=c.times(c),c=c.times(r.plus(o.times(a.times(o).plus(s))));return u.precision=t,u.rounding=i,D(c,t,i,1)},A.hyperbolicTangent=A.tanh=function(){var e,t,i=this,n=i.constructor;return i.isFinite()?i.isZero()?new n(i):(t=n.rounding,n.precision=(e=n.precision)+7,n.rounding=1,q(i.sinh(),i.cosh(),n.precision=e,n.rounding=t)):new n(i.s)},A.inverseCosine=A.acos=function(){var e,t=this,i=t.constructor,n=t.abs().cmp(1),o=i.precision,r=i.rounding;return n!==-1?n===0?t.isNeg()?ae(i,o,r):new i(0):new i(NaN):t.isZero()?ae(i,o+4,r).times(.5):(i.precision=o+6,i.rounding=1,t=t.asin(),e=ae(i,o+4,r).times(.5),i.precision=o,i.rounding=r,e.minus(t))},A.inverseHyperbolicCosine=A.acosh=function(){var e,t,i=this,n=i.constructor;return i.lte(1)?new n(i.eq(1)?0:NaN):i.isFinite()?(t=n.rounding,n.precision=(e=n.precision)+Math.max(Math.abs(i.e),i.sd())+4,n.rounding=1,_=0,i=i.times(i).minus(1).sqrt().plus(i),_=1,n.precision=e,n.rounding=t,i.ln()):new n(i)},A.inverseHyperbolicSine=A.asinh=function(){var e,t,i=this,n=i.constructor;return!i.isFinite()||i.isZero()?new n(i):(t=n.rounding,n.precision=(e=n.precision)+2*Math.max(Math.abs(i.e),i.sd())+6,n.rounding=1,_=0,i=i.times(i).plus(1).sqrt().plus(i),_=1,n.precision=e,n.rounding=t,i.ln())},A.inverseHyperbolicTangent=A.atanh=function(){var e,t,i,n,o=this,r=o.constructor;return o.isFinite()?0>o.e?(e=r.precision,t=r.rounding,n=o.sd(),2*-o.e-1>Math.max(n,e)?D(new r(o),e,t,1):(r.precision=i=n-o.e,o=q(o.plus(1),new r(1).minus(o),i+e,1),r.precision=e+4,r.rounding=1,o=o.ln(),r.precision=e,r.rounding=t,o.times(.5))):new r(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):new r(NaN)},A.inverseSine=A.asin=function(){var e,t,i,n,o=this,r=o.constructor;return o.isZero()?new r(o):(t=o.abs().cmp(1),i=r.precision,n=r.rounding,t!==-1?t===0?((e=ae(r,i+4,n).times(.5)).s=o.s,e):new r(NaN):(r.precision=i+6,r.rounding=1,o=o.div(new r(1).minus(o.times(o)).sqrt().plus(1)).atan(),r.precision=i,r.rounding=n,o.times(2)))},A.inverseTangent=A.atan=function(){var e,t,i,n,o,r,a,s,c,u=this,l=u.constructor,f=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&yt>=f+4)return(a=ae(l,f+4,d).times(.25)).s=u.s,a}else{if(!u.s)return new l(NaN);if(yt>=f+4)return(a=ae(l,f+4,d).times(.5)).s=u.s,a}for(l.precision=s=f+10,l.rounding=1,e=i=Math.min(28,s/W+2|0);e;--e)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(_=0,t=Math.ceil(s/W),n=1,c=u.times(u),a=new l(u),o=u;e!==-1;)if(o=o.times(c),r=a.minus(o.div(n+=2)),o=o.times(c),(a=r.plus(o.div(n+=2))).d[t]!==void 0)for(e=t;a.d[e]===r.d[e]&&e--;);return i&&(a=a.times(2<<i-1)),_=1,D(a,l.precision=f,l.rounding=d,1)},A.isFinite=function(){return!!this.d},A.isInteger=A.isInt=function(){return!!this.d&&Z(this.e/W)>this.d.length-2},A.isNaN=function(){return!this.s},A.isNegative=A.isNeg=function(){return 0>this.s},A.isPositive=A.isPos=function(){return this.s>0},A.isZero=function(){return!!this.d&&this.d[0]===0},A.lessThan=A.lt=function(e){return 0>this.cmp(e)},A.lessThanOrEqualTo=A.lte=function(e){return 1>this.cmp(e)},A.logarithm=A.log=function(e){var t,i,n,o,r,a,s,c,u=this,l=u.constructor,f=l.precision,d=l.rounding;if(e==null)e=new l(10),t=1;else{if(i=(e=new l(e)).d,0>e.s||!i||!i[0]||e.eq(1))return new l(NaN);t=e.eq(10)}if(i=u.d,0>u.s||!i||!i[0]||u.eq(1))return new l(i&&!i[0]?-1/0:u.s!=1?NaN:i?0:1/0);if(t)if(i.length>1)r=1;else{for(o=i[0];o%10==0;)o/=10;r=o!==1}if(_=0,a=ve(u,s=f+5),n=t?ot(l,s+10):ve(e,s),We((c=q(a,n,s,1)).d,o=f,d))do if(a=ve(u,s+=10),n=t?ot(l,s+10):ve(e,s),c=q(a,n,s,1),!r){+H(c.d).slice(o+1,o+15)+1==1e14&&(c=D(c,f+1,0));break}while(We(c.d,o+=10,d));return _=1,D(c,f,d)},A.minus=A.sub=function(e){var t,i,n,o,r,a,s,c,u,l,f,d,m=this,h=m.constructor;if(e=new h(e),!m.d||!e.d)return m.s&&e.s?m.d?e.s=-e.s:e=new h(e.d||m.s!==e.s?m:NaN):e=new h(NaN),e;if(m.s!=e.s)return e.s=-e.s,m.plus(e);if(d=e.d,s=h.precision,c=h.rounding,!(u=m.d)[0]||!d[0]){if(d[0])e.s=-e.s;else{if(!u[0])return new h(c===3?-0:0);e=new h(m)}return _?D(e,s,c):e}if(i=Z(e.e/W),l=Z(m.e/W),u=u.slice(),r=l-i){for((f=0>r)?(t=u,r=-r,a=d.length):(t=d,i=l,a=u.length),r>(n=Math.max(Math.ceil(s/W),a)+2)&&(r=n,t.length=1),t.reverse(),n=r;n--;)t.push(0);t.reverse()}else{for((f=(a=d.length)>(n=u.length))&&(a=n),n=0;a>n;n++)if(u[n]!=d[n]){f=d[n]>u[n];break}r=0}for(f&&(t=u,u=d,d=t,e.s=-e.s),n=d.length-(a=u.length);n>0;--n)u[a++]=0;for(n=d.length;n>r;){if(u[--n]<d[n]){for(o=n;o&&u[--o]===0;)u[o]=re-1;--u[o],u[n]+=re}u[n]-=d[n]}for(;u[--a]===0;)u.pop();for(;u[0]===0;u.shift())--i;return u[0]?(e.d=u,e.e=rt(u,i),_?D(e,s,c):e):new h(c===3?-0:0)},A.modulo=A.mod=function(e){var t,i=this,n=i.constructor;return e=new n(e),!i.d||!e.s||e.d&&!e.d[0]?new n(NaN):!e.d||i.d&&!i.d[0]?D(new n(i),n.precision,n.rounding):(_=0,n.modulo==9?(t=q(i,e.abs(),0,3,1)).s*=e.s:t=q(i,e,0,n.modulo,1),t=t.times(e),_=1,i.minus(t))},A.naturalExponential=A.exp=function(){return It(this)},A.naturalLogarithm=A.ln=function(){return ve(this)},A.negated=A.neg=function(){var e=new this.constructor(this);return e.s=-e.s,D(e)},A.plus=A.add=function(e){var t,i,n,o,r,a,s,c,u,l,f=this,d=f.constructor;if(e=new d(e),!f.d||!e.d)return f.s&&e.s?f.d||(e=new d(e.d||f.s===e.s?f:NaN)):e=new d(NaN),e;if(f.s!=e.s)return e.s=-e.s,f.minus(e);if(l=e.d,s=d.precision,c=d.rounding,!(u=f.d)[0]||!l[0])return l[0]||(e=new d(f)),_?D(e,s,c):e;if(r=Z(f.e/W),n=Z(e.e/W),u=u.slice(),o=r-n){for(0>o?(i=u,o=-o,a=l.length):(i=l,n=r,a=u.length),o>(a=(r=Math.ceil(s/W))>a?r+1:a+1)&&(o=a,i.length=1),i.reverse();o--;)i.push(0);i.reverse()}for(0>(a=u.length)-(o=l.length)&&(o=a,i=l,l=u,u=i),t=0;o;)t=(u[--o]=u[o]+l[o]+t)/re|0,u[o]%=re;for(t&&(u.unshift(t),++n),a=u.length;u[--a]==0;)u.pop();return e.d=u,e.e=rt(u,n),_?D(e,s,c):e},A.precision=A.sd=function(e){var t,i=this;if(e!==void 0&&e!==!!e&&e!==1&&e!==0)throw Error(he+e);return i.d?(t=cn(i.d),e&&i.e+1>t&&(t=i.e+1)):t=NaN,t},A.round=function(){var e=this,t=e.constructor;return D(new t(e),e.e+1,t.rounding)},A.sine=A.sin=function(){var e,t,i=this,n=i.constructor;return i.isFinite()?i.isZero()?new n(i):(t=n.rounding,n.precision=(e=n.precision)+Math.max(i.e,i.sd())+W,n.rounding=1,i=function(o,r){var a,s,c,u,l,f=r.d.length;if(3>f)return r.isZero()?r:Ce(o,2,r,r);for(r=Ce(o,2,r=r.times(1/st(5,a=(a=1.4*Math.sqrt(f))>16?16:0|a)),r),c=new o(5),u=new o(16),l=new o(20);a--;)s=r.times(r),r=r.times(c.plus(s.times(u.times(s).minus(l))));return r}(n,mn(n,i)),n.precision=e,n.rounding=t,D(pe>2?i.neg():i,e,t,1)):new n(NaN)},A.squareRoot=A.sqrt=function(){var e,t,i,n,o,r,a=this,s=a.d,c=a.e,u=a.s,l=a.constructor;if(u!==1||!s||!s[0])return new l(!u||0>u&&(!s||s[0])?NaN:s?a:1/0);for(_=0,(u=Math.sqrt(+a))==0||u==1/0?(((t=H(s)).length+c)%2==0&&(t+="0"),u=Math.sqrt(t),c=Z((c+1)/2)-(0>c||c%2),n=new l(t=u==1/0?"5e"+c:(t=u.toExponential()).slice(0,t.indexOf("e")+1)+c)):n=new l(""+u),i=(c=l.precision)+3;;)if(n=(r=n).plus(q(a,r,i+2,1)).times(.5),H(r.d).slice(0,i)===(t=H(n.d)).slice(0,i)){if((t=t.slice(i-3,i+1))!="9999"&&(o||t!="4999")){+t&&(+t.slice(1)||t.charAt(0)!="5")||(D(n,c+1,1),e=!n.times(n).eq(a));break}if(!o&&(D(r,c+1,0),r.times(r).eq(a))){n=r;break}i+=4,o=1}return _=1,D(n,c,l.rounding,e)},A.tangent=A.tan=function(){var e,t,i=this,n=i.constructor;return i.isFinite()?i.isZero()?new n(i):(t=n.rounding,n.precision=(e=n.precision)+10,n.rounding=1,(i=i.sin()).s=1,i=q(i,new n(1).minus(i.times(i)).sqrt(),e+10,0),n.precision=e,n.rounding=t,D(pe==2||pe==4?i.neg():i,e,t,1)):new n(NaN)},A.times=A.mul=function(e){var t,i,n,o,r,a,s,c,u,l=this,f=l.constructor,d=l.d,m=(e=new f(e)).d;if(e.s*=l.s,!(d&&d[0]&&m&&m[0]))return new f(!e.s||d&&!d[0]&&!m||m&&!m[0]&&!d?NaN:d&&m?0*e.s:e.s/0);for(i=Z(l.e/W)+Z(e.e/W),(u=m.length)>(c=d.length)&&(r=d,d=m,m=r,a=c,c=u,u=a),r=[],n=a=c+u;n--;)r.push(0);for(n=u;--n>=0;){for(t=0,o=c+n;o>n;)s=r[o]+m[n]*d[o-n-1]+t,r[o--]=s%re|0,t=s/re|0;r[o]=(r[o]+t)%re|0}for(;!r[--a];)r.pop();return t?++i:r.shift(),e.d=r,e.e=rt(r,i),_?D(e,f.precision,f.rounding):e},A.toBinary=function(e,t){return Ot(this,2,e,t)},A.toDecimalPlaces=A.toDP=function(e,t){var i=this,n=i.constructor;return i=new n(i),e===void 0?i:(ee(e,0,me),t===void 0?t=n.rounding:ee(t,0,8),D(i,e+i.e+1,t))},A.toExponential=function(e,t){var i,n=this,o=n.constructor;return e===void 0?i=ce(n,1):(ee(e,0,me),t===void 0?t=o.rounding:ee(t,0,8),i=ce(n=D(new o(n),e+1,t),1,e+1)),n.isNeg()&&!n.isZero()?"-"+i:i},A.toFixed=function(e,t){var i,n,o=this,r=o.constructor;return e===void 0?i=ce(o):(ee(e,0,me),t===void 0?t=r.rounding:ee(t,0,8),i=ce(n=D(new r(o),e+o.e+1,t),0,e+n.e+1)),o.isNeg()&&!o.isZero()?"-"+i:i},A.toFraction=function(e){var t,i,n,o,r,a,s,c,u,l,f,d,m=this,h=m.d,p=m.constructor;if(!h)return new p(m);if(u=i=new p(1),n=c=new p(0),r=(t=new p(n)).e=cn(h)-m.e-1,t.d[0]=J(10,0>(a=r%W)?W+a:a),e==null)e=r>0?t:u;else{if(!(s=new p(e)).isInt()||s.lt(u))throw Error(he+s);e=s.gt(t)?r>0?t:u:s}for(_=0,s=new p(H(h)),l=p.precision,p.precision=r=h.length*W*2;f=q(s,t,0,1,1),(o=i.plus(f.times(n))).cmp(e)!=1;)i=n,n=o,u=c.plus(f.times(o=u)),c=o,t=s.minus(f.times(o=t)),s=o;return o=q(e.minus(i),n,0,1,1),c=c.plus(o.times(u)),i=i.plus(o.times(n)),c.s=u.s=m.s,d=1>q(u,n,r,1).minus(m).abs().cmp(q(c,i,r,1).minus(m).abs())?[u,n]:[c,i],p.precision=l,_=1,d},A.toHexadecimal=A.toHex=function(e,t){return Ot(this,16,e,t)},A.toNearest=function(e,t){var i=this,n=i.constructor;if(i=new n(i),e==null){if(!i.d)return i;e=new n(1),t=n.rounding}else{if(e=new n(e),t===void 0?t=n.rounding:ee(t,0,8),!i.d)return e.s?i:e;if(!e.d)return e.s&&(e.s=i.s),e}return e.d[0]?(_=0,i=q(i,e,0,t,1).times(e),_=1,D(i)):(e.s=i.s,i=e),i},A.toNumber=function(){return+this},A.toOctal=function(e,t){return Ot(this,8,e,t)},A.toPower=A.pow=function(e){var t,i,n,o,r,a,s=this,c=s.constructor,u=+(e=new c(e));if(!(s.d&&e.d&&s.d[0]&&e.d[0]))return new c(J(+s,u));if((s=new c(s)).eq(1))return s;if(n=c.precision,r=c.rounding,e.eq(1))return D(s,n,r);if((t=Z(e.e/W))>=e.d.length-1&&9007199254740991>=(i=0>u?-u:u))return o=ln(c,s,i,n),0>e.s?new c(1).div(o):D(o,n,r);if(0>(a=s.s)){if(e.d.length-1>t)return new c(NaN);if(1&e.d[t]||(a=1),s.e==0&&s.d[0]==1&&s.d.length==1)return s.s=a,s}return(t=(i=J(+s,u))!=0&&isFinite(i)?new c(i+"").e:Z(u*(Math.log("0."+H(s.d))/Math.LN10+s.e+1)))>c.maxE+1||c.minE-1>t?new c(t>0?a/0:0):(_=0,c.rounding=s.s=1,(o=It(e.times(ve(s,n+(i=Math.min(12,(t+"").length)))),n)).d&&We((o=D(o,n+5,1)).d,n,r)&&+H((o=D(It(e.times(ve(s,(t=n+10)+i)),t),t+5,1)).d).slice(n+1,n+15)+1==1e14&&(o=D(o,n+1,0)),o.s=a,_=1,c.rounding=r,D(o,n,r))},A.toPrecision=function(e,t){var i,n=this,o=n.constructor;return e===void 0?i=ce(n,o.toExpNeg>=n.e||n.e>=o.toExpPos):(ee(e,1,me),t===void 0?t=o.rounding:ee(t,0,8),i=ce(n=D(new o(n),e,t),n.e>=e||o.toExpNeg>=n.e,e)),n.isNeg()&&!n.isZero()?"-"+i:i},A.toSignificantDigits=A.toSD=function(e,t){var i=this.constructor;return e===void 0?(e=i.precision,t=i.rounding):(ee(e,1,me),t===void 0?t=i.rounding:ee(t,0,8)),D(new i(this),e,t)},A.toString=function(){var e=this,t=e.constructor,i=ce(e,t.toExpNeg>=e.e||e.e>=t.toExpPos);return e.isNeg()&&!e.isZero()?"-"+i:i},A.truncated=A.trunc=function(){return D(new this.constructor(this),this.e+1,1)},A.valueOf=A.toJSON=function(){var e=this,t=e.constructor,i=ce(e,t.toExpNeg>=e.e||e.e>=t.toExpPos);return e.isNeg()?"-"+i:i},q=function(){function e(n,o,r){var a,s=0,c=n.length;for(n=n.slice();c--;)n[c]=(a=n[c]*o+s)%r|0,s=a/r|0;return s&&n.unshift(s),n}function t(n,o,r,a){var s,c;if(r!=a)c=r>a?1:-1;else for(s=c=0;r>s;s++)if(n[s]!=o[s]){c=n[s]>o[s]?1:-1;break}return c}function i(n,o,r,a){for(var s=0;r--;)n[r]-=s,n[r]=(s=o[r]>n[r]?1:0)*a+n[r]-o[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,r,a,s,c){var u,l,f,d,m,h,p,g,y,b,P,k,S,v,w,N,E,U,C,T,I=n.constructor,$=n.s==o.s?1:-1,x=n.d,O=o.d;if(!(x&&x[0]&&O&&O[0]))return new I(n.s&&o.s&&(x?!O||x[0]!=O[0]:O)?x&&x[0]==0||!O?0*$:$/0:NaN);for(c?(m=1,l=n.e-o.e):(c=re,l=Z(n.e/(m=W))-Z(o.e/m)),C=O.length,E=x.length,b=(y=new I($)).d=[],f=0;O[f]==(x[f]||0);f++);if(O[f]>(x[f]||0)&&l--,r==null?(v=r=I.precision,a=I.rounding):v=s?r+(n.e-o.e)+1:r,0>v)b.push(1),h=1;else{if(v=v/m+2|0,f=0,C==1){for(d=0,O=O[0],v++;(E>f||d)&&v--;f++)b[f]=(w=d*c+(x[f]||0))/O|0,d=w%O|0;h=d||E>f}else{for((d=c/(O[0]+1)|0)>1&&(O=e(O,d,c),x=e(x,d,c),C=O.length,E=x.length),N=C,k=(P=x.slice(0,C)).length;C>k;)P[k++]=0;(T=O.slice()).unshift(0),U=O[0],c/2>O[1]||++U;do d=0,0>(u=t(O,P,C,k))?(S=P[0],C!=k&&(S=S*c+(P[1]||0)),(d=S/U|0)>1?(c>d||(d=c-1),(u=t(p=e(O,d,c),P,g=p.length,k=P.length))==1&&(d--,i(p,g>C?T:O,g,c))):(d==0&&(u=d=1),p=O.slice()),k>(g=p.length)&&p.unshift(0),i(P,p,k,c),u==-1&&1>(u=t(O,P,C,k=P.length))&&(d++,i(P,k>C?T:O,k,c)),k=P.length):u===0&&(d++,P=[0]),b[f++]=d,u&&P[0]?P[k++]=x[N]||0:(P=[x[N]],k=1);while((N++<E||P[0]!==void 0)&&v--);h=P[0]!==void 0}b[0]||b.shift()}if(m==1)y.e=l,qn=h;else{for(f=1,d=b[0];d>=10;d/=10)f++;y.e=f+l*m-1,D(y,s?r+y.e+1:r,a,h)}return y}}(),A[Symbol.for("nodejs.util.inspect.custom")]=A.toString,A[Symbol.toStringTag]="Decimal",te=A.constructor=function e(t){function i(a){var s,c,u,l=this;if(!(l instanceof i))return new i(a);if(l.constructor=i,hn(a))return l.s=a.s,void(_?!a.d||a.e>i.maxE?(l.e=NaN,l.d=null):i.minE>a.e?(l.e=0,l.d=[0]):(l.e=a.e,l.d=a.d.slice()):(l.e=a.e,l.d=a.d?a.d.slice():a.d));if((u=typeof a)=="number"){if(a===0)return l.s=0>1/a?-1:1,l.e=0,void(l.d=[0]);if(0>a?(a=-a,l.s=-1):l.s=1,a===~~a&&1e7>a){for(s=0,c=a;c>=10;c/=10)s++;return void(_?s>i.maxE?(l.e=NaN,l.d=null):i.minE>s?(l.e=0,l.d=[0]):(l.e=s,l.d=[a]):(l.e=s,l.d=[a]))}return 0*a!=0?(a||(l.s=NaN),l.e=NaN,void(l.d=null)):Nt(l,""+a)}if(u!=="string")throw Error(he+a);return(c=a.charCodeAt(0))===45?(a=a.slice(1),l.s=-1):(c===43&&(a=a.slice(1)),l.s=1),Wt.test(a)?Nt(l,a):Fi(l,a)}var n,o,r;if(i.prototype=A,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Hi,i.clone=e,i.isDecimal=hn,i.abs=Ui,i.acos=ji,i.acosh=Di,i.add=Ri,i.asin=Wi,i.asinh=_i,i.atan=Gi,i.atanh=qi,i.atan2=Vi,i.cbrt=Ki,i.ceil=Ji,i.clamp=zi,i.cos=Zi,i.cosh=Xi,i.div=Yi,i.exp=Qi,i.floor=er,i.hypot=tr,i.ln=nr,i.log=ir,i.log10=or,i.log2=rr,i.max=sr,i.min=ar,i.mod=cr,i.mul=lr,i.pow=ur,i.random=dr,i.round=fr,i.sign=mr,i.sin=pr,i.sinh=hr,i.sqrt=gr,i.sub=yr,i.sum=br,i.tan=kr,i.tanh=vr,i.trunc=Pr,t===void 0&&(t={}),t&&t.defaults!=1)for(r=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],n=0;r.length>n;)t.hasOwnProperty(o=r[n++])||(t[o]=this[o]);return i.config(t),i}(ht),mt=new te(mt),pt=new te(pt),Object.freeze(Object.defineProperty({__proto__:null,decimalizeAdd:ue,decimalizeDiv:function(e,t){return new te(e).div(new te(t)).toNumber()},decimalizeMul:function(e,t){return new te(e).mul(new te(t)).toNumber()},decimalizeSub:function(e,t){return new te(e).minus(new te(t)).toNumber()},innerTrimerForStyleKey:at,resolveNonRegularKey2str:At,resolveNonRegularKey3str:Pe,searchNextKey:gn,searchPrevKey:yn},Symbol.toStringTag,{value:"Module"}));class R{constructor(t){z(this,"res"),z(this,"fail",()=>0),this.res=t}}const uo=new R(null),j=()=>uo;class tt extends Error{constructor(t,i,n,o){super(o),z(this,"statusCode"),z(this,"message"),z(this,"line"),z(this,"linePos"),z(this,"token"),z(this,"fail",()=>1),this.message=o,this.line=t,this.linePos=i,this.token=n}}class M extends tt{constructor(){super(...arguments),z(this,"type","E400"),z(this,"statusCode",400)}}class be extends tt{constructor(){super(...arguments),z(this,"type","E404"),z(this,"statusCode",404)}}class fo extends tt{constructor(){super(...arguments),z(this,"type","E405"),z(this,"statusCode",405)}}class xt extends tt{constructor(){super(...arguments),z(this,"type","E422"),z(this,"statusCode",422)}}class mo extends tt{constructor(){super(...arguments),z(this,"type","E500"),z(this,"statusCode",500)}}B=(e=>(e[void 0]="undefined",e.flash="flush",e.note="note",e.bullet="bullet",e.degreeName="degree",e.style="style",e.blockStyle="blockStyle",e.regionStart="regionStart",e.regionProp="regionProp",e.comma="comma",e.openingCurlyBrace="openingCurlyBrace",e.closingCurlyBrace="closingCurlyBrace",e))(B||{});const xi={C:"C","C#":"C#",D:"D","D#":"D#",E:"E",F:"F","F#":"F#",G:"G","G#":"G#",A:"A","A#":"A#",B:"B"};Se=(e=>(e.normal="",e.harmonic="harmonic",e.melodic="melodic",e))(Se||{}),le=(e=>(e.unknown="",e.major="major",e.minor="minor",e))(le||{});const po={major:{evolvedCodePrefix:["","m","m","","","m","dim"],bin:[1,0,1,0,1,1,0,1,0,1,0,1]},"major 7th":{evolvedCodePrefix:["maj7","m7","m7","maj7","7","m7","m7b5"],bin:[1,0,1,0,1,1,0,1,0,1,0,1]},"major 6th":{evolvedCodePrefix:["6","m7","m7","6","7","m7","m7b5"],bin:[1,0,1,0,1,1,0,1,0,1,0,1]},minor:{evolvedCodePrefix:["m","m7b5","","m","m","","m"],bin:[1,0,1,1,0,1,0,1,1,0,1,0]},"minor 7th":{evolvedCodePrefix:["m7","m7b5","maj7","m7","m7","maj7","7"],bin:[1,0,1,1,0,1,0,1,1,0,1,0]},"minor 6th":{evolvedCodePrefix:["m7","m7b5","6","m7","m7","6","7"],bin:[1,0,1,1,0,1,0,1,1,0,1,0]},"harmonic minor":{evolvedCodePrefix:["m","dim","aug","m","","","dim"],bin:[1,0,1,1,0,1,0,1,1,0,0,1]},"harmonic minor 7th":{evolvedCodePrefix:["mmaj7","m7b5","maj7#5","m7","7","maj7","dim7"],bin:[1,0,1,1,0,1,0,1,1,0,0,1]},"melodic minor":{evolvedCodePrefix:["m","m","aug","","","dim","dim"],bin:[1,0,1,1,0,1,0,1,0,1,0,1]},"melodic minor 7th":{evolvedCodePrefix:["mmaj7","m7","maj7#5","7","7","m7b5","m7b5"],bin:[1,0,1,1,0,1,0,1,0,1,0,1]},"harmonic major":{evolvedCodePrefix:["","m7b5","m","m","","aug","m7b5"],bin:[1,0,1,0,1,1,0,1,1,0,0,1]},"harmonic major 7th":{evolvedCodePrefix:["maj7","m7b5","m7","mmaj7","7","m7#5","maj7"],bin:[1,0,1,0,1,1,0,1,1,0,0,1]}},ho=e=>structuredClone(po[e]),Ii=Object.keys(Ke=(e=>(e[e.major=0]="major",e[e.minor=1]="minor",e[e.dorian=2]="dorian",e[e.diminish=3]="diminish",e[e.halfDiminish=4]="halfDiminish",e[e.pentatonic=5]="pentatonic",e[e.harmonicMinor=6]="harmonicMinor",e[e.melodicMinor=7]="melodicMinor",e[e.chromatic=8]="chromatic",e))(Ke||{})).filter(e=>isNaN(+e)&&!isNaN(Ke[e])),Ni={0:{bin:[1,0,1,0,1,1,0,1,0,1,0,1]},1:{bin:[1,0,1,1,0,1,0,1,1,0,1,0]},2:{bin:[1,0,1,1,0,1,0,1,0,1,1,0]},3:{bin:[1,0,1,1,0,1,1,0,1,1,0,1]},4:{bin:[1,1,0,1,1,0,1,1,0,1,1,0]},5:{bin:[1,0,0,1,0,1,0,1,0,0,1,0]},6:{bin:[1,0,1,1,0,1,0,1,1,0,0,1]},7:{bin:[1,0,1,1,0,1,0,1,0,1,0,1]},8:{bin:[1,1,1,1,1,1,1,1,1,1,1,1]}},Oi={E:["E","F","F#","G","G#","A","A#","B","C","C#","D","D#"],F:["F","F#","G","G#","A","A#","B","C","C#","D","D#","E"],"F#":["F#","G","G#","A","A#","B","C","C#","D","D#","E","F"],G:["G","G#","A","A#","B","C","C#","D","D#","E","F","F#"],"G#":["G#","A","A#","B","C","C#","D","D#","E","F","F#","G"],A:["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],"A#":["A#","B","C","C#","D","D#","E","F","F#","G","G#","A"],B:["B","C","C#","D","D#","E","F","F#","G","G#","A","A#"],C:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],"C#":["C#","D","D#","E","F","F#","G","G#","A","A#","B","C"],D:["D","D#","E","F","F#","G","G#","A","A#","B","C","C#"],"D#":["D#","E","F","F#","G","G#","A","A#","B","C","C#","D"]},Ai=[{id:0,oct:0,keyNum:0,keySym:"C"},{id:1,oct:0,keyNum:1,keySym:"C#"},{id:2,oct:0,keyNum:2,keySym:"D"},{id:3,oct:0,keyNum:3,keySym:"D#"},{id:4,oct:0,keyNum:4,keySym:"E"},{id:5,oct:0,keyNum:5,keySym:"F"},{id:6,oct:0,keyNum:6,keySym:"F#"},{id:7,oct:0,keyNum:7,keySym:"G"},{id:8,oct:0,keyNum:8,keySym:"G#"},{id:9,oct:0,keyNum:9,keySym:"A"},{id:10,oct:0,keyNum:10,keySym:"A#"},{id:11,oct:0,keyNum:11,keySym:"B"},{id:12,oct:1,keyNum:0,keySym:"C"},{id:13,oct:1,keyNum:1,keySym:"C#"},{id:14,oct:1,keyNum:2,keySym:"D"},{id:15,oct:1,keyNum:3,keySym:"D#"},{id:16,oct:1,keyNum:4,keySym:"E"},{id:17,oct:1,keyNum:5,keySym:"F"},{id:18,oct:1,keyNum:6,keySym:"F#"},{id:19,oct:1,keyNum:7,keySym:"G"},{id:20,oct:1,keyNum:8,keySym:"G#"},{id:21,oct:1,keyNum:9,keySym:"A"},{id:22,oct:1,keyNum:10,keySym:"A#"},{id:23,oct:1,keyNum:11,keySym:"B"},{id:24,oct:2,keyNum:0,keySym:"C"},{id:25,oct:2,keyNum:1,keySym:"C#"},{id:26,oct:2,keyNum:2,keySym:"D"},{id:27,oct:2,keyNum:3,keySym:"D#"},{id:28,oct:2,keyNum:4,keySym:"E"},{id:29,oct:2,keyNum:5,keySym:"F"},{id:30,oct:2,keyNum:6,keySym:"F#"},{id:31,oct:2,keyNum:7,keySym:"G"},{id:32,oct:2,keyNum:8,keySym:"G#"},{id:33,oct:2,keyNum:9,keySym:"A"},{id:34,oct:2,keyNum:10,keySym:"A#"},{id:35,oct:2,keyNum:11,keySym:"B"},{id:36,oct:3,keyNum:0,keySym:"C"},{id:37,oct:3,keyNum:1,keySym:"C#"},{id:38,oct:3,keyNum:2,keySym:"D"},{id:39,oct:3,keyNum:3,keySym:"D#"},{id:40,oct:3,keyNum:4,keySym:"E"},{id:41,oct:3,keyNum:5,keySym:"F"},{id:42,oct:3,keyNum:6,keySym:"F#"},{id:43,oct:3,keyNum:7,keySym:"G"},{id:44,oct:3,keyNum:8,keySym:"G#"},{id:45,oct:3,keyNum:9,keySym:"A"},{id:46,oct:3,keyNum:10,keySym:"A#"},{id:47,oct:3,keyNum:11,keySym:"B"},{id:48,oct:4,keyNum:0,keySym:"C"},{id:49,oct:4,keyNum:1,keySym:"C#"},{id:50,oct:4,keyNum:2,keySym:"D"},{id:51,oct:4,keyNum:3,keySym:"D#"},{id:52,oct:4,keyNum:4,keySym:"E"},{id:53,oct:4,keyNum:5,keySym:"F"},{id:54,oct:4,keyNum:6,keySym:"F#"},{id:55,oct:4,keyNum:7,keySym:"G"},{id:56,oct:4,keyNum:8,keySym:"G#"},{id:57,oct:4,keyNum:9,keySym:"A"},{id:58,oct:4,keyNum:10,keySym:"A#"},{id:59,oct:4,keyNum:11,keySym:"B"},{id:60,oct:5,keyNum:0,keySym:"C"},{id:61,oct:5,keyNum:1,keySym:"C#"},{id:62,oct:5,keyNum:2,keySym:"D"},{id:63,oct:5,keyNum:3,keySym:"D#"},{id:64,oct:5,keyNum:4,keySym:"E"},{id:65,oct:5,keyNum:5,keySym:"F"},{id:66,oct:5,keyNum:6,keySym:"F#"},{id:67,oct:5,keyNum:7,keySym:"G"},{id:68,oct:5,keyNum:8,keySym:"G#"},{id:69,oct:5,keyNum:9,keySym:"A"},{id:70,oct:5,keyNum:10,keySym:"A#"},{id:71,oct:5,keyNum:11,keySym:"B"},{id:72,oct:6,keyNum:0,keySym:"C"},{id:73,oct:6,keyNum:1,keySym:"C#"},{id:74,oct:6,keyNum:2,keySym:"D"},{id:75,oct:6,keyNum:3,keySym:"D#"},{id:76,oct:6,keyNum:4,keySym:"E"},{id:77,oct:6,keyNum:5,keySym:"F"},{id:78,oct:6,keyNum:6,keySym:"F#"},{id:79,oct:6,keyNum:7,keySym:"G"},{id:80,oct:6,keyNum:8,keySym:"G#"},{id:81,oct:6,keyNum:9,keySym:"A"},{id:82,oct:6,keyNum:10,keySym:"A#"},{id:83,oct:6,keyNum:11,keySym:"B"},{id:84,oct:6,keyNum:0,keySym:"C"},{id:85,oct:6,keyNum:1,keySym:"C#"},{id:86,oct:6,keyNum:2,keySym:"D"},{id:87,oct:6,keyNum:3,keySym:"D#"},{id:88,oct:6,keyNum:4,keySym:"E"}];class go{static resolve(t){for(let i=0;t.length>i;i++)for(let n=0;t[i].length>n;n++){const o=t[i][n];switch(o.type){case B.degreeName:{if(o.decidedProp.noteStr="%"+o.token+(o.styles.length?":"+o.styles.join(":"):""),/^[/.>]/.test(o.token))return new M(o.line,o.linePos,o.token,`Invalid degree chord symbol '${o.token}'.. This prefix cannot be used in chord specifications.`);const r=ut(o);if(r.fail())return r;break}case B.note:if(/\|/.test(o.token)){o.decidedProp.noteStr=o.token+(o.styles.length?":"+o.styles.join(":"):"");const r=ut(o);if(r.fail())return r}else{if(o.decidedProp.noteStr=o.token+(o.styles.length?":"+o.styles.join(":"):""),/^(rn|R)[\^~=]*$/.test(o.token)){const a=o.token.match(/([\^~=]+)$/);o.token="r"+(a?a[1]:""),o.styles.push("rn"),o.linesOfStyle.push(o.line),o.linePosOfStyle.push(o.linePos)}if(/^[/.>]/.test(o.token))return new M(o.line,o.linePos,o.token,`Invalid chord symbol '${o.token}'.. This prefix cannot be used in chord specifications.`);const r=ut(o);if(r.fail())return r}break;case B.bullet:{o.decidedProp.noteStr=o.token+(o.styles.length?":"+o.styles.join(":"):"");const r=ut(o);if(r.fail())return r}}}return j()}}class yo{static apply(t,i){const n=t.dualId,o=[],r={num:1};for(let a=0;i[n].length>a;a++){const s=i[n][a];if(s.type===B.bullet){const c=Cr(t,t.regionList[s.regionRegionForDualConnection].tuning,o,s,r);if(c.fail())return c;r.num++}else o.push(s)}return i[n]=o,j()}}Object.freeze(Object.defineProperty({__proto__:null,calculateTimeForTicks:Ge,getSoundLength:function(e,t){return 6e4/e/F.PPS*t},getTicksByTime:Tn,reduceUntilNextArrByGCD:xn,untilNextToTick:we},Symbol.toStringTag,{value:"Module"}));class bo{static resolve(t,i){const n={};for(let o=0;i.length>o;o++){const r=Er(t,t.mixesList[o],i[o],n);if(r.fail())return r;const a=Br(t.mixesList[o],i[o],n);if(a.fail())return a;const s=yo.apply(t.mixesList[o],i);if(s.fail())return s;const c=Lr(t.mixesList[o],i[o]);if(c.fail())return c}return t.styleObjectBank=n,j()}}_t=(Zn=[0,2,4,-1,1,3,5]).map(e=>Math.floor(7*e/12)),Xn=[3,0,4,1,5,2,6],Gt=(e,t)=>Array(Math.abs(t)+1).join(e),bt={empty:1,name:"",acc:""},Yn=RegExp("^([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})|(AA|A|P|M|m|d|dd)([-+]?\\d+)$"),qt={},Vt=[0,2,4,5,7,9,11],Kt="PMMPPMM",Jt=(e,t)=>Array(Math.abs(t)+1).join(e),zt={empty:1,name:"",pc:"",acc:""},Ht=new Map,Qn=e=>"CDEFGAB".charAt(e),ei=e=>0>e?Jt("b",-e):Jt("#",e),ti=e=>e[0]==="b"?-e.length:e.length,ni=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/,ii=(e,t)=>(e%t+t)%t,kt=[0,2,4,5,7,9,11],Be={empty:1,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},Zt=e=>(+e).toString(2).padStart(12,"0"),Xt=e=>parseInt(e,2),ri=/^[01]{12}$/,oi=e=>typeof e=="number"&&e>=0&&4095>=e,si=e=>e&&Ln(e.chroma),Yt={[Be.chroma]:Be},ai=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"],ci=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7  ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 #4 #11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -7 m -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim  o"],["1P 3m 5d 7d","diminished seventh","dim7 7 o7"],["1P 3m 5d 7m","half-diminished","m7b5  -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],li={...Be,name:"",quality:"Unknown",intervals:[],aliases:[]},Qt=[],Ee={},ci.forEach(([e,t,i])=>function(n,o,r){const a=function(c){const u=l=>c.indexOf(l)!==-1;return u("5A")?"Augmented":u("3M")?"Major":u("5d")?"Diminished":u("3m")?"Minor":"Unknown"}(n),s={...Bn(n),name:r||"",quality:a,intervals:n,aliases:o};Qt.push(s),s.name&&(Ee[s.name]=s),Ee[s.setNum]=s,Ee[s.chroma]=s,s.aliases.forEach(c=>function(u,l){Ee[l]=u}(s,c))}(e.split(" "),i.split(" "),t)),Qt.sort((e,t)=>e.setNum-t.setNum),Je={},[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]].forEach(([e,t,...i])=>function(n,o,r=[]){const a={...Bn(n),name:o,intervals:n,aliases:r};return Je[a.name]=a,Je[a.setNum]=a,Je[a.chroma]=a,a.aliases.forEach(s=>function(c,u){Je[u]=c}(a,s)),a}(e.split(" "),t,i)),vt={empty:1,name:"",symbol:"",root:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};class ko{static search(t,i,n={}){t=t.replace(/mmaj/,"mMaj"),n.difficulty||(n.difficulty=3),n.maxSearchRootFret||(n.maxSearchRootFret=12),n.searchFretWidth||(n.searchFretWidth=4),n.requiredStrings&&(n.requiredStrings=n.requiredStrings.map(l=>l-1).sort());let o=null;/\//.test(t)&&([t,o]=t.split("/"));const r=function(l){if(l==="")return vt;if(Array.isArray(l)&&l.length===2)return Bt(l[1],l[0]);{const[f,d]=function(h){const[p,g,y,b]=Cn(h);return p===""?["",h]:p==="A"&&b==="ug"?["","aug"]:[p+g,y+b]}(l),m=Bt(d,f);return m.empty?Bt(l):m}}(t);if(!r.notes.length)return null;if(!r.tonic)throw"nothing tonic";o&&(r.notes.unshift(o),r.tonic=o);const a=r.notes.map(l=>Pe(l)),s=[];r.intervals.forEach((l,f)=>{/9|13|11/.test(l)&&s.push(a[f])});let c=null;r.intervals.forEach((l,f)=>{l==="5P"&&(c=r.notes[f])});const u={notes:a,tonic:Pe(r.tonic),intervals:r.intervals,tensionNotes:s,perfectFifth:c,options:n};return function(l,f){const d=[];for(let m=l.length-1;m>=0;m--){const h=Oi[l[m]],p=[];for(let g=0;F.maxTopFret>=g;g++){const y=g%h.length;p.push(f.notes.includes(h[y])?h[y]:null)}d.push(p)}f.basicBoardList=d}(i,u),Fr(i,u)}}class $i{static create(t,i,n,o,r,a){const s=`${i.join("")}:${r}:${JSON.stringify(a)}`,c=t.get(s);if(c)return new R(c);if(r==="r")return new R({symbol:"r",intervals:[],notes:[],tonic:{iKeyId:0,sym:""},bass:{iKeyId:0,sym:""},fingerings:[],createdAt:new Date,updatedAt:new Date});const u=ko.search(r,i,a);if(!u)return new be(n,o,r,`'${r}' No fingerable form was found for this code symbol.`);if(!u.fingerings)return new be(n,o,r,`Not found fingering of '${r}'. Tuning and chord may not match.`);if(!u.fingerings.length)return new be(n,o,r,`'${r}'" No fingerable form was found for this code structure.`);const l={symbol:r,intervals:u.intervals,notes:u.notes.map(f=>Pe(f)),tonic:{iKeyId:ye.iKey.indexOf(u.tonic),sym:u.tonic},bass:{iKeyId:ye.iKey.indexOf(u.tonic),sym:u.tonic},fingerings:u.fingerings,createdAt:new Date,updatedAt:new Date};return t.set(s,l),new R(l)}}class vo{static resolve(t,i,n,o,r){var a;const s=i.mixesList[n],{regionList:c}=s,u=[];let l=null;for(let v=0;r.length>v;v++){const w=r[v],N=(a=w.decidedProp)==null?void 0:a.styles.mapped;if(N==null?void 0:N.filter(U=>U.group===o).length)l===null&&(l=v),u.push({index:v,sym:structuredClone(w)});else if(l!==null&&w.type===B.note)break}if(!u.length)return j();const f=(v=>{let w=i.settings.style.scale.key+"_"+i.settings.style.scale.scale;return v.reduce((N,E)=>{const U=E.sym.decidedProp.styles.scaleX||i.settings.style.scale,C=U.key+"_"+U.scale;return N.length===0||E.index!==N[N.length-1][N[N.length-1].length-1].index+1||w!==C?N.push([E]):N[N.length-1].push(E),w=C,N},[])})(u),d=c[u[0].sym.regionRegionForDualConnection].tuning,m=ct(d),h=f.map(v=>{const w=function(I,$,x){const O=`${$.join()} ${x.key}:${x.bin.join("")}`;if(!I[O]){const G=ct($),{boardFullArr:V,iKeysWithKeyStart:oe,iKeysWithTuningStart:ne}=function(K,X,ie){const Ie=X.bin,$e=lt(ye.iKey,X.key),se=lt(ye.iKey,ie),sn=Ie.map((an,Re)=>an===1?$e[Re]:void 0),nt=K[0]+F.maxTopFret+1,je=K[K.length-1],De=$t(sn,12-lt(ye.iKey,Ai[je].keySym).indexOf(X.key));return{boardFullArr:Array.from({length:Math.floor((nt-je)/12)},()=>De).flat().concat(De.slice(0,(nt-je)%12)),iKeysWithKeyStart:$e,iKeysWithTuningStart:se}}(G,x,$[0]);I[O]={tuningPitches:G,boardFullArr:V,iKeysWithKeyStart:oe,iKeysWithTuningStart:ne}}return I[O]}(t,d,v[0].sym.decidedProp.styles.scaleX||i.settings.style.scale),N=[],E=v.map(I=>{const $=function(x,O){const G=[],V=[],oe=[],ne=[];return x.forEach((K,X)=>{if(K!==void 0&&K>=0){const ie=O[X]+K;G.push(Ai[ie].keySym),V.push(ie-O[O.length-1]),oe.push(K),ne.push(X)}}),{originKeyArr:G,originNoteNumArr:V,originFretArr:oe,originStringArr:ne}}(I.sym.decidedProp.fingering,m);return N.push(...$.originKeyArr),$}),U=function(I,$,x){const O=structuredClone(I);return x.forEach(G=>{if(!I.includes(G))for(let V=$.indexOf(G);O.length>V;V+=12)O[V]=G}),O}(w.boardFullArr,w.iKeysWithTuningStart,N),{activeInIndexes:C}={activeInIndexes:(T=U).map((I,$)=>I!==void 0?$:void 0).filter(I=>I!==void 0),activeInKeys:T.map(I=>I!==void 0?I:void 0).filter(I=>I!==void 0)};var T;return{board:w.tuningPitches.map(I=>{const $=I-w.tuningPitches[w.tuningPitches.length-1];return bn($,$+F.maxTopFret)}),extendScaleFullArr:U,activeInIndexes:C,originList:E,seed:w}}),p=u[0].sym.decidedProp.styles.mapped,g=p==null?void 0:p.find(v=>v.group===o);if(g===void 0)throw"System Error";const y=h.map((v,w)=>function(N,E,U){const C=[];return E.forEach(T=>{const I=[],$=T.options.includes(xe.sos),x=T.options.includes(xe.ss),O=T.options.includes(xe.rev);N.originList.forEach((G,V)=>{var oe;if((oe=U[V].sym.decidedProp.extensionViewProp)!=null&&oe.stepInfoId||x||G.originFretArr.length!==1)if(T.shift===0)I.push({noteNum:void 0,fingering:structuredClone(U[V].sym.decidedProp.fingering),shift:T.shift,mapOpt:T.options});else{const ne=function(X,ie,Ie){const $e=X.seed.tuningPitches[X.seed.tuningPitches.length-1];return X.originList[ie].originStringArr.map((se,sn)=>{const nt=X.seed.tuningPitches[se]-$e,je=bn(nt,nt+F.maxTopFret),De=je.map(Re=>X.extendScaleFullArr[Re]!==void 0?Re:void 0).filter(Re=>Re!==void 0),an=kn(De,De.indexOf(X.originList[ie].originNoteNumArr[sn])+Ie.shift);return je.indexOf(De[an])})}(N,V,T),K=structuredClone(structuredClone(U[V].sym.decidedProp.fingering));ne.forEach((X,ie)=>{$&&N.originList[V].originFretArr[ie]===0||(K[N.originList[V].originStringArr[ie]]=X)}),I.push({noteNum:void 0,fingering:K,shift:T.shift,mapOpt:T.options})}else if($&&G.originFretArr[0]===0)I.push({noteNum:void 0,fingering:structuredClone(U[V].sym.decidedProp.fingering),shift:T.shift,mapOpt:T.options});else if(T.shift===0)I.push({noteNum:void 0,fingering:structuredClone(U[V].sym.decidedProp.fingering),shift:T.shift,mapOpt:T.options});else{const ne=kn(N.activeInIndexes,N.activeInIndexes.indexOf(G.originNoteNumArr[0])+T.shift);I.push({noteNum:N.activeInIndexes[ne],fingering:void 0,shift:T.shift,mapOpt:T.options})}}),C.push(O?I.reverse():I)}),C}(v,g.style,f[w])),b=g.style.flatMap((v,w)=>y.flatMap(N=>N[w].map(E=>E)));let P=0,k=0;const S=b.map((v,w)=>{var N;w%u.length==0&&(k=0);const E=v.noteNum;if(E!==void 0){const T=v.mapOpt.includes(xe.nos);let I=h[0].board.findIndex(x=>x.includes(E));if(T&&h[0].board.length-1!==I&&h[0].board[I].indexOf(E)===0){const x=h[0].board.findIndex((O,G)=>O.includes(E)&&I!==G);0>x||(I=x)}const $=Array(d.length).fill(void 0);$[I]=h[0].board[I].indexOf(E),b[w].fingering=$}const U=new Date().getTime(),C=i.notStyleCompile?function(T){var I;const $={line:T.line,linePos:T.linePos,endLine:T.endLine,endPos:T.endPos,decidedProp:{noteStr:T.decidedProp.noteStr,list:T.decidedProp.list,tick:{tick:T.decidedProp.tick.tick,untilNext:T.decidedProp.tick.untilNext},styles:{},shifted:(I=T.decidedProp.shifted)==null?void 0:I.map(G=>({shift:G.shift,options:[...G.options]}))},regionRegionForDualConnection:T.regionRegionForDualConnection,locationInfoRefStackUpList:T.locationInfoRefStackUpList};T.decidedProp.isArpeggio&&($.decidedProp.isArpeggio=1),T.decidedProp.isBullet&&($.decidedProp.isBullet=T.decidedProp.isBullet);const x={},O=T.decidedProp.styles;return Object.keys(O).forEach(G=>{x[G]=O[G]}),$.decidedProp.styles=x,$}(u[k].sym):function(T){var I;const $={curlyLevel:T.curlyLevel,type:T.type,line:T.line,linePos:T.linePos,typesStyle:T.typesStyle,endLine:T.endLine,endPos:T.endPos,token:T.token,styles:T.styles,linesOfStyle:T.linePosOfStyle,linePosOfStyle:T.linePosOfStyle,endOfMeasure:T.endOfMeasure,decidedProp:{noteStr:T.decidedProp.noteStr,extensionViewProp:T.decidedProp.extensionViewProp,list:T.decidedProp.list,tick:{tick:T.decidedProp.tick.tick,untilNext:T.decidedProp.tick.untilNext},styles:{},fingering:[...T.decidedProp.fingering],trueTab:T.decidedProp.trueTab?[...T.decidedProp.trueTab]:void 0,shifted:(I=T.decidedProp.shifted)==null?void 0:I.map(G=>({shift:G.shift,options:[...G.options]})),chordDicRef:T.decidedProp.chordDicRef},regionRegionForDualConnection:T.regionRegionForDualConnection,locationInfoRefStackUpList:T.locationInfoRefStackUpList};T.decidedProp.isArpeggio&&($.decidedProp.isArpeggio=1),T.decidedProp.isBullet&&($.decidedProp.isBullet=T.decidedProp.isBullet);const x={},O=T.decidedProp.styles;return Object.keys(O).forEach(G=>{x[G]=O[G]}),$.decidedProp.styles=x,$}(u[k].sym);return P+=(new Date().getTime()-U)/1e3,C.decidedProp.trueTab=u[k].sym.decidedProp.trueTab,C.decidedProp.fingering=b[w].fingering,C.decidedProp.shifted||(C.decidedProp.shifted=[]),C.decidedProp.shifted.push({shift:v.shift,options:v.mapOpt}),(N=C.decidedProp.styles.mapped)==null||N.forEach(T=>{T.group===o&&(T.group=-2)}),k++,C});return structuredClone(f).reverse().forEach(v=>{r.splice(v[0].index,v.length)}),r.splice(f[0][0].index,0,...S),j()}}class Po{static apply(t,i,n){const o=t.mixesList[i],{marks:r}=o,a=t.dic.mapSeed,s=r.styleMappedGroupList;if(!s.length)return j();for(let c=0;s.length>c;c++){const u=vo.resolve(a,t,i,s[c],n);if(u.fail())return u}return j()}}class wo{static resolve(t,i,n,o,r,a){const s=a.token,c=a.line,u=a.linePos;if(s==="@/click"){const l=Et(t,i,n,o,s,c,u);if(l.fail())return l}else if(s.startsWith("@click(")){if(i!==0)return new be(c,u,s,`Unknown annotation token '${s.replace(/\(.*?$/,"")}'. Click specification is only possible in base blocks.`);const l=Et(t,i,n,o,s,c,u);if(l.fail())return l}else if(s==="@click"){if(i!==0)return new be(c,u,s,`Unknown annotation token '${s.replace(/\(.*?$/,"")}'. Click specification is only possible in base blocks.`);const l=Et(t,i,n,o,s,c,u);if(l.fail())return l}else{if(!s.startsWith("@offset")){if(s==="@@")return new be(c,u,s,"The start mark @@ of a region must start outside the {} brackets.");for(let l=0;t.allowAnnotations.length>l;l++){const f=t.allowAnnotations[l],d=/^@/.test(f.name)?f.name:"@"+f.name;if(s===d||s.startsWith(d+"(")){if(f.dualIdRestrictions.length&&!f.dualIdRestrictions.includes(i))return new be(c,u,s,`Invalid annotation token '${s.replace(/\(.*?$/,"")}'. Click specification is only possible in index ${f.dualIdRestrictions} blocks.`);const m=Rr(t,i,n,o,r,d,s,c,u);return m.fail()?m:j()}}return new be(c,u,s,`Unknown annotation token '${s.replace(/\(.*?$/,"")}'.`)}{const l=function(f,d,m,h,p,g,y){if(d===0)return new M(g,y,null,"@offset cannot be set for base block.");const b=`${d}_${m}`;return f.flash.offset[b]?new M(g,y,null,"@offset duplicate error. Only one @offset can be set in a block."):(f.flash.offset[b]={syntaxLocation:{row:p,line:g,linePos:y},blockNoteIndex:h},j())}(t,i,n,r,s,c,u);if(l.fail())return l}}return j()}}class Mo{static resolve(t,i){var n;const{regionLength:o}=t,{regionList:r,flatTOList:a}=t.mixesList[i],s=Math.max(...r.map(l=>l.tuning.length)),c=a.length;let u=0;for(let l=0;s>l;l++){let f,d,m,h=o-1,p=r[h],g=p.startLayerTick+p.usedTotalTick,y=p.startLayerTick+p.usedTotalTick;for(let S=c-1;S>=0;S--){const v=a[S];let w;h!==v.regionIndex&&(h=v.regionIndex,p=r[h],g=p.startLayerTick+p.usedTotalTick,u==0?y=p.startLayerTick+p.usedTotalTick:p.usedTotalTick===p.offsetTickWidth?y=p.trueStartLayerTick:r[h+1].deactive?y=p.startLayerTick+p.usedTotalTick:(w=v.bar.stopTick,v.bar.stopTick=y)),r[v.regionIndex].tuning.length>l&&(g-=v.bar.tick,v.tab[l]!==void 0&&v.tab[l]!==-1&&(v.bar.fretStartTicks[l]=g,v.bar.fretStopTicks[l]=y===-1?g+v.bar.tick:y),v.bar.startTick=g,v.bar.stopTick===void 0&&(v.bar.stopTick=g+v.bar.tick),v.bar.stopTick-v.bar.startTick>v.bar.tick&&(v.bar.stopTick=v.bar.startTick+v.bar.tick),v.tab[l]===void 0&&v.continueX!=0||(y=g),w&&(v.bar.stopTick=w),u=v.continueX)}let b=0,P={},k=-1;for(let S=0;c>S;S++){const v=a[S];v.regionNoteIndex===0&&(p=r[v.regionIndex],k=p.tuning.length),l>r[v.regionIndex].tuning.length-1||(P.nextTabObj=v,v.isRest||v.tab[l]===-1?(f=void 0,d=void 0):S===0?v.tab[l]!==void 0&&v.tab[l]!==-1&&(f=v.tab[l],d=v):v.continueX==0?v.tab[l]!==void 0&&v.tab[l]!==-1?(f=v.tab[l],d=v):(f=void 0,d=void 0):v.tab[l]!==void 0&&v.tab[l]!==-1?(f=v.tab[l],d=v):v.styles.strum&&(f=void 0,d=void 0),v.activeBows[l]=f,v.refActiveBows===void 0&&(v.refActiveBows=Array(k).fill(void 0)),v.refActiveBows[l]=d,m&&(v.isRest||v.tab.find(w=>w!==void 0&&w!==-1)===void 0||(m.slideLandingTab=v.tab,b&&m.styles.slide&&(m.styles.slide.type="release"),m=void 0)),b=1,(n=v.styles)!=null&&n.slide&&(m=v,b=0),v.prevTabObj=P,P=v)}}return j()}}class So{static apply(t,i,n){var o;const r=t.extensionInfo.stepInfoList;for(let a=0;n.length>a;a++){const s=n[a],c=(o=s.decidedProp)==null?void 0:o.styles;if(!(c!=null&&c.step))continue;const u=t.mixesList[i].marks.styleMappedGroupList,l=u.findIndex(g=>g>0);let f=-1;u[l]>0?(f=u[l]+1,u.splice(l,0,f)):(f=1,u.splice(1,0,f));const d=c.step.parsedStep,m=r.length;r.push({tabAll:s.decidedProp.fingering,parsedStepList:d});const h=Object.keys(s.decidedProp.styles),p=[];for(let g=0;d.length>g;g++){const y=d[g],b=s.decidedProp.fingering.map((w,N)=>{var E;return(E=y.stringIndexes)!=null&&E.includes(N)?w:void 0}),P=structuredClone(s.decidedProp.tick);if(y.suffix){const w=In(P.untilNext,y.suffix,s.line,s.linePos);if(w.fail())return w}const k={};h.forEach(w=>{if(s.decidedProp.styles[w]!==void 0){switch(w){case"bd":case"bpm":case"until":case"degree":case"scaleX":case"staccato":case"velocity":case"velocityPerBows":case"stroke":case"turn":k[w]=s.decidedProp.styles[w];break;case"mapped":k[w]=structuredClone(s.decidedProp.styles[w]),k[w].forEach(N=>{N.group===-1&&(N.group=f)})}if(g===0)switch(w){case"approach":case"continue":case"delay":case"strum":k[w]=s.decidedProp.styles[w]}g===d.length-1&&w==="slide"&&(k[w]=s.decidedProp.styles[w])}}),k.inst=y.inst!==void 0?y.inst:s.decidedProp.styles.inst!==void 0?s.decidedProp.styles.inst:L.normal,g===0||k.inst!==L.normal&&k.inst!==L.muteContinue||(k.continue=1);const S=s.decidedProp.extensionViewProp||{};S.stepInfoId={id:m,orderCount:g};const v={curlyLevel:s.curlyLevel,type:s.type,typesStyle:[],line:y.line,linePos:y.startPos,linesOfStyle:[],linePosOfStyle:[],endLine:y.line,endPos:y.endPos,token:s.token,styles:[],decidedProp:{noteStr:s.decidedProp.noteStr,extensionViewProp:S,list:s.decidedProp.list,tick:P,styles:k,fingering:b,trueTab:s.decidedProp.fingering,chordDicRef:s.decidedProp.chordDicRef,isArpeggio:1},regionRegionForDualConnection:s.regionRegionForDualConnection};v.locationInfoRefStackUpList=s.locationInfoRefStackUpList,p.push(v)}n.splice(a,1,...p),a+=p.length-1}return j()}}class To{static resolve(t,i){for(let o=0;i.length>o;o++){const r=i[o],a=qr(t,o,i);if(a.fail())return a;const s=So.apply(t,o,r);if(s.fail())return s;if(!t.notStyleCompile||t.settings.compile.mappingResolved){const c=Po.apply(t,o,r);if(c.fail())return c}}for(let o=0;F.dualLength>o;o++){const r=Wr(t,o,i[o]);if(r.fail())return r}const n=function(o){const r=o.mixesList[0].regionList.length;for(let a=0;r>a;a++){for(let c=0;F.dualLength>c;c++){const u=o.mixesList[c].regionList[a];if(u.trueStartLayerTick=u.startLayerTick,u.offsetTickWidth&&(u.startLayerTick-=u.offsetTickWidth,u.endLayerTick-=u.offsetTickWidth,0>u.startLayerTick)){if(u.flashOffsetLocation)return new M(u.flashOffsetLocation.line,u.flashOffsetLocation.linePos,u.flashOffsetLocation.token,u.flashOffsetLocation.token+" exceeds previous limit. Create a region with only rests at the start.");throw"system error over offset"}}const s=Math.max(...o.mixesList.map(c=>c.regionList[a].endLayerTick));if(r-1!==a){o.mixesList[0].regionList[a].endLayerTick=s;for(let c=0;F.dualLength>c;c++){const u=o.mixesList[c].regionList[a+1];u.startLayerTick!==-1&&u.startLayerTick!=u.endLayerTick||(u.deactive=1);const l=s-u.startLayerTick;u.startLayerTick=s,u.endLayerTick+=l}}}return j()}(t);if(n.fail())return n;for(let o=0;F.dualLength>o;o++){const r=Mo.resolve(t,o);if(r.fail())return r;_r(t,o)}return j()}}class xo{static compile(t,i){const n=function(s,c){const u=[];let l=0;for(const f of c[0])if(f.type===B.regionStart){const d={},m=En(d,f);if(m.fail())return m;const h=f.token==="@@"?"@@"+Math.random():f.token;if(u.includes(h))return new M(f.line,f.linePos,h,`Block name '${h}' is already in use. The same block name cannot be declared at the same time.`);u.push(h),s.mixesList[0].regionList.push({id:l,name:h,tuning:d.tuning?d.tuning:s.settings.style.tuning,bpm:d.bpm?d.bpm:l===0?s.settings.style.bpm:-1,untilNext:d.untilNext?d.untilNext:s.settings.style.until,startLayerTick:-1,endLayerTick:-1,trueStartLayerTick:-1,trueEndLayerTick:-1,start:{},end:{},dualId:0,usedTotalTick:0,offsetTickWidth:0}),l++}if(!s.mixesList[0].regionList.length)return new mo(-1,-1,null,"At least one 'region' declaration is required.");s.regionLength=s.mixesList[0].regionList.length;for(let f=1;c.length>f;f++){let d=-1;const m=(h,p,g,y)=>{s.mixesList[f].regionList.push({id:h,name:p,tuning:g,bpm:-1,untilNext:y,startLayerTick:-1,endLayerTick:-1,trueStartLayerTick:-1,trueEndLayerTick:-1,start:void 0,end:void 0,dualId:f,usedTotalTick:0,offsetTickWidth:0})};for(const h of c[f])if(h.type===B.regionStart){const p={},g=En(p,h,1);if(g.fail())return g;const y=h.token==="@@"?"@@"+Math.random():h.token;if(u.includes(y)&&y!==F.dualJoiner)return new M(h.line,h.linePos,y,`-Block name '${y}' is already in use. The same block name cannot be declared at the same time.`);if(u.push(y),d+1!==h.regionRegionForDualConnection)for(let b=d+1;h.regionRegionForDualConnection>b;b++)m(b,`clone.${f}.${b}`,s.settings.style.tuning,void 0);m(h.regionRegionForDualConnection,`dual.${f}.${h.regionRegionForDualConnection}`,p.tuning?p.tuning:s.settings.style.tuning,p.untilNext?p.untilNext:s.settings.style.until),d=h.regionRegionForDualConnection}for(let h=d+1;l>h;h++)m(h,`clone.${f}.${h}`,s.settings.style.tuning,[0,0])}return j()}(t,i);if(n.fail())return n;const o=go.resolve(i);if(o.fail())return o;const r=bo.resolve(t,i);if(r.fail())return r;const a=To.resolve(t,i);return a.fail()?a:j()}}const Ci={tonalObj:{tonic:"C",scale:Se.normal,tonal:le.major,tonalShift:1,modalShift:1,name:"C major",diatonicEvolverValue:{evolvedCodePrefix:["","m","m","","","m","dim"],bin:[1,0,1,0,1,1,0,1,0,1,0,1]},sys:{shiftedKeyArray:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],note7array:["C","D","E","F","G","A","B"]}},styleScaleX:{key:xi.C,scale:Ke.major,bin:Ni[Ke.major].bin}},Io={ver:"1.0",strict:0,song:{key:null},style:{degree:structuredClone(Ci.tonalObj),scale:structuredClone(Ci.styleScaleX),tuning:["E","A","D","G","B","E"],until:[4,4],bpm:120},compile:{mappingResolved:1},downTuning:0,hash:{compose:"0000000000000000000000000000000000000000000000000000000000000000"},dual:{pan:1,panning:[.5,0,1]},click:{until:[1,4],inst:42,velocity:60,accent:0},play:{velocities:[70,70,70,70,75,82,82,75,65],possibleMSEC:{fullPicking:.02,trill:.015,sweep:.012},strum:{defaultStrumWidthMSec:30,velocity:55},approach:{widthOfSlide:{baseTick:100,maxSplitTick:24},velocity:{max:65,decrease:10,min:45,minLanding:66}},slide:{widthOfSlide:{maxSplitTick:48,distributionTick:25},velocity:{max:75,decrease:10,min:35,landing:65},realization:{realizationLandingPointOpenBows:1,autoStartPointAdjustmentThresholdSec:.02}},release:{widthOfSlide:{maxSplitTick:48,distributionTick:25},velocity:{max:55,decrease:8,min:0,landing:50}}}};class No{resolve(t){t.settings=structuredClone(Io);const i=function(n){const o=new Map;let r=1;return n.syntax=n.syntax.replace(/.*?\n/gs,a=>(a=a.replace(/(?:^set|\sset)\.([^\s^:]+)\s*:\s*([^\n]+)/g,(s,c,u)=>(o.set(c,{value:u.trim(),line:r}),"")),r++,a)),o}(t);for(const[n,o]of i){const r=n.split(".");let a=t.settings;for(let s=0;r.length-1>s;s++)if(a=a[r[s]],a===void 0)return new M(o.line,-1,null,`Invalid settings because path '${r.slice(0,s+1).join(".")}' is missing.`);{const s=r[r.length-1];if(!(s in a))return new M(o.line,-1,null,`Invalid setting because path '${s}' is missing.`);{if(!/\S/.test(o.value))return new M(o.line,-1,null,"Value must be specified.");const c=Vr(t,s,o.value,n,o.line);if(c.fail())return c;a[s]=c.res}}}return j()}}class Oo{static as(t){let i,n="",o=0,r=1,a=2,s=1,c=2,u=0,l=0,f=-1,d=0,m=0;const h=[[],[],[]],p=[],g=[];let y=0;const b=[],P=[],k=[],S=w=>{var N;const E=(N=h[d])!=null&&N.length?h[d][h[d].length-1].type:B.undefined;let U=0;if(w===void 0){const C=n[0];if([F.dualJoiner].includes(n)){if(u>0)return void(i=new M(s,c,n,`Invalid token '${n}' specified in the wrong place. '${n}' is set outside the region.`));if(0>f)return void(i=new M(s,c,n,`Invalid token '${n}'. Required start base region.`));if(d=m+1,d>2)return void(i=new M(s,c,n,`Invalid syntax '${n}'. Exceeding the number of dual blocks in a region.`));w=B.regionStart}else if(C===":"){const T=function(I,$,x,O){return[B.note,B.bullet,B.degreeName,B.closingCurlyBrace].includes($)?I.length===1?new M(x,O,I,"invalid token ':' specified in the wrong place."):j():new M(x,O,I,`invalid token '${I}' specified in the wrong place. Set the style specification after the note or in {}.`)}(n,E,s,c);T.fail()&&(i=T),n=n.replace(/^:+/,""),w=B.style}else if(u===0)if(n==="@@"){const T=function(I,$,x,O){return B.regionStart===$?new M(x,O,I,`invalid name '${I}' specified in the wrong place. Duplicate block declaration.`):j()}(n,E,s,c);T.fail()&&(i=T),d||f++,w=B.regionStart}else w=B.regionProp;else C==="@"?w=B.flash:/%/.test(n)?(w=B.degreeName,n=n.replace(/^([!./>']+)?%/,"$1"),U=1):new RegExp("(?<!\\w)\\d+\\/").test(n)?(w=B.bullet,U=1):(w=B.note,U=1)}if(w===B.comma)h[d][h[d].length-1].endOfMeasure=1;else if(w===B.regionProp||w===B.style){const C=function(O,G,V,oe,ne){return V===B.undefined?new M(oe,ne,O,G===B.blockStyle?`Invalid region prefix "${O}" specified in the wrong place. Duplicate block declaration. 
Default properties of block are set after block name specification.
e.g. @backing 1/4 140 { C Dm }`:`Invalid region prefix '${O}'. Only '@@' can be used as the region prefix.`):j()}(n,w,E,s,c);if(C.fail())return void(i=C);const T=u===0&&w===B.style?m:d;if(h[T][h[T].length-1].type!==B.regionStart&&w===B.regionProp)return void(i=new M(s,c,n,`Invalid syntax '${n}'. Style must start with ':'.`));const I=h[T][h[T].length-1],$=a-(/\)$/.test(n)?0:1),x=w===B.style?1:0;I.type===B.closingCurlyBrace&&(p[p.length-1].styles.push(n),p[p.length-1].linesOfStyle.push(s),p[p.length-1].linePosOfStyle.push(c+x),p[p.length-1].endLine=r,p[p.length-1].endPos=$),b.push({line:s,linePos:c+x,endLine:r,endPos:$,type:w===B.regionProp?B.regionProp:I.type===B.note||I.type===B.degreeName||I.type===B.bullet?B.style:B.blockStyle,regionId:f,dualId:T,sym:n,tabObjIndexes:[]}),I.typesStyle.push(w),I.styles.push(n),I.linesOfStyle.push(s),I.linePosOfStyle.push(c+x),I.endLine=r,I.endPos=$,I.locationInfoRefStackUpList&&I.locationInfoRefStackUpList.push(b.length-1)}else{if(u===0&&E!==B.regionStart&&E!==B.regionProp&&w===B.openingCurlyBrace)return void(i=new M(s,c,"{",`Invalid token '${n}'. Expected region declaration @@.
e.g. @@ { C D E }`));const C=a-(/\}$/.test(n)?0:1);let T;if([B.regionStart,B.note,B.bullet,B.degreeName,B.flash].includes(w))T={line:s,linePos:c,endLine:r,endPos:C,type:w,regionId:f,dualId:d,sym:n,tabObjIndexes:[]},b.push(T);else if(w===B.closingCurlyBrace){if(!g.length)return;const I=g[g.length-1];p.push({id:I.id,regionId:f,dualId:d,upperBlock:I.upperBlock,line:I.line,linePos:I.linePos,endLine:r,endPos:C,trueBraceEndLine:r,trueBraceEndPos:C,styles:[],linesOfStyle:[],linePosOfStyle:[]})}h[d].push({curlyLevel:u,type:w,typesStyle:[],line:s,linePos:c,linesOfStyle:[],linePosOfStyle:[],endLine:r,endPos:C,token:n,styles:[],decidedProp:U?{noteStr:void 0,list:void 0,tick:void 0,styles:void 0,fingering:void 0,beforeStop:void 0,chordDicRef:void 0}:void 0,regionRegionForDualConnection:f,locationInfoRefStackUpList:T?[b.length-1]:void 0})}c=a,s=r,w=void 0,n=""},v=t.syntax.length;for(;v>o;){const w=t.syntax[o].replace(/\r\n/g,`
`);switch(w){case"{":P.push({line:r,pos:a-1}),g.push({id:y,upperBlock:g.map(N=>N.id).reverse(),line:s,linePos:c}),y++,l===0?(/\S/.test(n)&&S(),n="{",S(B.openingCurlyBrace)):n+="{",u++;break;case"}":l===0?(/\S/.test(n)&&S(),n="}",S(B.closingCurlyBrace)):n+="}",g.pop(),u--,u===0?(m=d,d=0):0>u&&(i=new M(r,a-1,"}",`'X1 Unexpected EOF while parsing due to missing "{".'`)),P.pop();break;case"(":k.push({line:r,pos:a-1}),n+=w,l++;break;case")":n+=w,l--,l===0?S():0>l&&(i=new M(r,a-1,")",`'Unexpected EOF while parsing due to missing ")".'`)),k.pop();break;case":":l||(/[^\s:]/.test(n)?(S(),c--):c=a-1),n+=w;break;case`
`:l===0?(/\S/.test(n)&&S(),s++,c=1):n+=w,a=1,r++;break;case" ":case"	":l===0?/\S/.test(n)?S():c++:n+=w;break;case",":l===0?(/\S/.test(n)&&S(),n=",",S(B.comma)):n+=",";break;default:n+=w}if(i)return i;a++,o++}if(u){const w=P[P.length-1];return new M(w.line,w.pos,"{",'x2 Unexpected EOF while parsing due to missing "}".')}if(l){const w=k[k.length-1];return new M(w.line,w.pos,"(",'Unexpected EOF while parsing due to missing ")".')}return t.locationInfoList=b,p.sort((w,N)=>w.id-N.id),t.braceLocationInfoList=p,new R(h)}}class Ao{static resolve(t){const i=t.flash.click;let n;const o=t.mixesList[0].marks.fullNoteIndexWithTick;for(const r of i)if(r.start)if(n===void 0)n={untilRange:we(r.start.until),startTick:o[r.start.fullNoteIndex],endTick:-1};else{const a=o[r.start.fullNoteIndex]-1;Ft(t,{...n,endTick:a}),n={untilRange:we(r.start.until),startTick:o[r.start.fullNoteIndex],endTick:-1}}else if(n){const a=o[r.stop.noteIndex]-1;Ft(t,{...n,endTick:a}),n=void 0}if(n){const r=o[o.length-1]-1;Ft(t,{...n,endTick:r})}}}class $o{static resolve(t){var i,n,o,r,a,s,c,u;const{flatTOList:l}=t;let f,d=0,m=1,h=0;const p=l.length;for(let g=0;p>g;g++){const y=l[g],b=y.styles.stroke,P=y.styles.inst;let k=b==null?void 0:b.until;y.regionNoteIndex===0&&(d=t.regionList[y.regionIndex].tuning.length);const S=y.tab.filter(v=>v===0||v).length;if(S>1&&!(b!=null&&b.off)&&!y.styles.legato){let v=[];if(g!==0&&((o=(n=(i=y.prevTabObj)==null?void 0:i.styles)==null?void 0:n.slide)!=null&&o.continue)){const x=y.tab;v=(y.prevTabObj.activeBows||[]).map((O,G)=>{const V=x[G];return O!==void 0&&O>-1&&V!==void 0&&V>-1?G:void 0}).filter(O=>O!==void 0)}const w=y.bar.fretStartTicks.find(x=>x),N=w-h;if(y.isArpeggio||y.isBullet||!((r=y.styles)!=null&&r.approach))if(w!==F.startTick&&2.4>N/y.bpm){const x=36+Math.round(64-N/5);k=k||[1,16>x?16:x],m=m?0:1}else m=1,k=k||[1,48];else m=1,k=[1,98];m=P===L.brushing_u||P===L.brushing_U?0:1;const E=we(k),U=Math.round((E-v.length)/S),C=w-U*(S-1),T=[];let I=0;m=((s=(a=y.styles)==null?void 0:a.stroke)==null?void 0:s.up)==1?0:((u=(c=y.styles)==null?void 0:c.stroke)==null?void 0:u.up)==0?1:m;let $=0;g!==0&&($=f.activeBows.reduce((x,O,G)=>O!==y.tab[G]&&y.tab[G]!==void 0?x+1:x,0));for(let x=0;d>x;x++){const O=m?x:d-x-1;y.bar.fretStartTicks[O]!==void 0?(v.includes(O)||(y.bar.fretStartTicks[O]-=U*I,0>y.bar.fretStartTicks[O]&&(y.bar.fretStartTicks[O]=0)),I++,T.push(y.bar.fretStartTicks[O])):T.push(C)}if(h=w,g!==0)if(2>=$&&y.regionNoteIndex!==0||v.length)for(let x=0;f.refActiveBows.length>x;x++){const O=m?x:d-x-1;y.continueX&&y.tab[O]===void 0||Fn(l,g,T[x],O)}else for(let x=0;f.refActiveBows.length>x;x++)y.continueX&&y.tab[x]===void 0||Fn(l,g,C,x)}f=y}return j()}}class Li{static resolve(t){const{regionList:i,flatTOList:n}=t.mixesList[0],{bpmPosList:o}=t;o.push({tick:0,bpm:t.settings.style.bpm,timeMS:-1});const r=[];let a=-1,s={};const c=n.length;for(let l=0;c>l;l++){const f=n[l];f.regionNoteIndex===0&&(s=i[f.regionIndex],s.bpm!==-1&&(a=s.bpm,o.push({tick:s.startLayerTick,bpm:s.bpm,timeMS:-1})));const d=f.styles.bpm;if(d&&!r.includes(d.group))if(d.group===-1||d.style.type===1)Jr(o,d.style,f.bar.startTick,f.bar.stopTick),a=d.style.afterBPM||d.style.beforeBPM;else{r.push(d.group);const m=Kr(o,a,d.style,f.bar.startTick,d.groupEndTick);if(m.fail())return m;a=d.style.afterBPM||d.style.beforeBPM}}if(o.length===1)for(let l=0;t.mixesList.length>l;l++){const f=t.mixesList[l].flatTOList,d=f.length;for(let m=0;d>m;m++)f[m].bpm=o[0].bpm}else for(let l=0;t.mixesList.length>l;l++){const f=t.mixesList[l].flatTOList;let d=0;const m=f.length;for(let h=0;m>h;h++){const p=f[h],g=o.length;for(let y=d;g>y;y++){if(y===g-1){p.bpm=o[y].bpm;break}if(p.bar.startTick>=o[y].tick&&o[y+1].tick>p.bar.startTick){p.bpm=o[y].bpm,d=y;break}}}}let u=0;return t.mixesList.forEach(l=>{if(l.flatTOList.length){const f=l.flatTOList[l.flatTOList.length-1].bar.stopTick;f!==void 0&&f>u&&(u=f)}}),u>0&&o.push({tick:u,bpm:o[o.length-1].bpm,timeMS:-1}),j()}static mathBPMTime(t){const{bpmPosList:i}=t;let n=0,o=0;for(let r=0;i.length>r;r++){const a=i[r];r>0&&(n+=6e4/(480*i[r-1].bpm)*(a.tick-o)),i[r].timeMS=n,o=a.tick}return j()}}class Co{static resolve(t){const{flatTOList:i}=t,n=i.length;for(let o=0;n>o;o++){const r=i[o],a=r.styles.delay;if(a){const s=(r.bar.stopTick-r.bar.startTick)/a.startUntil[1]*a.startUntil[0];r.bar.fretStartTicks=r.bar.fretStartTicks.map(c=>c&&r.bar.startTick+s)}}return j()}}class Lo{static resolve(t,i){const{flatTOList:n,regionList:o}=i;let r={};for(let a=0;n.length>a;a++){const s=n[a];s.regionNoteIndex===0&&(r=o[s.regionIndex]);const c=s.styles.strum;c&&(a+=zr(t,i,r,s,a,c).res)}return j()}}class Bo{static resolve(t,i){const{flatTOList:n}=i;for(let o=0;n.length>o;o++){const r=n[o],a=r.styles.slide;if(a){const s=Hr(t,i.flatTOList,i.marks,r,o,a);if(s.fail())return s}}return j()}}class Eo{static resolve(t,i){const{flatTOList:n}=i;for(let o=0;n.length>o;o++){const r=n[o],a=r.styles.approach;if(a&&r.slideTrueType!==2){const s=Zr(t,i.flatTOList,i.marks,r,o,a);if(s.fail())return s}}return j()}}class Fo{static resolve(t){const{flatTOList:i}=t,n=i.length;for(let o=0;n>o;o++){const r=i[o];if(r.isRest&&r.styles.restNoise){const a=Array(r.tab.length).fill(void 0);r.tab=o===0?a.map(()=>0):structuredClone(i[o].prevTabObj.activeBows),r.tab.forEach((s,c)=>{s!==void 0&&(r.bar.fretStartTicks[c]=r.bar.startTick,r.bar.fretStopTicks[c]=r.bar.startTick+1)})}}return j()}}class Uo{static resolve(t){const{flatTOList:i}=t,n=i.length;for(let o=0;n>o;o++){const r=i[o],a=r.styles.staccato;if(a&&!r.styles.slide){const s=(r.bar.stopTick-r.bar.startTick)/a.cutUntil[1]*a.cutUntil[0];r.bar.fretStopTicks=r.bar.fretStopTicks.map(c=>c&&r.bar.startTick+s)}}return j()}}const jo=409.55;class Do{static resolve(t){const{flatTOList:i}=t;for(let n=0;i.length>n;n++){const o=i[n],r=o.styles.bd;if(r&&r.length){const a=o.tab.filter(c=>c!==void 0).length>0;if(!o.continueX&&!a)continue;const s=Xr(t.bendBank,o,r);if(s.fail())return s}}return j()}}class Ro{static resolve(t){const{flatTOList:i}=t;let n=0,o=-1,r=[];for(let a=0;i.length>a;a++){const s=i[a];if(s.styles.legato&&s.regionNoteIndex!==0)n||(r.push(s.prevTabObj),o=a-1,n=1),r.push(s);else{if(n){const c=Dn(t,r,o);if(c.fail())return c;r=[]}n=0}}if(n){const a=Dn(t,r,o);if(a.fail())return a}return j()}}class Wo{static compile(t){const i=Li.resolve(t);if(i.fail())return i;if(t.notStyleCompile)return j();const n=Li.mathBPMTime(t);if(n.fail())return n;Ao.resolve(t);for(let o=0;t.mixesList.length>o;o++){const r=t.mixesList[o],a=Ro.resolve(r);if(a.fail())return a;const s=Uo.resolve(r);if(s.fail())return s;const c=Co.resolve(r);if(c.fail())return c;const u=Lo.resolve(t,r);if(u.fail())return u;const l=$o.resolve(r);if(l.fail())return l;const f=Bo.resolve(t,r);if(f.fail())return f;const d=Eo.resolve(t,r);if(d.fail())return d;const m=Fo.resolve(r);if(m.fail())return m;const h=Do.resolve(r);if(h.fail())return h}return j()}}Ne=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},en={},ze={},Y.prototype.eof=function(){return this.pos>=this.bufferLen},Y.prototype.readUInt8=function(){var e=this.buffer[this.pos];return this.pos+=1,e},Y.prototype.readInt8=function(){var e=this.readUInt8();return 128&e?e-256:e},Y.prototype.readUInt16=function(){return(this.readUInt8()<<8)+this.readUInt8()},Y.prototype.readInt16=function(){var e=this.readUInt16();return 32768&e?e-65536:e},Y.prototype.readUInt24=function(){return(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},Y.prototype.readInt24=function(){var e=this.readUInt24();return 8388608&e?e-16777216:e},Y.prototype.readUInt32=function(){return(this.readUInt8()<<24)+(this.readUInt8()<<16)+(this.readUInt8()<<8)+this.readUInt8()},Y.prototype.readBytes=function(e){var t=this.buffer.slice(this.pos,this.pos+e);return this.pos+=e,t},Y.prototype.readString=function(e){var t=this.readBytes(e);return String.fromCharCode.apply(null,t)},Y.prototype.readVarInt=function(){for(var e,t=0;!this.eof();){if(!(128&(e=this.readUInt8())))return t+e;t+=127&e,t<<=7}return t},Y.prototype.readChunk=function(){var e=this.readString(4),t=this.readUInt32();return{id:e,length:t,data:this.readBytes(t)}},ui=function(e){var t,i,n,o,r,a=new Y(e),s=a.readChunk();if(s.id!="MThd")throw"Bad MIDI file.  Expected 'MHdr', got: '"+s.id+"'";for(t=function(c){var u=new Y(c),l={format:u.readUInt16(),numTracks:u.readUInt16()},f=u.readUInt16();return 32768&f?(l.framesPerSecond=256-(f>>8),l.ticksPerFrame=255&f):l.ticksPerBeat=f,l}(s.data),i=[],n=0;!a.eof()&&t.numTracks>n;n++){if((o=a.readChunk()).id!="MTrk")throw"Bad MIDI file.  Expected 'MTrk', got: '"+o.id+"'";r=to(o.data),i.push(r)}return{header:t,tracks:i}},Q.prototype.writeInt8=Q.prototype.writeUInt8=function(e){this.buffer.push(255&e)},Q.prototype.writeInt16=Q.prototype.writeUInt16=function(e){var t=255&e;this.writeUInt8(e>>8&255),this.writeUInt8(t)},Q.prototype.writeInt24=Q.prototype.writeUInt24=function(e){var t=e>>8&255,i=255&e;this.writeUInt8(e>>16&255),this.writeUInt8(t),this.writeUInt8(i)},Q.prototype.writeInt32=Q.prototype.writeUInt32=function(e){var t=e>>16&255,i=e>>8&255,n=255&e;this.writeUInt8(e>>24&255),this.writeUInt8(t),this.writeUInt8(i),this.writeUInt8(n)},Q.prototype.writeBytes=function(e){this.buffer=this.buffer.concat([].slice.call(e,0))},Q.prototype.writeString=function(e){var t,i=e.length,n=[];for(t=0;i>t;t++)n.push(e.codePointAt(t));this.writeBytes(n)},Q.prototype.writeVarInt=function(e){var t,i;if(0>e)throw"Cannot write negative variable-length integer";if(e>127){for((i=[]).push(127&(t=e)),t>>=7;t;)i.push(127&t|128),t>>=7;this.writeBytes(i.reverse())}else this.writeUInt8(e)},Q.prototype.writeChunk=function(e,t){this.writeString(e),this.writeUInt32(t.length),this.writeBytes(t)},di=function(e,t){var i,n,o,r,a;if(typeof e!="object")throw"Invalid MIDI data";for(t=t||{},i=e.header||{},r=(n=e.tracks||[]).length,function(s,c,u){var l,f=c.format==null?1:c.format,d=128;c.timeDivision?d=c.timeDivision:c.ticksPerFrame&&c.framesPerSecond?d=-(255&c.framesPerSecond)<<8|255&c.ticksPerFrame:c.ticksPerBeat&&(d=32767&c.ticksPerBeat),(l=new Q).writeUInt16(f),l.writeUInt16(u),l.writeUInt16(d),s.writeChunk("MThd",l.buffer)}(a=new Q,i,r),o=0;r>o;o++)no(a,n[o],t);return a.buffer},ze.parseMidi=ui,ze.writeMidi=di,He={},Object.defineProperty(Oe={},"i",{value:1}),Oe.insert=Oe.search=void 0,Oe.search=Wn,Oe.insert=function(e,t,i){if(i===void 0&&(i="ticks"),e.length){var n=Wn(e,t[i],i);e.splice(n+1,0,t)}else e.push(t)},function(e){var t,i,n;Object.defineProperty(e,"i",{value:1}),e.Header=e.keySignatureKeys=void 0,t=Oe,i=new WeakMap,e.keySignatureKeys=["Cb","Gb","Db","Ab","Eb","Bb","F","C","G","D","A","E","B","F#","C#"],n=function(){function o(r){var a,s=this;this.tempos=[],this.timeSignatures=[],this.keySignatures=[],this.meta=[],this.name="",i.set(this,480),r&&(i.set(this,r.header.ticksPerBeat),r.tracks.forEach(function(c){c.forEach(function(u){u.meta&&(u.type==="timeSignature"?s.timeSignatures.push({ticks:u.absoluteTime,timeSignature:[u.numerator,u.denominator]}):u.type==="setTempo"?s.tempos.push({bpm:6e7/u.microsecondsPerBeat,ticks:u.absoluteTime}):u.type==="keySignature"&&s.keySignatures.push({key:e.keySignatureKeys[u.key+7],scale:u.scale===0?"major":"minor",ticks:u.absoluteTime}))})}),a=0,r.tracks[0].forEach(function(c){a+=c.deltaTime,c.meta&&(c.type==="trackName"?s.name=c.text:c.type!=="text"&&c.type!=="cuePoint"&&c.type!=="marker"&&c.type!=="lyrics"||s.meta.push({text:c.text,ticks:a,type:c.type}))}),this.update())}return o.prototype.update=function(){var r=this,a=0,s=0;this.tempos.sort(function(c,u){return c.ticks-u.ticks}),this.tempos.forEach(function(c,u){var l=c.ticks/r.ppq-s;c.time=60/(u>0?r.tempos[u-1].bpm:r.tempos[0].bpm)*l+a,a=c.time,s+=l}),this.timeSignatures.sort(function(c,u){return c.ticks-u.ticks}),this.timeSignatures.forEach(function(c,u){var l=u>0?r.timeSignatures[u-1]:r.timeSignatures[0],f=(c.ticks-l.ticks)/r.ppq/l.timeSignature[0]/(l.timeSignature[1]/4);l.measures=l.measures||0,c.measures=f+l.measures})},o.prototype.ticksToSeconds=function(r){var a,s=(0,t.search)(this.tempos,r);return s!==-1?(a=this.tempos[s]).time+60/a.bpm*((r-a.ticks)/this.ppq):r/this.ppq*.5},o.prototype.ticksToMeasures=function(r){var a,s=(0,t.search)(this.timeSignatures,r);return s!==-1?(a=this.timeSignatures[s]).measures+(r-a.ticks)/this.ppq/(a.timeSignature[0]/a.timeSignature[1])/4:r/this.ppq/4},Object.defineProperty(o.prototype,"ppq",{get:function(){return i.get(this)},enumerable:0,configurable:1}),o.prototype.secondsToTicks=function(r){var a,s=(0,t.search)(this.tempos,r,"time");return Math.round(s!==-1?(a=this.tempos[s]).ticks+(r-a.time)/(60/a.bpm)*this.ppq:r/.5*this.ppq)},o.prototype.toJSON=function(){return{keySignatures:this.keySignatures,meta:this.meta,name:this.name,ppq:this.ppq,tempos:this.tempos.map(function(r){return{bpm:r.bpm,ticks:r.ticks}}),timeSignatures:this.timeSignatures}},o.prototype.fromJSON=function(r){this.name=r.name,this.tempos=r.tempos.map(function(a){return Object.assign({},a)}),this.timeSignatures=r.timeSignatures.map(function(a){return Object.assign({},a)}),this.keySignatures=r.keySignatures.map(function(a){return Object.assign({},a)}),this.meta=r.meta.map(function(a){return Object.assign({},a)}),i.set(this,r.ppq),this.update()},o.prototype.setTempo=function(r){this.tempos=[{bpm:r,ticks:0}],this.update()},o}(),e.Header=n}(He),Fe={},function(e){var t,i,n;Object.defineProperty(e,"i",{value:1}),e.ControlChange=e.controlChangeIds=e.controlChangeNames=void 0,e.controlChangeNames={1:"modulationWheel",2:"breath",4:"footController",5:"portamentoTime",7:"volume",8:"balance",10:"pan",64:"sustain",65:"portamentoTime",66:"sostenuto",67:"softPedal",68:"legatoFootswitch",84:"portamentoControl"},e.controlChangeIds=Object.keys(e.controlChangeNames).reduce(function(o,r){return o[e.controlChangeNames[r]]=r,o},{}),t=new WeakMap,i=new WeakMap,n=function(){function o(r,a){t.set(this,a),i.set(this,r.controllerType),this.ticks=r.absoluteTime,this.value=r.value}return Object.defineProperty(o.prototype,"number",{get:function(){return i.get(this)},enumerable:0,configurable:1}),Object.defineProperty(o.prototype,"name",{get:function(){return e.controlChangeNames[this.number]?e.controlChangeNames[this.number]:null},enumerable:0,configurable:1}),Object.defineProperty(o.prototype,"time",{get:function(){return t.get(this).ticksToSeconds(this.ticks)},set:function(r){var a=t.get(this);this.ticks=a.secondsToTicks(r)},enumerable:0,configurable:1}),o.prototype.toJSON=function(){return{number:this.number,ticks:this.ticks,time:this.time,value:this.value}},o}(),e.ControlChange=n}(tn={}),Object.defineProperty(Pt={},"i",{value:1}),Pt.createControlChanges=void 0,Ze=tn,Pt.createControlChanges=function(){return new Proxy({},{get:function(e,t){return e[t]?e[t]:Ze.controlChangeIds.hasOwnProperty(t)?e[Ze.controlChangeIds[t]]:void 0},set:function(e,t,i){return Ze.controlChangeIds.hasOwnProperty(t)?e[Ze.controlChangeIds[t]]=i:e[t]=i,1}})},Object.defineProperty(wt={},"i",{value:1}),wt.PitchBend=void 0,Mt=new WeakMap,fi=function(){function e(t,i){Mt.set(this,i),this.ticks=t.absoluteTime,this.value=t.value}return Object.defineProperty(e.prototype,"time",{get:function(){return Mt.get(this).ticksToSeconds(this.ticks)},set:function(t){var i=Mt.get(this);this.ticks=i.secondsToTicks(t)},enumerable:0,configurable:1}),e.prototype.toJSON=function(){return{ticks:this.ticks,time:this.time,value:this.value}},e}(),wt.PitchBend=fi,Xe={},Object.defineProperty(Te={},"i",{value:1}),Te.DrumKitByPatchID=Te.InstrumentFamilyByID=Te.instrumentByPatchID=void 0,Te.instrumentByPatchID=["acoustic grand piano","bright acoustic piano","electric grand piano","honky-tonk piano","electric piano 1","electric piano 2","harpsichord","clavi","celesta","glockenspiel","music box","vibraphone","marimba","xylophone","tubular bells","dulcimer","drawbar organ","percussive organ","rock organ","church organ","reed organ","accordion","harmonica","tango accordion","acoustic guitar (nylon)","acoustic guitar (steel)","electric guitar (jazz)","electric guitar (clean)","electric guitar (muted)","overdriven guitar","distortion guitar","guitar harmonics","acoustic bass","electric bass (finger)","electric bass (pick)","fretless bass","slap bass 1","slap bass 2","synth bass 1","synth bass 2","violin","viola","cello","contrabass","tremolo strings","pizzicato strings","orchestral harp","timpani","string ensemble 1","string ensemble 2","synthstrings 1","synthstrings 2","choir aahs","voice oohs","synth voice","orchestra hit","trumpet","trombone","tuba","muted trumpet","french horn","brass section","synthbrass 1","synthbrass 2","soprano sax","alto sax","tenor sax","baritone sax","oboe","english horn","bassoon","clarinet","piccolo","flute","recorder","pan flute","blown bottle","shakuhachi","whistle","ocarina","lead 1 (square)","lead 2 (sawtooth)","lead 3 (calliope)","lead 4 (chiff)","lead 5 (charang)","lead 6 (voice)","lead 7 (fifths)","lead 8 (bass + lead)","pad 1 (new age)","pad 2 (warm)","pad 3 (polysynth)","pad 4 (choir)","pad 5 (bowed)","pad 6 (metallic)","pad 7 (halo)","pad 8 (sweep)","fx 1 (rain)","fx 2 (soundtrack)","fx 3 (crystal)","fx 4 (atmosphere)","fx 5 (brightness)","fx 6 (goblins)","fx 7 (echoes)","fx 8 (sci-fi)","sitar","banjo","shamisen","koto","kalimba","bag pipe","fiddle","shanai","tinkle bell","agogo","steel drums","woodblock","taiko drum","melodic tom","synth drum","reverse cymbal","guitar fret noise","breath noise","seashore","bird tweet","telephone ring","helicopter","applause","gunshot"],Te.InstrumentFamilyByID=["piano","chromatic percussion","organ","guitar","bass","strings","ensemble","brass","reed","pipe","synth lead","synth pad","synth effects","world","percussive","sound effects"],Te.DrumKitByPatchID={0:"standard kit",8:"room kit",16:"power kit",24:"electronic kit",25:"tr-808 kit",32:"jazz kit",40:"brush kit",48:"orchestra kit",56:"sound fx kit"},Object.defineProperty(Xe,"i",{value:1}),Xe.Instrument=void 0,Ye=Te,nn=new WeakMap,mi=function(){function e(t,i){if(this.number=0,nn.set(this,i),this.number=0,t){var n=t.find(function(o){return o.type==="programChange"});n&&(this.number=n.programNumber)}}return Object.defineProperty(e.prototype,"name",{get:function(){return this.percussion?Ye.DrumKitByPatchID[this.number]:Ye.instrumentByPatchID[this.number]},set:function(t){var i=Ye.instrumentByPatchID.indexOf(t);i!==-1&&(this.number=i)},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"family",{get:function(){return this.percussion?"drums":Ye.InstrumentFamilyByID[Math.floor(this.number/8)]},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"percussion",{get:function(){return nn.get(this).channel===9},enumerable:0,configurable:1}),e.prototype.toJSON=function(){return{family:this.family,number:this.number,name:this.name}},e.prototype.fromJSON=function(t){this.number=t.number},e}(),Xe.Instrument=mi,Object.defineProperty(St={},"i",{value:1}),St.Note=void 0,Si=/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i,Ti={cbb:-2,cb:-1,c:0,"c#":1,cx:2,dbb:0,db:1,d:2,"d#":3,dx:4,ebb:2,eb:3,e:4,"e#":5,ex:6,fbb:3,fb:4,f:5,"f#":6,fx:7,gbb:5,gb:6,g:7,"g#":8,gx:9,abb:7,ab:8,a:9,"a#":10,ax:11,bbb:9,bb:10,b:11,"b#":12,bx:13},pi=function(e){var t=Si.exec(e),i=t[2];return Ti[t[1].toLowerCase()]+12*(parseInt(i,10)+1)},Ae=new WeakMap,hi=function(){function e(t,i,n){Ae.set(this,n),this.midi=t.midi,this.velocity=t.velocity,this.noteOffVelocity=i.velocity,this.ticks=t.ticks,this.durationTicks=i.ticks-t.ticks}return Object.defineProperty(e.prototype,"name",{get:function(){return i=Math.floor((t=this.midi)/12)-1,_n(t)+""+i;var t,i},set:function(t){this.midi=pi(t)},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"octave",{get:function(){return Math.floor(this.midi/12)-1},set:function(t){this.midi+=12*(t-this.octave)},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"pitch",{get:function(){return _n(this.midi)},set:function(t){this.midi=12*(this.octave+1)+function(i){return["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"].indexOf(i)}(t)},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"duration",{get:function(){var t=Ae.get(this);return t.ticksToSeconds(this.ticks+this.durationTicks)-t.ticksToSeconds(this.ticks)},set:function(t){var i=Ae.get(this).secondsToTicks(this.time+t);this.durationTicks=i-this.ticks},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"time",{get:function(){return Ae.get(this).ticksToSeconds(this.ticks)},set:function(t){var i=Ae.get(this);this.ticks=i.secondsToTicks(t)},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"bars",{get:function(){return Ae.get(this).ticksToMeasures(this.ticks)},enumerable:0,configurable:1}),e.prototype.toJSON=function(){return{duration:this.duration,durationTicks:this.durationTicks,midi:this.midi,name:this.name,ticks:this.ticks,time:this.time,velocity:this.velocity}},e}(),St.Note=hi,Object.defineProperty(Fe,"i",{value:1}),Fe.Track=void 0,Tt=Oe,gi=tn,yi=Pt,bi=wt,rn=Xe,ki=St,Qe=new WeakMap,vi=function(){function e(t,i){var n,o,r,a,s,c,u=this;if(this.name="",this.notes=[],this.controlChanges=(0,yi.createControlChanges)(),this.pitchBends=[],Qe.set(this,i),t&&(n=t.find(function(l){return l.type==="trackName"}),this.name=n?n.text:""),this.instrument=new rn.Instrument(t,this),this.channel=0,t){for(o=t.filter(function(l){return l.type==="noteOn"}),r=t.filter(function(l){return l.type==="noteOff"}),a=function(){var l,f,d=o.shift();s.channel=d.channel,l=r.findIndex(function(m){return m.noteNumber===d.noteNumber&&m.absoluteTime>=d.absoluteTime}),l!==-1&&(f=r.splice(l,1)[0],s.addNote({durationTicks:f.absoluteTime-d.absoluteTime,midi:d.noteNumber,noteOffVelocity:f.velocity/127,ticks:d.absoluteTime,velocity:d.velocity/127}))},s=this;o.length;)a();t.filter(function(l){return l.type==="controller"}).forEach(function(l){u.addCC({number:l.controllerType,ticks:l.absoluteTime,value:l.value/127})}),t.filter(function(l){return l.type==="pitchBend"}).forEach(function(l){u.addPitchBend({ticks:l.absoluteTime,value:l.value/8192})}),c=t.find(function(l){return l.type==="endOfTrack"}),this.endOfTrackTicks=c!==void 0?c.absoluteTime:void 0}}return e.prototype.addNote=function(t){var i=Qe.get(this),n=new ki.Note({midi:0,ticks:0,velocity:1},{ticks:0,velocity:0},i);return Object.assign(n,t),(0,Tt.insert)(this.notes,n,"ticks"),this},e.prototype.addCC=function(t){var i=Qe.get(this),n=new gi.ControlChange({controllerType:t.number},i);return delete t.number,Object.assign(n,t),Array.isArray(this.controlChanges[n.number])||(this.controlChanges[n.number]=[]),(0,Tt.insert)(this.controlChanges[n.number],n,"ticks"),this},e.prototype.addPitchBend=function(t){var i=Qe.get(this),n=new bi.PitchBend({},i);return Object.assign(n,t),(0,Tt.insert)(this.pitchBends,n,"ticks"),this},Object.defineProperty(e.prototype,"duration",{get:function(){var t,i,n;if(!this.notes.length)return 0;for(t=this.notes[this.notes.length-1].time+this.notes[this.notes.length-1].duration,i=0;this.notes.length-1>i;i++)(n=this.notes[i].time+this.notes[i].duration)>t&&(t=n);return t},enumerable:0,configurable:1}),Object.defineProperty(e.prototype,"durationTicks",{get:function(){var t,i,n;if(!this.notes.length)return 0;for(t=this.notes[this.notes.length-1].ticks+this.notes[this.notes.length-1].durationTicks,i=0;this.notes.length-1>i;i++)(n=this.notes[i].ticks+this.notes[i].durationTicks)>t&&(t=n);return t},enumerable:0,configurable:1}),e.prototype.fromJSON=function(t){var i,n=this;for(i in this.name=t.name,this.channel=t.channel,this.instrument=new rn.Instrument(void 0,this),this.instrument.fromJSON(t.instrument),t.endOfTrackTicks!==void 0&&(this.endOfTrackTicks=t.endOfTrackTicks),t.controlChanges)t.controlChanges[i]&&t.controlChanges[i].forEach(function(o){n.addCC({number:o.number,ticks:o.ticks,value:o.value})});t.notes.forEach(function(o){n.addNote({durationTicks:o.durationTicks,midi:o.midi,ticks:o.ticks,velocity:o.velocity})})},e.prototype.toJSON=function(){var t,i,n={};for(t=0;127>t;t++)this.controlChanges.hasOwnProperty(t)&&(n[t]=this.controlChanges[t].map(function(o){return o.toJSON()}));return i={channel:this.channel,controlChanges:n,pitchBends:this.pitchBends.map(function(o){return o.toJSON()}),instrument:this.instrument.toJSON(),name:this.name,notes:this.notes.map(function(o){return o.toJSON()})},this.endOfTrackTicks!==void 0&&(i.endOfTrackTicks=this.endOfTrackTicks),i},e}(),Fe.Track=vi,et={};const _o=eo(Object.freeze(Object.defineProperty({__proto__:null,flatten:function(e){var t=[];return Gn(e,t),t}},Symbol.toStringTag,{value:"Module"})));ge=Ne&&Ne.o||function(e,t,i){if(i||arguments.length===2)for(var n,o=0,r=t.length;r>o;o++)!n&&o in t||(n||(n=[].slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||[].slice.call(t))},Object.defineProperty(et,"i",{value:1}),et.encode=void 0,Pi=ze,wi=He,Mi=_o,et.encode=function(e){var t={header:{format:1,numTracks:e.tracks.length+1,ticksPerBeat:e.header.ppq},tracks:ge([ge(ge(ge(ge([{absoluteTime:0,deltaTime:0,meta:1,text:e.header.name,type:"trackName"}],e.header.keySignatures.map(function(i){return function(n){var o=wi.keySignatureKeys.indexOf(n.key);return{absoluteTime:n.ticks,deltaTime:0,key:o+7,meta:1,scale:n.scale==="major"?0:1,type:"keySignature"}}(i)}),1),e.header.meta.map(function(i){return{absoluteTime:(n=i).ticks,deltaTime:0,meta:1,text:n.text,type:n.type};var n}),1),e.header.tempos.map(function(i){return function(n){return{absoluteTime:n.ticks,deltaTime:0,meta:1,microsecondsPerBeat:Math.floor(6e7/n.bpm),type:"setTempo"}}(i)}),1),e.header.timeSignatures.map(function(i){return function(n){return{absoluteTime:n.ticks,deltaTime:0,denominator:n.timeSignature[1],meta:1,metronome:24,numerator:n.timeSignature[0],thirtyseconds:8,type:"timeSignature"}}(i)}),1)],e.tracks.map(function(i){return ge(ge(ge([(n=i.name,{absoluteTime:0,deltaTime:0,meta:1,text:n,type:"trackName"}),oo(i)],function(o){return(0,Mi.flatten)(o.notes.map(function(r){return function(a,s){return[{absoluteTime:a.ticks,channel:s,deltaTime:0,noteNumber:a.midi,type:"noteOn",velocity:Math.floor(127*a.velocity)},{absoluteTime:a.ticks+a.durationTicks,channel:s,deltaTime:0,noteNumber:a.midi,type:"noteOff",velocity:Math.floor(127*a.noteOffVelocity)}]}(r,o.channel)}))}(i),1),function(o){var r,a=[];for(r=0;127>r;r++)o.controlChanges.hasOwnProperty(r)&&o.controlChanges[r].forEach(function(s){a.push(ro(s,o.channel))});return a}(i),1),function(o){var r=[];return o.pitchBends.forEach(function(a){r.push(function(s,c){return{absoluteTime:s.ticks,channel:c,deltaTime:0,type:"pitchBend",value:s.value}}(a,o.channel))}),r}(i),1);var n}),1)};return t.tracks=t.tracks.map(function(i){i=i.sort(function(o,r){return o.absoluteTime-r.absoluteTime});var n=0;return i.forEach(function(o){o.deltaTime=o.absoluteTime-n,n=o.absoluteTime,delete o.absoluteTime}),i.push({deltaTime:0,meta:1,type:"endOfTrack"}),i}),new Uint8Array((0,Pi.writeMidi)(t))},function(e){var t,i,n,o,r,a,s,c=Ne&&Ne.l||function(l,f,d,m){return new(d||(d=Promise))(function(h,p){function g(P){try{b(m.next(P))}catch(k){p(k)}}function y(P){try{b(m.throw(P))}catch(k){p(k)}}function b(P){var k;P.done?h(P.value):(k=P.value,k instanceof d?k:new d(function(S){S(k)})).then(g,y)}b((m=m.apply(l,f||[])).next())})},u=Ne&&Ne.h||function(l,f){function d(b){return function(P){return function(k){if(m)throw new TypeError("Generator is already executing.");for(;y;)try{if(m=1,h&&(p=2&k[0]?h.return:k[0]?h.throw||((p=h.return)&&p.call(h),0):h.next)&&!(p=p.call(h,k[1])).done)return p;switch(h=0,p&&(k=[2&k[0],p.value]),k[0]){case 0:case 1:p=k;break;case 4:return y.label++,{value:k[1],done:0};case 5:y.label++,h=k[1],k=[0];continue;case 7:k=y.ops.pop(),y.trys.pop();continue;default:if(!((p=(p=y.trys).length>0&&p[p.length-1])||k[0]!==6&&k[0]!==2)){y=0;continue}if(k[0]===3&&(!p||k[1]>p[0]&&p[3]>k[1])){y.label=k[1];break}if(k[0]===6&&p[1]>y.label){y.label=p[1],p=k;break}if(p&&p[2]>y.label){y.label=p[2],y.ops.push(k);break}p[2]&&y.ops.pop(),y.trys.pop();continue}k=f.call(l,y)}catch(S){k=[6,S],h=0}finally{m=p=0}if(5&k[0])throw k[1];return{value:k[0]?k[1]:void 0,done:1}}([b,P])}}var m,h,p,g,y={label:0,sent:function(){if(1&p[0])throw p[1];return p[1]},trys:[],ops:[]};return g={next:d(0),throw:d(1),return:d(2)},typeof Symbol=="function"&&(g[Symbol.iterator]=function(){return this}),g};Object.defineProperty(e,"i",{value:1}),e.Header=e.Track=e.Midi=void 0,t=ze,i=He,n=Fe,o=et,r=function(){function l(f){var d,m=this,h=null;f&&(d=f instanceof ArrayBuffer?new Uint8Array(f):f,(h=(0,t.parseMidi)(d)).tracks.forEach(function(p){var g=0;p.forEach(function(y){y.absoluteTime=g+=y.deltaTime})}),h.tracks=function(p){var g,y,b,P,k,S,v,w,N,E,U=[];for(g=0;p.length>g;g++)for(y=U.length,b=new Map,P=Array(16).fill(0),k=0,S=p[g];S.length>k;k++)w=y,(N=(v=S[k]).channel)!==void 0&&(v.type==="programChange"&&(P[N]=v.programNumber),E="".concat(P[N]," ").concat(N),b.has(E)?w=b.get(E):b.set(E,w=y+b.size)),U[w]||U.push([]),U[w].push(v);return U}(h.tracks)),this.header=new i.Header(h),this.tracks=[],f&&(this.tracks=h.tracks.map(function(p){return new n.Track(p,m.header)}),h.header.format===1&&this.tracks[0].duration===0&&this.tracks.shift())}return l.fromUrl=function(f){return c(this,void 0,void 0,function(){var d;return u(this,function(m){switch(m.label){case 0:return[4,fetch(f)];case 1:return(d=m.sent()).ok?[4,d.arrayBuffer()]:[3,3];case 2:return[2,new l(m.sent())];case 3:throw Error("Could not load '".concat(f,"'"))}})})},Object.defineProperty(l.prototype,"name",{get:function(){return this.header.name},set:function(f){this.header.name=f},enumerable:0,configurable:1}),Object.defineProperty(l.prototype,"duration",{get:function(){var f=this.tracks.map(function(d){return d.duration});return Math.max.apply(Math,f)},enumerable:0,configurable:1}),Object.defineProperty(l.prototype,"durationTicks",{get:function(){var f=this.tracks.map(function(d){return d.durationTicks});return Math.max.apply(Math,f)},enumerable:0,configurable:1}),l.prototype.addTrack=function(){var f=new n.Track(void 0,this.header);return this.tracks.push(f),f},l.prototype.toArray=function(){return(0,o.encode)(this)},l.prototype.toJSON=function(){return{header:this.header.toJSON(),tracks:this.tracks.map(function(f){return f.toJSON()})}},l.prototype.fromJSON=function(f){var d=this;this.header=new i.Header,this.header.fromJSON(f.header),this.tracks=f.tracks.map(function(m){var h=new n.Track(void 0,d.header);return h.fromJSON(m),h})},l.prototype.clone=function(){var f=new l;return f.fromJSON(this.toJSON()),f},l}(),e.Midi=r,a=Fe,Object.defineProperty(e,"Track",{enumerable:1,get:function(){return a.Track}}),s=He,Object.defineProperty(e,"Header",{enumerable:1,get:function(){return s.Header}})}(en);class Go{static create(t,i,n){const{regionList:o,flatTOList:r,bend:a}=n,s=function(d,m,h){const p=(g,y,b)=>{const P=m.addTrack();return P.instrument={number:g},P.channel=y>7?y+2:y,P.addCC({number:10,value:b,ticks:0}),P};return[p(h.soundfontProp.normal,d++,h.pan),p(h.soundfontProp.mute,d++,h.pan),p(h.soundfontProp.normal,d++,h.pan),p(h.soundfontProp.mute,d,h.pan)]}(t,i,n),c=s.map(()=>[]);let u=[];const l=r.length;let f=-1;for(let d=0;l>d;d++){const m=r[d];m.regionIndex!==f&&(u=ct(o[m.regionIndex].tuning),f=m.regionIndex);for(let h=0;o[m.regionIndex].tuning.length>h;h++){const p=m.tab[h];if(p===void 0||p===-1)continue;const g=m.bar.fretStartTicks[h],y=m.bar.fretStopTicks[h],b=y-g,P=m.velocity[h]/100,k=m.styles.inst||L.normal,S=m.styles.bd!==void 0;if(isNaN(g)||isNaN(y))throw"tick is Nan - startTick: "+g+", stopTick: "+y+", fret: "+JSON.stringify(m.tab[h])+", noteStr: "+m.noteStr+", bar: "+JSON.stringify(m.bar);if(1>b)continue;const v=so(k,S),w=v.vel===0?P:0>v.vel?P+v.vel:v.vel,N={midi:u[h]+p+(m!=null&&m.tabShift?m.tabShift:0),velocity:w,ticks:g,durationTicks:v.duration||b};s[v.midiInst].addNote(N),c[v.midiInst].push({...N,stopTick:y})}}a.bendNormalList.forEach(d=>d.bend.forEach(m=>{s[0].addPitchBend({ticks:m.tick,value:m.pitch}),d.hasMute&&s[1].addPitchBend({ticks:m.tick,value:m.pitch})})),a.bendChannelList.forEach(d=>d.bend.forEach(m=>{s[2].addPitchBend({ticks:m.tick,value:m.pitch}),d.hasMute&&s[3].addPitchBend({ticks:m.tick,value:m.pitch})}))}}class qo{static build(t,i,n){const o=new en.Midi;n.length&&function(a,s){const c=s.addTrack();c.channel=9,c.instrument={number:115},a.forEach(u=>{c.addNote({durationTicks:2,midi:u.inst,velocity:u.velocity,ticks:u.startTick})})}(n,o);for(let a=0;t.length>a;a++)Go.create(4*a,o,t[a]);i.forEach(a=>{o.header.tempos.push({bpm:a.bpm,ticks:a.tick})});const r=[];for(let a=0;o.tracks.length>a;a++){const s=o.tracks[a];s.notes.length&&r.push(s)}return o.tracks=r,new R(o)}}class Vo{static convert(t,i,n,o,r){const a={syntax:t+`
`,settings:{},regionLength:0,bpmPosList:[],clickPointList:[],flash:{click:[],offset:{},other:[]},dic:{chord:n,mapSeed:o},mixesList:[0,1,2].map(s=>({dualId:s,regionList:[],flatTOList:[],bendBank:{bendChannelList:[],bendNormalList:[]},marks:{styleMappedGroupList:[],fullNoteIndexWithTick:[],bendGroupNumberList:[],usedBendRange:[]},view:{bend:[]}})),warnings:[],extensionInfo:{stepInfoList:[]},locationInfoList:[],braceLocationInfoList:[],styleObjectBank:{},allowAnnotations:i};return r&&(a.notStyleCompile=1),function(s){(function(d){d.syntax=d.syntax.replace(/\/\/.*$/gm,"").replace(/\/\*([\s\S]*?)\*\//gm,m=>m.replace(/[^\n]/g," ")).replace(/__end__.*$/gs,"")})(s);const c=new No().resolve(s);if(c.fail())return c;(function(d){d.syntax=d.syntax.replace(/^([\s\S]*?)__start__/gs,m=>m.replace(/[^\n]/g," "))})(s);const u=Oo.as(s);if(u.fail())return u;const l=xo.compile(s,u.res);if(l.fail())return l;const f=Wo.compile(s);return f.fail()?f:new R(s)}(a)}static convertToObj(t,i,n,o,r,a){const s=new Date().getTime(),c=this.convert(n,o,r,a,!t);if(c.fail()){const l={id:t?1:0,error:{message:c.message,line:c.line,linePos:c.linePos,token:c.token},response:null};return t&&(l.midiRequest=1),l}if(c.res.dic=null,c.res.mixesList.forEach(l=>{l.flatTOList.forEach(f=>{f.prevTabObj=void 0,f.nextTabObj=void 0,f.refActiveBows=void 0,f.refMovedSlideTarget=void 0})}),t){const l=i?(u=c.res,qo.build([0,1,2].map(f=>({regionList:u.mixesList[f].regionList,flatTOList:u.mixesList[f].flatTOList,pan:u.settings.dual.panning[f]>=0&&u.settings.dual.pan?u.settings.dual.panning[f]:.5,soundfontProp:{normal:24,mute:28},bend:u.mixesList[f].bendBank})),u.bpmPosList,u.clickPointList)):null;return l&&l.fail()?{id:1,error:l,response:null,midiRequest:1}:{id:1,error:null,response:c.res,midi:l?l.res.toArray().buffer:null,midiRequest:1,compileMsec:new Date().getTime()-s}}return c.res.syntax="",{id:0,error:null,response:c.res,compileMsec:new Date().getTime()-s};var u}}const Ko=new Map,Jo={};self.addEventListener("message",e=>{const t=e.data.id,i=e.data.hasStyleCompile,n=e.data.hasMidiCompile,o=e.data.syntax;zo(i,n,o).then(r=>{r.id=t,self.postMessage(r)})});async function zo(e,t,i){return Vo.convertToObj(e,t,i,[{name:"compose",dualIdRestrictions:[0]},{name:"/compose",dualIdRestrictions:[0]}],Ko,Jo)}})();
